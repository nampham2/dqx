{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://dqx.dev/schemas/suite.json",
  "title": "DQX Suite Configuration",
  "description": "Schema for DQX verification suite YAML/JSON configuration files",
  "type": "object",
  "required": ["name", "checks"],
  "properties": {
    "name": {
      "type": "string",
      "minLength": 1,
      "description": "Human-readable name identifying the suite"
    },
    "data_av_threshold": {
      "type": "number",
      "minimum": 0,
      "maximum": 1,
      "default": 0.9,
      "description": "Minimum data availability ratio (0.0-1.0). Assertions skip when data falls below this threshold."
    },
    "checks": {
      "type": "array",
      "minItems": 1,
      "description": "List of check definitions",
      "items": {
        "$ref": "#/$defs/check"
      }
    },
    "profiles": {
      "type": "array",
      "description": "Suite-level profiles that modify assertion behavior during specific periods",
      "items": {
        "$ref": "#/$defs/profile"
      }
    }
  },
  "$defs": {
    "check": {
      "type": "object",
      "required": ["name", "assertions"],
      "description": "A check groups related assertions",
      "properties": {
        "name": {
          "type": "string",
          "minLength": 1,
          "description": "Unique check name within the suite"
        },
        "datasets": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1,
            "pattern": "^[a-zA-Z_][a-zA-Z0-9_]*$"
          },
          "description": "Datasets this check applies to. Omit to apply to all datasets."
        },
        "assertions": {
          "type": "array",
          "minItems": 1,
          "items": {
            "$ref": "#/$defs/assertion"
          },
          "description": "List of assertions within this check"
        }
      },
      "additionalProperties": false
    },
    "assertion": {
      "type": "object",
      "required": ["name", "metric", "expect"],
      "description": "An assertion validates one metric against one expectation",
      "properties": {
        "name": {
          "type": "string",
          "minLength": 1,
          "maxLength": 255,
          "description": "Human-readable description of the assertion (max 255 characters)"
        },
        "metric": {
          "type": "string",
          "minLength": 1,
          "description": "Metric expression, e.g., 'average(price)', 'null_count(email) / num_rows()'",
          "examples": [
            "average(price)",
            "null_count(email) / num_rows()",
            "day_over_day(sum(revenue))",
            "abs(average(price, dataset=ds1) / average(price, dataset=ds2) - 1)"
          ]
        },
        "expect": {
          "type": "string",
          "minLength": 1,
          "pattern": "^(positive|negative|collect|>=?\\s*-?[0-9.]+|<=?\\s*-?[0-9.]+|=\\s*-?[0-9.]+|between\\s+-?[0-9.]+\\s+and\\s+-?[0-9.]+)$",
          "description": "Validation condition: '> N', '>= N', '< N', '<= N', '= N', 'between A and B', 'positive', 'negative', or 'collect'",
          "examples": [
            "> 0",
            ">= 100",
            "< 0.1",
            "<= 1000",
            "= 0",
            "between 0.8 and 1.2",
            "positive",
            "negative",
            "collect"
          ]
        },
        "severity": {
          "type": "string",
          "enum": ["P0", "P1", "P2", "P3"],
          "default": "P1",
          "description": "Severity level. P0 is highest priority."
        },
        "tolerance": {
          "type": "number",
          "minimum": 0,
          "default": 1e-9,
          "description": "Numeric tolerance for comparisons. Default: 1e-9"
        },
        "tags": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1,
            "pattern": "^[a-zA-Z0-9_-]+$"
          },
          "description": "Tags for profile rule matching. Tags must contain only alphanumerics, dashes, and underscores."
        }
      },
      "additionalProperties": false
    },
    "profile": {
      "type": "object",
      "required": ["name", "type", "start_date", "end_date"],
      "description": "A profile modifies assertion behavior during a date range",
      "properties": {
        "name": {
          "type": "string",
          "minLength": 1,
          "description": "Profile identifier"
        },
        "type": {
          "type": "string",
          "enum": ["holiday"],
          "description": "Profile type. Currently only 'holiday' is supported."
        },
        "start_date": {
          "type": "string",
          "format": "date",
          "description": "Profile activation start date (ISO 8601 format: YYYY-MM-DD)"
        },
        "end_date": {
          "type": "string",
          "format": "date",
          "description": "Profile activation end date (ISO 8601 format: YYYY-MM-DD)"
        },
        "rules": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/rule"
          },
          "description": "Rules that select and modify assertions"
        }
      },
      "additionalProperties": false
    },
    "rule": {
      "type": "object",
      "description": "A rule selects assertions and specifies modifications",
      "properties": {
        "check": {
          "type": "string",
          "minLength": 1,
          "description": "Match assertions in this check"
        },
        "assertion": {
          "type": "string",
          "minLength": 1,
          "description": "Match this specific assertion (requires 'check' to be set)"
        },
        "tag": {
          "type": "string",
          "minLength": 1,
          "pattern": "^[a-zA-Z0-9_-]+$",
          "description": "Match assertions with this tag"
        },
        "action": {
          "type": "string",
          "enum": ["disable"],
          "description": "Action to perform. 'disable' skips matched assertions."
        },
        "metric_multiplier": {
          "type": "number",
          "exclusiveMinimum": 0,
          "default": 1.0,
          "description": "Scale factor applied to the metric before validation. Default: 1.0"
        },
        "severity": {
          "type": "string",
          "enum": ["P0", "P1", "P2", "P3"],
          "description": "Override the assertion's severity"
        }
      },
      "oneOf": [
        {
          "required": ["check"]
        },
        {
          "required": ["tag"]
        }
      ],
      "dependencies": {
        "assertion": ["check"]
      },
      "additionalProperties": false
    }
  }
}
