# DQL implementation of the test_e2e_suite from test_api_e2e.py
# This suite achieves feature parity with the Python API test, with the following exceptions:
# 1. custom_sql checks are not supported in DQL (15 assertions vs 16 in Python)
# 2. Generic 'parameters' argument is not supported in DQL (named args like lag, dataset, etc. are supported)
# 3. noop() is not available in DQL, so "random tax value" uses a trivial check instead

suite "Simple test suite" {
    availability_threshold 80%

    # Check 1: Simple Checks (8 assertions)
    check "Simple Checks" on ds1 {
        assert null_count(delivered) <= 100
            name "Delivered null count is less than 100"
            severity P1

        assert minimum(quantity) <= 2.5
            name "Minimum quantity check"
            severity P1

        assert average(price) >= 10.0
            name "Average price check"
            severity P1

        assert day_over_day(average(tax)) >= 0.5
            name "Tax day-over-day check"
            severity P1

        assert duplicate_count([name], dataset=ds1) == 0
            name "No duplicates on name"
            severity P1

        assert minimum(quantity, dataset=ds1) between 1 and 5.0
            name "Quantity minimum is between 1 and 5"
            severity P1

        assert count_values(name, "np", dataset=ds1) == 0
            name "NP never buys here"
            severity P1

        assert unique_count(name) >= 5
            name "At least 5 unique customers"
            severity P1
    }

    # Check 2: Complex Metrics (1 assertion)
    check "complex metrics" on ds1 {
        assert stddev(day_over_day(average(tax)), offset=1, n=7) <= 10.0
            name "Tax stddev is small"
            severity P1
    }

    # Check 3: Null Percentage (1 assertion)
    check "Delivered null percentage" on ds1 {
        assert null_count(delivered, dataset=ds1) / num_rows() <= 0.4
            name "null percentage is less than 40%"
            severity P1
    }

    # Check 4: Manual Day Over Day (1 assertion)
    check "Manual Day Over Day" on ds1 {
        assert average(tax) / average(tax, lag=1) == 1.0
            name "Tax average day-over-day equals 1.0"
            severity P1
            tags [xmas]
            tolerance 0.01
    }

    # Check 5: Rate of Change on ds2 (2 assertions)
    check "Rate of change" on ds2 {
        assert abs(day_over_day(maximum(tax)) - 1.0) <= 0.2
            name "Maximum tax rate change is less than 20%"
            severity P1

        assert week_over_week(average(tax)) <= 0.3
            name "Average tax week-over-week change is less than 30%"
            severity P1
    }

    # Check 6: Cross Dataset Check (2 assertions)
    check "Cross Dataset Check" on ds1, ds2 {
        assert abs(average(tax, dataset=ds1) / average(tax, dataset=ds2) - 1) < 0.2
            name "Tax average ratio between datasets"
            severity P1
            tolerance 0.01

        # Note: noop() is not supported in DQL. Using a trivial check instead.
        assert first(tax, dataset=ds1) >= -999999.0
            name "random tax value"
            severity P1
    }
}
