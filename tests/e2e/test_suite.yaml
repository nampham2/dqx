# Example YAML configuration for DQX VerificationSuite
# This configuration mirrors the test_e2e_suite Python checks

name: "E-Commerce Data Quality"
data_av_threshold: 0.8

checks:
  # Simple checks on basic metrics
  - name: "Simple Checks"
    datasets: ["ds1"]
    assertions:
      - name: "Delivered null count is less than 100"
        metric: null_count(delivered)
        expect: "<= 100"

      - name: "Minimum quantity check"
        metric: minimum(quantity)
        expect: "<= 2.5"

      - name: "Average price check"
        metric: average(price)
        expect: ">= 10.0"

      - name: "Tax day-over-day check"
        metric: day_over_day(average(tax))
        expect: ">= 0.5"

      - name: "No duplicates on name"
        metric: duplicate_count(columns=[name], dataset=ds1)
        expect: "= 0"

      - name: "Quantity minimum is between 1 and 5"
        metric: minimum(quantity, dataset=ds1, min_quantity=10)
        expect: "between 1 and 5.0"

      - name: "NP never buys here"
        metric: count_values(name, "np", dataset=ds1)
        expect: "= 0"

      - name: "At least 5 unique customers"
        metric: unique_count(name)
        expect: ">= 5"

  # Custom SQL checks
  - name: "Custom checks"
    datasets: ["ds1"]
    assertions:
      - name: "Count orders"
        metric: custom_sql("count(*)", min_quantity=20)
        expect: "> 100"

  # Complex metric combinations
  - name: "complex metrics"
    datasets: ["ds1"]
    assertions:
      - name: "Tax stddev is small"
        metric: stddev(day_over_day(average(tax)), offset=1, n=7)
        expect: "<= 10.0"

  # Null percentage calculation
  - name: "Delivered null percentage"
    datasets: ["ds1"]
    assertions:
      - name: "null percentage is less than 40%"
        metric: null_count(delivered, dataset=ds1) / num_rows()
        expect: "<= 0.4"

  # Manual day-over-day with tags
  - name: "Manual Day Over Day"
    datasets: ["ds1"]
    assertions:
      - name: "Tax average day-over-day equals 1.0"
        metric: average(tax) / average(tax, lag=1)
        expect: "= 1.0"
        tolerance: 0.01
        tags: ["xmas"]

  # Rate of change checks
  - name: "Rate of change"
    datasets: ["ds2"]
    assertions:
      - name: "Maximum tax rate change is less than 20%"
        metric: abs(day_over_day(maximum(tax)) - 1.0)
        expect: "<= 0.2"

      - name: "Average tax week-over-week change is less than 30%"
        metric: week_over_week(average(tax))
        expect: "<= 0.3"

  # Cross-dataset checks
  - name: "Cross Dataset Check"
    datasets: ["ds1", "ds2"]
    assertions:
      - name: "Tax average ratio between datasets"
        metric: abs(average(tax, dataset=ds1) / average(tax, dataset=ds2) - 1)
        expect: "< 0.2"
        tolerance: 0.01

      - name: "random tax value"
        metric: first(tax, dataset=ds1)
        expect: "collect"

profiles:
  - name: "January Holiday"
    type: holiday
    start_date: "2025-01-01"
    end_date: "2025-01-31"
    rules:
      - check: "Delivered null percentage"
        action: disable
      - tag: "xmas"
        metric_multiplier: 1.0
