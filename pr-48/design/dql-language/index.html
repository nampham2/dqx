<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Transform data validation into mathematical expressions. Find issues before they find you."><meta name=author content="Nam Pham"><link href=https://dqx.readthedocs.io/design/dql-language/ rel=canonical><link rel=icon href=../../assets/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.7.1"><title>DQL: A Language for Data Quality - DQX - Data Quality Excellence</title><link rel=stylesheet href=../../assets/stylesheets/main.484c7ddc.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.ab4e12ef.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../css/timeago.css><link rel=stylesheet href=../../assets/_mkdocstrings.css><link rel=stylesheet href=../../stylesheets/extra.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=orange data-md-color-accent=blue> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#dql-a-language-for-data-quality class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="DQX - Data Quality Excellence" class="md-header__button md-logo" aria-label="DQX - Data Quality Excellence" data-md-component=logo> <img src=../../assets/logo.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> DQX - Data Quality Excellence </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> DQL: A Language for Data Quality </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=orange data-md-color-accent=blue aria-label="Switch to dark mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=orange data-md-color-accent=blue aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/nampham2/dqx title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg> </div> <div class=md-source__repository> dqx </div> </a> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../../installation/ class=md-tabs__link> Getting Started </a> </li> <li class=md-tabs__item> <a href=../../user-guide/ class=md-tabs__link> User Guide </a> </li> <li class=md-tabs__item> <a href=../ class=md-tabs__link> Development </a> </li> <li class=md-tabs__item> <a href=../../dqguard-to-dqx-comparison/ class=md-tabs__link> Reference </a> </li> <li class=md-tabs__item> <a href=../../changelog/ class=md-tabs__link> Changelog </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="DQX - Data Quality Excellence" class="md-nav__button md-logo" aria-label="DQX - Data Quality Excellence" data-md-component=logo> <img src=../../assets/logo.png alt=logo> </a> DQX - Data Quality Excellence </label> <div class=md-nav__source> <a href=https://github.com/nampham2/dqx title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg> </div> <div class=md-source__repository> dqx </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../installation/ class=md-nav__link> <span class=md-ellipsis> Getting Started </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../user-guide/ class=md-nav__link> <span class=md-ellipsis> User Guide </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../ class=md-nav__link> <span class=md-ellipsis> Development </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../dqguard-to-dqx-comparison/ class=md-nav__link> <span class=md-ellipsis> Reference </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class=md-nav__item> <a href=../../changelog/ class=md-nav__link> <span class=md-ellipsis> Changelog </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a href=https://github.com/nampham2/dqx/edit/main/docs/design/dql-language.md title="Edit this page" class="md-content__button md-icon" rel=edit> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg> </a> <a href=https://github.com/nampham2/dqx/raw/main/docs/design/dql-language.md title="View source of this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5M9.27 20H6V4h7v5h5v4.07c.7.08 1.36.25 2 .49V8l-6-6H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h4.5a8.2 8.2 0 0 1-1.23-2"/></svg> </a> <h1 id=dql-a-language-for-data-quality>DQL: A Language for Data Quality<a class=headerlink href=#dql-a-language-for-data-quality title="Anchor link to this section for reference">&para;</a></h1> <h2 id=goals>Goals<a class=headerlink href=#goals title="Anchor link to this section for reference">&para;</a></h2> <p>DQL (Data Quality Language) is designed with three goals:</p> <ol> <li><strong>Simple, dedicated syntax</strong> — A language built specifically for data quality checks, where intent is clear and boilerplate is minimal</li> <li><strong>DQX engine integration</strong> — Runs directly on the DQX runtime, leveraging its metric computation, profiling, and validation capabilities</li> <li><strong>AI-native</strong> — Structured and unambiguous enough for AI agents to read, write, and modify autonomously when investigating and resolving data quality issues</li> </ol> <h2 id=solution>Solution<a class=headerlink href=#solution title="Anchor link to this section for reference">&para;</a></h2> <p>DQL expresses data quality checks in a syntax built for the task. The interpreter validates and executes checks directly against your database.</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a>suite &quot;Order Validation&quot; {
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a>    check &quot;Completeness&quot; on orders {
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a>        assert null_count(customer_id) == 0  severity P0
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a>        assert null_count(email) / num_rows() &lt; 5%
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a>    }
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a>}
</span></code></pre></div> <p>Run:</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a>dql<span class=w> </span>run<span class=w> </span>suite.dql<span class=w> </span>--connection<span class=w> </span>databricks://...<span class=w> </span>--date<span class=w> </span><span class=m>2024</span>-12-25
</span></code></pre></div> <h2 id=structure>Structure<a class=headerlink href=#structure title="Anchor link to this section for reference">&para;</a></h2> <p>A DQL file contains one suite. A suite contains checks, profiles, and tunables.</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a>suite
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a>├── metadata (name, threshold)
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a>├── tunables
</span><span id=__span-2-4><a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a>├── checks
</span><span id=__span-2-5><a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a>│   └── assertions
</span><span id=__span-2-6><a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a>└── profiles
</span><span id=__span-2-7><a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a>    └── rules
</span></code></pre></div> <h3 id=suite>Suite<a class=headerlink href=#suite title="Anchor link to this section for reference">&para;</a></h3> <p>Every DQL file begins with a suite declaration:</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a>suite &quot;E-Commerce Data Quality&quot; {
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a>    availability_threshold 80%
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a>
</span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a>    # checks and profiles go here
</span><span id=__span-3-5><a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a>}
</span></code></pre></div> <table> <thead> <tr> <th>Field</th> <th>Required</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td><code>name</code></td> <td>Yes</td> <td>Identifies the suite</td> </tr> <tr> <td><code>availability_threshold</code></td> <td>No</td> <td>Minimum data availability (default: 90%)</td> </tr> </tbody> </table> <h3 id=check>Check<a class=headerlink href=#check title="Anchor link to this section for reference">&para;</a></h3> <p>A check groups related assertions. Each check targets one or more datasets.</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a>check &quot;Price Validation&quot; on orders {
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a>    assert average(price) &gt; 0
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a>    assert maximum(price) &lt; 10000
</span><span id=__span-4-4><a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a>}
</span></code></pre></div> <p>Target multiple datasets:</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a>check &quot;Cross-Dataset&quot; on orders, returns {
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a>    assert num_rows(dataset=returns) / num_rows(dataset=orders) &lt; 15%
</span><span id=__span-5-3><a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a>}
</span></code></pre></div> <p><strong>Cross-dataset semantics:</strong> - Each dataset resolves independently for the target date - Division by zero (empty dataset) returns <code>None</code>, triggering assertion failure - No implicit join—metrics compute per-dataset, then combine</p> <h3 id=assertion>Assertion<a class=headerlink href=#assertion title="Anchor link to this section for reference">&para;</a></h3> <p>An assertion validates one metric against one condition. Write assertions as declarative statements:</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a>assert average(price) &gt; 0
</span></code></pre></div> <p>Add a name, severity, tolerance, or tags:</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a>assert average(price) &gt; 0
</span><span id=__span-7-2><a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a>    name &quot;Average price is positive&quot;
</span><span id=__span-7-3><a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a>    severity P0
</span><span id=__span-7-4><a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a>    tags [pricing, critical]
</span></code></pre></div> <p>With tolerance for floating-point comparison:</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a>assert average(price) / average(price, lag=1) == 1.0 tolerance 0.05
</span><span id=__span-8-2><a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a>    name &quot;Ratio near 1.0&quot;
</span></code></pre></div> <p>ASCII tolerance alternatives: <code>tolerance 0.05</code> or <code>+/- 0.05</code> (Unicode <code>±</code> also supported).</p> <table> <thead> <tr> <th>Element</th> <th>Required</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td><code>name</code></td> <td>No</td> <td>Descriptive label (recommended)</td> </tr> <tr> <td><code>metric</code></td> <td>Yes</td> <td>Expression to evaluate</td> </tr> <tr> <td><code>condition</code></td> <td>Yes</td> <td>Comparison or keyword</td> </tr> <tr> <td><code>severity</code></td> <td>No</td> <td>P0, P1, P2, or P3 (default: P1)</td> </tr> <tr> <td><code>tolerance</code></td> <td>No</td> <td>Margin for <code>==</code> comparisons (expands to range check)</td> </tr> <tr> <td><code>tags</code></td> <td>No</td> <td>Labels for profile targeting</td> </tr> <tr> <td><code>sample</code></td> <td>No</td> <td>Sample data before computing metric</td> </tr> </tbody> </table> <h3 id=sampling>Sampling<a class=headerlink href=#sampling title="Anchor link to this section for reference">&para;</a></h3> <p>For large datasets, sample data before computing metrics:</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-9-1><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a>assert average(price) &gt; 0 sample 10%
</span><span id=__span-9-2><a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a>    name &quot;Price positive (10% sample)&quot;
</span><span id=__span-9-3><a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a>
</span><span id=__span-9-4><a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a>assert average(price) &gt; 0 sample 10000 rows
</span><span id=__span-9-5><a id=__codelineno-9-5 name=__codelineno-9-5 href=#__codelineno-9-5></a>    name &quot;Price positive (10k rows)&quot;
</span></code></pre></div> <p>With seed for reproducibility:</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-10-1><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a>assert average(price) &gt; 0 sample 10% seed 42
</span><span id=__span-10-2><a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a>    name &quot;Price positive (reproducible)&quot;
</span></code></pre></div> <table> <thead> <tr> <th>Syntax</th> <th>Meaning</th> </tr> </thead> <tbody> <tr> <td><code>sample N%</code></td> <td>Random sample of N percent of rows</td> </tr> <tr> <td><code>sample N rows</code></td> <td>Random sample of N rows</td> </tr> <tr> <td><code>seed M</code></td> <td>Random seed for reproducibility</td> </tr> </tbody> </table> <p><strong>Database compatibility:</strong></p> <table> <thead> <tr> <th>Database</th> <th>Method</th> </tr> </thead> <tbody> <tr> <td>DuckDB</td> <td><code>USING SAMPLE N%</code></td> </tr> <tr> <td>Databricks</td> <td><code>TABLESAMPLE (N PERCENT)</code></td> </tr> <tr> <td>PostgreSQL</td> <td><code>TABLESAMPLE BERNOULLI(N)</code></td> </tr> <tr> <td>BigQuery</td> <td><code>WHERE RAND() &lt; N/100</code></td> </tr> </tbody> </table> <p><strong>Semantics:</strong> - Sampling applies to the entire metric expression - Without <code>seed</code>, results are non-deterministic across runs - Row-based sampling (<code>N rows</code>) uses reservoir sampling for exact counts</p> <h3 id=assertion-naming-convention>Assertion Naming Convention<a class=headerlink href=#assertion-naming-convention title="Anchor link to this section for reference">&para;</a></h3> <p>Names serve as unique identifiers for programmatic reference. Use hierarchical names for machine-friendly identification:</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-11-1><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a>check &quot;Completeness&quot; on orders {
</span><span id=__span-11-2><a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a>    assert null_count(email) / num_rows() &lt; 5%
</span><span id=__span-11-3><a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a>        name &quot;orders.completeness.email_null&quot;
</span><span id=__span-11-4><a id=__codelineno-11-4 name=__codelineno-11-4 href=#__codelineno-11-4></a>
</span><span id=__span-11-5><a id=__codelineno-11-5 name=__codelineno-11-5 href=#__codelineno-11-5></a>    assert null_count(phone) / num_rows() &lt; 10%
</span><span id=__span-11-6><a id=__codelineno-11-6 name=__codelineno-11-6 href=#__codelineno-11-6></a>        name &quot;orders.completeness.phone_null&quot;
</span><span id=__span-11-7><a id=__codelineno-11-7 name=__codelineno-11-7 href=#__codelineno-11-7></a>}
</span></code></pre></div> <p><strong>Convention:</strong> <code>dataset.check.assertion</code> — enables algorithms to reference, add, or remove assertions by name.</p> <h3 id=assertion-annotations>Assertion Annotations<a class=headerlink href=#assertion-annotations title="Anchor link to this section for reference">&para;</a></h3> <p>Annotations provide metadata for algorithmic optimization:</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-12-1><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a>check &quot;Volume&quot; on orders {
</span><span id=__span-12-2><a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a>    @experimental                    # Algorithm-proposed, not yet validated
</span><span id=__span-12-3><a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a>    assert day_over_day(sum(tax)) &lt; 0.5
</span><span id=__span-12-4><a id=__codelineno-12-4 name=__codelineno-12-4 href=#__codelineno-12-4></a>        name &quot;orders.volume.tax_stability&quot;
</span><span id=__span-12-5><a id=__codelineno-12-5 name=__codelineno-12-5 href=#__codelineno-12-5></a>
</span><span id=__span-12-6><a id=__codelineno-12-6 name=__codelineno-12-6 href=#__codelineno-12-6></a>    @cost(false_positive=1, false_negative=100)
</span><span id=__span-12-7><a id=__codelineno-12-7 name=__codelineno-12-7 href=#__codelineno-12-7></a>    assert num_rows() &gt;= 1000
</span><span id=__span-12-8><a id=__codelineno-12-8 name=__codelineno-12-8 href=#__codelineno-12-8></a>        name &quot;orders.volume.min_rows&quot;
</span><span id=__span-12-9><a id=__codelineno-12-9 name=__codelineno-12-9 href=#__codelineno-12-9></a>        severity P0
</span><span id=__span-12-10><a id=__codelineno-12-10 name=__codelineno-12-10 href=#__codelineno-12-10></a>}
</span></code></pre></div> <table> <thead> <tr> <th>Annotation</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td><code>@experimental</code></td> <td>Marks assertion as algorithm-proposed, pending validation</td> </tr> <tr> <td><code>@required</code></td> <td>Assertion cannot be removed or disabled by algorithms</td> </tr> <tr> <td><code>@cost(false_positive=N, false_negative=M)</code></td> <td>Cost of false positive (N) and false negative (M) for RL reward</td> </tr> </tbody> </table> <p><strong>Cost semantics:</strong> - <code>false_positive</code> — Cost when assertion fails but data is actually fine (alert fatigue) - <code>false_negative</code> — Cost when assertion passes but data has issues (missed problem) - Higher <code>fn</code> relative to <code>fp</code> makes the algorithm prefer stricter thresholds</p> <p><strong>Safety constraints:</strong></p> <p>Prevent algorithms from gaming the system by removing critical checks:</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-13-1><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a>check &quot;Critical&quot; on orders {
</span><span id=__span-13-2><a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a>    @required                        # Cannot be removed by RL agent
</span><span id=__span-13-3><a id=__codelineno-13-3 name=__codelineno-13-3 href=#__codelineno-13-3></a>    @cost(false_positive=1, false_negative=1000)
</span><span id=__span-13-4><a id=__codelineno-13-4 name=__codelineno-13-4 href=#__codelineno-13-4></a>    assert null_count(customer_id) == 0
</span><span id=__span-13-5><a id=__codelineno-13-5 name=__codelineno-13-5 href=#__codelineno-13-5></a>        name &quot;orders.critical.customer_id&quot;
</span><span id=__span-13-6><a id=__codelineno-13-6 name=__codelineno-13-6 href=#__codelineno-13-6></a>        severity P0
</span><span id=__span-13-7><a id=__codelineno-13-7 name=__codelineno-13-7 href=#__codelineno-13-7></a>}
</span></code></pre></div> <table> <thead> <tr> <th>Constraint</th> <th>Behavior</th> </tr> </thead> <tbody> <tr> <td><code>@required</code></td> <td>Critical assertion that must always run</td> </tr> <tr> <td><code>severity P0</code></td> <td>Implied required unless explicitly <code>@experimental</code></td> </tr> <tr> <td>Non-tunable threshold</td> <td>Threshold cannot be modified (no <code>tunable</code> keyword)</td> </tr> </tbody> </table> <p><strong>Constraint enforcement:</strong> Tunable constants can only be adjusted within their declared bounds. Non-tunable thresholds and <code>@required</code> assertions represent fixed business logic that algorithms cannot modify.</p> <p><strong>Design principle:</strong> Algorithms can only tune what humans explicitly marked as tunable. Critical business logic stays protected.</p> <h3 id=conditions>Conditions<a class=headerlink href=#conditions title="Anchor link to this section for reference">&para;</a></h3> <p>Conditions specify how to validate a metric:</p> <table> <thead> <tr> <th>Syntax</th> <th>Meaning</th> </tr> </thead> <tbody> <tr> <td><code>&gt; N</code></td> <td>Greater than N</td> </tr> <tr> <td><code>&gt;= N</code></td> <td>Greater than or equal to N</td> </tr> <tr> <td><code>&lt; N</code></td> <td>Less than N</td> </tr> <tr> <td><code>&lt;= N</code></td> <td>Less than or equal to N</td> </tr> <tr> <td><code>== N</code></td> <td>Equal to N</td> </tr> <tr> <td><code>!= N</code></td> <td>Not equal to N</td> </tr> <tr> <td><code>between A and B</code></td> <td>In range [A, B]</td> </tr> <tr> <td><code>is positive</code></td> <td>Greater than zero</td> </tr> <tr> <td><code>is negative</code></td> <td>Less than zero</td> </tr> <tr> <td><code>is None</code></td> <td>Value is None</td> </tr> <tr> <td><code>is not None</code></td> <td>Value is not None</td> </tr> </tbody> </table> <h2 id=metrics>Metrics<a class=headerlink href=#metrics title="Anchor link to this section for reference">&para;</a></h2> <p>Metrics compute values from data. DQL provides built-in metrics and supports arithmetic combinations.</p> <h3 id=built-in-metrics>Built-in Metrics<a class=headerlink href=#built-in-metrics title="Anchor link to this section for reference">&para;</a></h3> <p><strong>Aggregate metrics</strong> compute over all rows:</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-14-1><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a>num_rows()              # Row count
</span><span id=__span-14-2><a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a>average(price)          # Mean value
</span><span id=__span-14-3><a id=__codelineno-14-3 name=__codelineno-14-3 href=#__codelineno-14-3></a>sum(revenue)            # Total
</span><span id=__span-14-4><a id=__codelineno-14-4 name=__codelineno-14-4 href=#__codelineno-14-4></a>minimum(quantity)       # Smallest value
</span><span id=__span-14-5><a id=__codelineno-14-5 name=__codelineno-14-5 href=#__codelineno-14-5></a>maximum(temperature)    # Largest value
</span><span id=__span-14-6><a id=__codelineno-14-6 name=__codelineno-14-6 href=#__codelineno-14-6></a>variance(score)         # Statistical variance
</span></code></pre></div> <p><strong>Completeness metrics</strong> measure data presence:</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-15-1><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a>null_count(email)           # Count of None values
</span><span id=__span-15-2><a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a>unique_count(customer_id)   # Count of distinct values
</span><span id=__span-15-3><a id=__codelineno-15-3 name=__codelineno-15-3 href=#__codelineno-15-3></a>duplicate_count([id, date]) # Count of duplicate combinations
</span></code></pre></div> <p><strong>Value metrics</strong> check specific values:</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-16-1><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a>count_values(status, &quot;pending&quot;)  # Rows where status == &quot;pending&quot;
</span><span id=__span-16-2><a id=__codelineno-16-2 name=__codelineno-16-2 href=#__codelineno-16-2></a>first(timestamp)                 # First value by row order
</span><span id=__span-16-3><a id=__codelineno-16-3 name=__codelineno-16-3 href=#__codelineno-16-3></a>first(timestamp, order_by=price) # First value ordered by price
</span></code></pre></div> <p><code>first()</code> returns the first value in storage order unless <code>order_by</code> specifies a column.</p> <p><strong>Warning:</strong> Without <code>order_by</code>, results are non-deterministic for distributed storage (Parquet, Delta Lake). Row order depends on file layout and query execution. Always use <code>order_by</code> for reproducible results.</p> <p><strong>Custom SQL</strong> executes arbitrary expressions:</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-17-1><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a>sql(&quot;SUM(amount) / COUNT(*)&quot;)
</span></code></pre></div> <p><strong><code>sql()</code> limitations:</strong></p> <ul> <li><strong>No validation</strong> — The interpreter cannot verify column names, syntax, or types</li> <li><strong>No interpolation</strong> — Constants cannot be inserted into SQL strings (prevents SQL injection)</li> <li><strong>Dialect-specific</strong> — SQL syntax varies across databases; DQL does not translate</li> </ul> <div class="language-text highlight"><pre><span></span><code><span id=__span-18-1><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a># Preferred: interpreter validates
</span><span id=__span-18-2><a id=__codelineno-18-2 name=__codelineno-18-2 href=#__codelineno-18-2></a>assert sum(amount) / num_rows() &gt; 10
</span><span id=__span-18-3><a id=__codelineno-18-3 name=__codelineno-18-3 href=#__codelineno-18-3></a>
</span><span id=__span-18-4><a id=__codelineno-18-4 name=__codelineno-18-4 href=#__codelineno-18-4></a># Escape hatch: no validation
</span><span id=__span-18-5><a id=__codelineno-18-5 name=__codelineno-18-5 href=#__codelineno-18-5></a>assert sql(&quot;SUM(amount) / COUNT(*)&quot;) &gt; 10
</span><span id=__span-18-6><a id=__codelineno-18-6 name=__codelineno-18-6 href=#__codelineno-18-6></a>
</span><span id=__span-18-7><a id=__codelineno-18-7 name=__codelineno-18-7 href=#__codelineno-18-7></a># ERROR: This example shows unsupported syntax for illustration
</span><span id=__span-18-8><a id=__codelineno-18-8 name=__codelineno-18-8 href=#__codelineno-18-8></a># DQL does not support string interpolation in sql() functions
</span><span id=__span-18-9><a id=__codelineno-18-9 name=__codelineno-18-9 href=#__codelineno-18-9></a>tunable MY_COL = &quot;amount&quot; bounds [&quot;amount&quot;, &quot;revenue&quot;]  # ERROR: String interpolation not supported
</span><span id=__span-18-10><a id=__codelineno-18-10 name=__codelineno-18-10 href=#__codelineno-18-10></a>assert sql(&quot;SUM({MY_COL})&quot;) &gt; 0  # ERROR: Interpolation in sql() not permitted
</span></code></pre></div> <p>Use built-in metrics when possible; reserve <code>sql()</code> for expressions DQL cannot represent.</p> <h3 id=parameters>Parameters<a class=headerlink href=#parameters title="Anchor link to this section for reference">&para;</a></h3> <p>Metrics accept optional parameters:</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-19-1><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a>average(price, lag=1)           # Yesterday&#39;s average
</span><span id=__span-19-2><a id=__codelineno-19-2 name=__codelineno-19-2 href=#__codelineno-19-2></a>average(price, dataset=orders)  # Specific dataset
</span></code></pre></div> <table> <thead> <tr> <th>Parameter</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td><code>lag</code></td> <td>Calendar days offset (1 = yesterday, 7 = one week ago)</td> </tr> <tr> <td><code>dataset</code></td> <td>Restrict metric to named dataset</td> </tr> </tbody> </table> <p><strong>Lag semantics:</strong> The <code>lag</code> parameter offsets by calendar days, not partition offsets. For a weekly-partitioned table queried on Monday with <code>lag 1</code>, the interpreter computes the metric for Sunday's data (which may fall in the previous week's partition).</p> <h3 id=extended-metrics>Extended Metrics<a class=headerlink href=#extended-metrics title="Anchor link to this section for reference">&para;</a></h3> <p>Extended metrics wrap base metrics for time-series analysis:</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-20-1><a id=__codelineno-20-1 name=__codelineno-20-1 href=#__codelineno-20-1></a>day_over_day(average(price))     # Absolute % change vs yesterday
</span><span id=__span-20-2><a id=__codelineno-20-2 name=__codelineno-20-2 href=#__codelineno-20-2></a>week_over_week(sum(revenue))     # Absolute % change vs last week
</span><span id=__span-20-3><a id=__codelineno-20-3 name=__codelineno-20-3 href=#__codelineno-20-3></a>stddev(average(price), n 7)      # Standard deviation over 7 days
</span></code></pre></div> <p>Day-over-day computes <code>abs((today - yesterday) / yesterday)</code>. A result of <code>0.1</code> means 10% change.</p> <h3 id=arithmetic>Arithmetic<a class=headerlink href=#arithmetic title="Anchor link to this section for reference">&para;</a></h3> <p>Combine metrics with arithmetic operators:</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-21-1><a id=__codelineno-21-1 name=__codelineno-21-1 href=#__codelineno-21-1></a>null_count(email) / num_rows()   # Null percentage
</span><span id=__span-21-2><a id=__codelineno-21-2 name=__codelineno-21-2 href=#__codelineno-21-2></a>sum(revenue) - sum(cost)         # Profit
</span><span id=__span-21-3><a id=__codelineno-21-3 name=__codelineno-21-3 href=#__codelineno-21-3></a>average(price) * 1.1             # 10% markup
</span></code></pre></div> <p>Math functions:</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-22-1><a id=__codelineno-22-1 name=__codelineno-22-1 href=#__codelineno-22-1></a>abs(day_over_day(price) - 1.0)   # Distance from no change
</span><span id=__span-22-2><a id=__codelineno-22-2 name=__codelineno-22-2 href=#__codelineno-22-2></a>sqrt(variance(score))            # Standard deviation
</span></code></pre></div> <p>Supported functions: <code>abs</code>, <code>sqrt</code>, <code>log</code>, <code>exp</code>.</p> <p>Utility functions:</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-23-1><a id=__codelineno-23-1 name=__codelineno-23-1 href=#__codelineno-23-1></a>coalesce(average(price), 0)      # Default if None
</span><span id=__span-23-2><a id=__codelineno-23-2 name=__codelineno-23-2 href=#__codelineno-23-2></a>coalesce(sum(cost), sum(revenue), 0)  # First non-None
</span></code></pre></div> <p>Supported: <code>coalesce(expr, expr, ...)</code>.</p> <h2 id=tunables>Tunables<a class=headerlink href=#tunables title="Anchor link to this section for reference">&para;</a></h2> <p>Tunables define reusable values with explicit bounds for algorithmic optimization. All tunables require bounds specification to enable RL-based threshold tuning.</p> <p>Declare tunables at suite level:</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-24-1><a id=__codelineno-24-1 name=__codelineno-24-1 href=#__codelineno-24-1></a>suite &quot;Orders&quot; {
</span><span id=__span-24-2><a id=__codelineno-24-2 name=__codelineno-24-2 href=#__codelineno-24-2></a>    tunable NULL_THRESHOLD = 5% bounds [0%, 20%]
</span><span id=__span-24-3><a id=__codelineno-24-3 name=__codelineno-24-3 href=#__codelineno-24-3></a>    tunable MIN_ORDERS = 1000 bounds [100, 10000]
</span><span id=__span-24-4><a id=__codelineno-24-4 name=__codelineno-24-4 href=#__codelineno-24-4></a>    tunable VARIANCE_LIMIT = 0.5 bounds [0.1, 1.0]
</span><span id=__span-24-5><a id=__codelineno-24-5 name=__codelineno-24-5 href=#__codelineno-24-5></a>
</span><span id=__span-24-6><a id=__codelineno-24-6 name=__codelineno-24-6 href=#__codelineno-24-6></a>    check &quot;Completeness&quot; on orders {
</span><span id=__span-24-7><a id=__codelineno-24-7 name=__codelineno-24-7 href=#__codelineno-24-7></a>        assert null_count(email) / num_rows() &lt; NULL_THRESHOLD
</span><span id=__span-24-8><a id=__codelineno-24-8 name=__codelineno-24-8 href=#__codelineno-24-8></a>        assert num_rows() &gt;= MIN_ORDERS
</span><span id=__span-24-9><a id=__codelineno-24-9 name=__codelineno-24-9 href=#__codelineno-24-9></a>    }
</span><span id=__span-24-10><a id=__codelineno-24-10 name=__codelineno-24-10 href=#__codelineno-24-10></a>}
</span></code></pre></div> <h3 id=syntax>Syntax<a class=headerlink href=#syntax title="Anchor link to this section for reference">&para;</a></h3> <div class="language-text highlight"><pre><span></span><code><span id=__span-25-1><a id=__codelineno-25-1 name=__codelineno-25-1 href=#__codelineno-25-1></a>tunable &lt;NAME&gt; = &lt;value&gt; bounds [&lt;min&gt;, &lt;max&gt;]
</span></code></pre></div> <table> <thead> <tr> <th>Element</th> <th>Required</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td><code>tunable</code></td> <td>Yes</td> <td>Keyword to declare a tunable parameter</td> </tr> <tr> <td><code>&lt;NAME&gt;</code></td> <td>Yes</td> <td>Identifier for the tunable (uppercase convention)</td> </tr> <tr> <td><code>&lt;value&gt;</code></td> <td>Yes</td> <td>Initial/default value</td> </tr> <tr> <td><code>bounds</code></td> <td>Yes</td> <td>Keyword introducing the bounds specification</td> </tr> <tr> <td><code>[&lt;min&gt;, &lt;max&gt;]</code></td> <td>Yes</td> <td>Valid range for optimization (inclusive)</td> </tr> </tbody> </table> <p><strong>Semantics:</strong> - Algorithms can modify tunables within their declared bounds - Bounds are always required - no implicit or unbounded tunables - Bounds are inclusive: <code>[0%, 20%]</code> allows values from 0% to 20% - Initial value must be within the specified bounds</p> <p><strong>Examples:</strong></p> <div class="language-text highlight"><pre><span></span><code><span id=__span-26-1><a id=__codelineno-26-1 name=__codelineno-26-1 href=#__codelineno-26-1></a># Percentage tunables
</span><span id=__span-26-2><a id=__codelineno-26-2 name=__codelineno-26-2 href=#__codelineno-26-2></a>tunable MAX_NULL_RATE = 5% bounds [0%, 20%]
</span><span id=__span-26-3><a id=__codelineno-26-3 name=__codelineno-26-3 href=#__codelineno-26-3></a>
</span><span id=__span-26-4><a id=__codelineno-26-4 name=__codelineno-26-4 href=#__codelineno-26-4></a># Integer tunables
</span><span id=__span-26-5><a id=__codelineno-26-5 name=__codelineno-26-5 href=#__codelineno-26-5></a>tunable MIN_DAILY_ORDERS = 1000 bounds [100, 10000]
</span><span id=__span-26-6><a id=__codelineno-26-6 name=__codelineno-26-6 href=#__codelineno-26-6></a>
</span><span id=__span-26-7><a id=__codelineno-26-7 name=__codelineno-26-7 href=#__codelineno-26-7></a># Decimal tunables
</span><span id=__span-26-8><a id=__codelineno-26-8 name=__codelineno-26-8 href=#__codelineno-26-8></a>tunable VARIANCE_THRESHOLD = 0.3 bounds [0.0, 1.0]
</span></code></pre></div> <h4 id=python-tunable-api>Python Tunable API<a class=headerlink href=#python-tunable-api title="Anchor link to this section for reference">&para;</a></h4> <p>Tunables are implemented as an extensible type hierarchy in <code>dqx/tunables.py</code>:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-27-1><a id=__codelineno-27-1 name=__codelineno-27-1 href=#__codelineno-27-1></a><span class=kn>from</span><span class=w> </span><span class=nn>dqx.tunables</span><span class=w> </span><span class=kn>import</span> <span class=n>TunableFloat</span><span class=p>,</span> <span class=n>TunablePercent</span><span class=p>,</span> <span class=n>TunableInt</span><span class=p>,</span> <span class=n>TunableChoice</span>
</span><span id=__span-27-2><a id=__codelineno-27-2 name=__codelineno-27-2 href=#__codelineno-27-2></a>
</span><span id=__span-27-3><a id=__codelineno-27-3 name=__codelineno-27-3 href=#__codelineno-27-3></a><span class=c1># Define tunables with type-specific validation</span>
</span><span id=__span-27-4><a id=__codelineno-27-4 name=__codelineno-27-4 href=#__codelineno-27-4></a><span class=n>NULL_THRESHOLD</span> <span class=o>=</span> <span class=n>TunablePercent</span><span class=p>(</span><span class=s2>&quot;NULL_THRESHOLD&quot;</span><span class=p>,</span> <span class=n>value</span><span class=o>=</span><span class=mf>0.05</span><span class=p>,</span> <span class=n>bounds</span><span class=o>=</span><span class=p>(</span><span class=mf>0.0</span><span class=p>,</span> <span class=mf>0.20</span><span class=p>))</span>
</span><span id=__span-27-5><a id=__codelineno-27-5 name=__codelineno-27-5 href=#__codelineno-27-5></a><span class=n>MIN_ORDERS</span> <span class=o>=</span> <span class=n>TunableInt</span><span class=p>(</span><span class=s2>&quot;MIN_ORDERS&quot;</span><span class=p>,</span> <span class=n>value</span><span class=o>=</span><span class=mi>1000</span><span class=p>,</span> <span class=n>bounds</span><span class=o>=</span><span class=p>(</span><span class=mi>100</span><span class=p>,</span> <span class=mi>10000</span><span class=p>))</span>
</span><span id=__span-27-6><a id=__codelineno-27-6 name=__codelineno-27-6 href=#__codelineno-27-6></a><span class=n>TOLERANCE</span> <span class=o>=</span> <span class=n>TunableFloat</span><span class=p>(</span><span class=s2>&quot;TOLERANCE&quot;</span><span class=p>,</span> <span class=n>value</span><span class=o>=</span><span class=mf>0.001</span><span class=p>,</span> <span class=n>bounds</span><span class=o>=</span><span class=p>(</span><span class=mf>0.0001</span><span class=p>,</span> <span class=mf>0.01</span><span class=p>))</span>
</span><span id=__span-27-7><a id=__codelineno-27-7 name=__codelineno-27-7 href=#__codelineno-27-7></a><span class=n>AGG_METHOD</span> <span class=o>=</span> <span class=n>TunableChoice</span><span class=p>(</span>
</span><span id=__span-27-8><a id=__codelineno-27-8 name=__codelineno-27-8 href=#__codelineno-27-8></a>    <span class=s2>&quot;AGG_METHOD&quot;</span><span class=p>,</span> <span class=n>value</span><span class=o>=</span><span class=s2>&quot;mean&quot;</span><span class=p>,</span> <span class=n>choices</span><span class=o>=</span><span class=p>(</span><span class=s2>&quot;mean&quot;</span><span class=p>,</span> <span class=s2>&quot;median&quot;</span><span class=p>,</span> <span class=s2>&quot;max&quot;</span><span class=p>)</span>
</span><span id=__span-27-9><a id=__codelineno-27-9 name=__codelineno-27-9 href=#__codelineno-27-9></a><span class=p>)</span>
</span><span id=__span-27-10><a id=__codelineno-27-10 name=__codelineno-27-10 href=#__codelineno-27-10></a>
</span><span id=__span-27-11><a id=__codelineno-27-11 name=__codelineno-27-11 href=#__codelineno-27-11></a><span class=c1># Register with suite at construction</span>
</span><span id=__span-27-12><a id=__codelineno-27-12 name=__codelineno-27-12 href=#__codelineno-27-12></a><span class=n>suite</span> <span class=o>=</span> <span class=n>VerificationSuite</span><span class=p>(</span>
</span><span id=__span-27-13><a id=__codelineno-27-13 name=__codelineno-27-13 href=#__codelineno-27-13></a>    <span class=n>checks</span><span class=o>=</span><span class=p>[</span><span class=n>completeness_check</span><span class=p>],</span>
</span><span id=__span-27-14><a id=__codelineno-27-14 name=__codelineno-27-14 href=#__codelineno-27-14></a>    <span class=n>db</span><span class=o>=</span><span class=n>db</span><span class=p>,</span>
</span><span id=__span-27-15><a id=__codelineno-27-15 name=__codelineno-27-15 href=#__codelineno-27-15></a>    <span class=n>name</span><span class=o>=</span><span class=s2>&quot;Orders&quot;</span><span class=p>,</span>
</span><span id=__span-27-16><a id=__codelineno-27-16 name=__codelineno-27-16 href=#__codelineno-27-16></a>    <span class=n>tunables</span><span class=o>=</span><span class=p>[</span><span class=n>NULL_THRESHOLD</span><span class=p>,</span> <span class=n>MIN_ORDERS</span><span class=p>,</span> <span class=n>TOLERANCE</span><span class=p>,</span> <span class=n>AGG_METHOD</span><span class=p>],</span>
</span><span id=__span-27-17><a id=__codelineno-27-17 name=__codelineno-27-17 href=#__codelineno-27-17></a><span class=p>)</span>
</span><span id=__span-27-18><a id=__codelineno-27-18 name=__codelineno-27-18 href=#__codelineno-27-18></a>
</span><span id=__span-27-19><a id=__codelineno-27-19 name=__codelineno-27-19 href=#__codelineno-27-19></a>
</span><span id=__span-27-20><a id=__codelineno-27-20 name=__codelineno-27-20 href=#__codelineno-27-20></a><span class=c1># Use in assertions</span>
</span><span id=__span-27-21><a id=__codelineno-27-21 name=__codelineno-27-21 href=#__codelineno-27-21></a><span class=nd>@check</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s2>&quot;Completeness&quot;</span><span class=p>)</span>
</span><span id=__span-27-22><a id=__codelineno-27-22 name=__codelineno-27-22 href=#__codelineno-27-22></a><span class=k>def</span><span class=w> </span><span class=nf>completeness_check</span><span class=p>(</span><span class=n>mp</span><span class=p>:</span> <span class=n>MetricProvider</span><span class=p>,</span> <span class=n>ctx</span><span class=p>:</span> <span class=n>Context</span><span class=p>):</span>
</span><span id=__span-27-23><a id=__codelineno-27-23 name=__codelineno-27-23 href=#__codelineno-27-23></a>    <span class=n>ctx</span><span class=o>.</span><span class=n>assert_that</span><span class=p>(</span><span class=n>mp</span><span class=o>.</span><span class=n>null_count</span><span class=p>(</span><span class=s2>&quot;email&quot;</span><span class=p>)</span> <span class=o>/</span> <span class=n>mp</span><span class=o>.</span><span class=n>num_rows</span><span class=p>())</span><span class=o>.</span><span class=n>where</span><span class=p>(</span>
</span><span id=__span-27-24><a id=__codelineno-27-24 name=__codelineno-27-24 href=#__codelineno-27-24></a>        <span class=n>name</span><span class=o>=</span><span class=s2>&quot;Email null rate&quot;</span>
</span><span id=__span-27-25><a id=__codelineno-27-25 name=__codelineno-27-25 href=#__codelineno-27-25></a>    <span class=p>)</span><span class=o>.</span><span class=n>is_lt</span><span class=p>(</span>
</span><span id=__span-27-26><a id=__codelineno-27-26 name=__codelineno-27-26 href=#__codelineno-27-26></a>        <span class=n>NULL_THRESHOLD</span><span class=o>.</span><span class=n>value</span>
</span><span id=__span-27-27><a id=__codelineno-27-27 name=__codelineno-27-27 href=#__codelineno-27-27></a>    <span class=p>)</span>  <span class=c1># .value gets current value</span>
</span></code></pre></div> <p><strong>Tunable Types:</strong></p> <table> <thead> <tr> <th>Type</th> <th>Description</th> <th>Example</th> </tr> </thead> <tbody> <tr> <td><code>TunableFloat</code></td> <td>Bounded float</td> <td><code>TunableFloat("X", value=0.5, bounds=(0.0, 1.0))</code></td> </tr> <tr> <td><code>TunablePercent</code></td> <td>Percentage (0-1 internally)</td> <td><code>TunablePercent("X", value=0.05, bounds=(0.0, 0.20))</code></td> </tr> <tr> <td><code>TunableInt</code></td> <td>Bounded integer</td> <td><code>TunableInt("X", value=100, bounds=(10, 1000))</code></td> </tr> <tr> <td><code>TunableChoice</code></td> <td>Categorical</td> <td><code>TunableChoice("X", value="a", choices=("a", "b", "c"))</code></td> </tr> </tbody> </table> <p><strong>RL Agent API:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-28-1><a id=__codelineno-28-1 name=__codelineno-28-1 href=#__codelineno-28-1></a><span class=c1># Get all tunable parameters for action space</span>
</span><span id=__span-28-2><a id=__codelineno-28-2 name=__codelineno-28-2 href=#__codelineno-28-2></a><span class=n>params</span> <span class=o>=</span> <span class=n>suite</span><span class=o>.</span><span class=n>get_tunable_params</span><span class=p>()</span>
</span><span id=__span-28-3><a id=__codelineno-28-3 name=__codelineno-28-3 href=#__codelineno-28-3></a><span class=c1># [</span>
</span><span id=__span-28-4><a id=__codelineno-28-4 name=__codelineno-28-4 href=#__codelineno-28-4></a><span class=c1>#   {&quot;name&quot;: &quot;NULL_THRESHOLD&quot;, &quot;type&quot;: &quot;percent&quot;, &quot;value&quot;: 0.05, &quot;bounds&quot;: (0.0, 0.20)},</span>
</span><span id=__span-28-5><a id=__codelineno-28-5 name=__codelineno-28-5 href=#__codelineno-28-5></a><span class=c1>#   {&quot;name&quot;: &quot;MIN_ORDERS&quot;, &quot;type&quot;: &quot;int&quot;, &quot;value&quot;: 1000, &quot;bounds&quot;: (100, 10000)},</span>
</span><span id=__span-28-6><a id=__codelineno-28-6 name=__codelineno-28-6 href=#__codelineno-28-6></a><span class=c1># ]</span>
</span><span id=__span-28-7><a id=__codelineno-28-7 name=__codelineno-28-7 href=#__codelineno-28-7></a>
</span><span id=__span-28-8><a id=__codelineno-28-8 name=__codelineno-28-8 href=#__codelineno-28-8></a><span class=c1># Modify with validation and history tracking</span>
</span><span id=__span-28-9><a id=__codelineno-28-9 name=__codelineno-28-9 href=#__codelineno-28-9></a><span class=n>suite</span><span class=o>.</span><span class=n>set_param</span><span class=p>(</span><span class=s2>&quot;NULL_THRESHOLD&quot;</span><span class=p>,</span> <span class=mf>0.03</span><span class=p>,</span> <span class=n>agent</span><span class=o>=</span><span class=s2>&quot;rl_optimizer&quot;</span><span class=p>,</span> <span class=n>reason</span><span class=o>=</span><span class=s2>&quot;Episode 42&quot;</span><span class=p>)</span>
</span><span id=__span-28-10><a id=__codelineno-28-10 name=__codelineno-28-10 href=#__codelineno-28-10></a>
</span><span id=__span-28-11><a id=__codelineno-28-11 name=__codelineno-28-11 href=#__codelineno-28-11></a><span class=c1># View change history</span>
</span><span id=__span-28-12><a id=__codelineno-28-12 name=__codelineno-28-12 href=#__codelineno-28-12></a><span class=n>history</span> <span class=o>=</span> <span class=n>suite</span><span class=o>.</span><span class=n>get_param_history</span><span class=p>(</span><span class=s2>&quot;NULL_THRESHOLD&quot;</span><span class=p>)</span>
</span><span id=__span-28-13><a id=__codelineno-28-13 name=__codelineno-28-13 href=#__codelineno-28-13></a><span class=c1># [TunableChange(timestamp=..., old_value=0.05, new_value=0.03, agent=&quot;rl_optimizer&quot;, ...)]</span>
</span></code></pre></div> <h3 id=percentage-semantics>Percentage Semantics<a class=headerlink href=#percentage-semantics title="Anchor link to this section for reference">&para;</a></h3> <p>Percentage literals convert to decimals: <code>5%</code> becomes <code>0.05</code>.</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-29-1><a id=__codelineno-29-1 name=__codelineno-29-1 href=#__codelineno-29-1></a>assert null_count(email) / num_rows() &lt; 5%   # 5% = 0.05
</span><span id=__span-29-2><a id=__codelineno-29-2 name=__codelineno-29-2 href=#__codelineno-29-2></a>assert day_over_day(num_rows()) &lt; 0.5        # 0.5 = 50% change (raw decimal)
</span></code></pre></div> <p><strong>Rule:</strong> Use <code>%</code> suffix for human-readable percentages. Use raw decimals for ratios. The interpreter treats <code>5%</code> and <code>0.05</code> identically—the distinction is for readability.</p> <h3 id=none-handling>None Handling<a class=headerlink href=#none-handling title="Anchor link to this section for reference">&para;</a></h3> <p>None propagates through arithmetic:</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-30-1><a id=__codelineno-30-1 name=__codelineno-30-1 href=#__codelineno-30-1></a>sum(revenue) - sum(cost)   # None if either is None
</span></code></pre></div> <p>None in a comparison fails the assertion:</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-31-1><a id=__codelineno-31-1 name=__codelineno-31-1 href=#__codelineno-31-1></a>assert average(price) &gt; 0   # Fails if average(price) is None
</span></code></pre></div> <p><strong>Division by zero</strong> returns None:</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-32-1><a id=__codelineno-32-1 name=__codelineno-32-1 href=#__codelineno-32-1></a>sum(a) / sum(b)   # None if sum(b) == 0
</span><span id=__span-32-2><a id=__codelineno-32-2 name=__codelineno-32-2 href=#__codelineno-32-2></a>0 / 0             # None (not NaN)
</span></code></pre></div> <p>Use <code>coalesce</code> to provide defaults:</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-33-1><a id=__codelineno-33-1 name=__codelineno-33-1 href=#__codelineno-33-1></a>assert coalesce(average(price), 0) &gt;= 0
</span></code></pre></div> <h2 id=profiles>Profiles<a class=headerlink href=#profiles title="Anchor link to this section for reference">&para;</a></h2> <p>Profiles modify assertion behavior during specific periods. Define profiles at suite level.</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-34-1><a id=__codelineno-34-1 name=__codelineno-34-1 href=#__codelineno-34-1></a>profile &quot;Black Friday&quot; {
</span><span id=__span-34-2><a id=__codelineno-34-2 name=__codelineno-34-2 href=#__codelineno-34-2></a>    type holiday
</span><span id=__span-34-3><a id=__codelineno-34-3 name=__codelineno-34-3 href=#__codelineno-34-3></a>    from 2024-11-29
</span><span id=__span-34-4><a id=__codelineno-34-4 name=__codelineno-34-4 href=#__codelineno-34-4></a>    to   2024-12-02
</span><span id=__span-34-5><a id=__codelineno-34-5 name=__codelineno-34-5 href=#__codelineno-34-5></a>
</span><span id=__span-34-6><a id=__codelineno-34-6 name=__codelineno-34-6 href=#__codelineno-34-6></a>    disable check &quot;Volume&quot;
</span><span id=__span-34-7><a id=__codelineno-34-7 name=__codelineno-34-7 href=#__codelineno-34-7></a>    scale tag &quot;seasonal&quot; by 3.0x
</span><span id=__span-34-8><a id=__codelineno-34-8 name=__codelineno-34-8 href=#__codelineno-34-8></a>}
</span></code></pre></div> <h3 id=profile-fields>Profile Fields<a class=headerlink href=#profile-fields title="Anchor link to this section for reference">&para;</a></h3> <table> <thead> <tr> <th>Field</th> <th>Required</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td><code>name</code></td> <td>Yes</td> <td>Profile identifier</td> </tr> <tr> <td><code>type</code></td> <td>Yes</td> <td>Profile type: <code>holiday</code> or <code>recurring</code></td> </tr> <tr> <td><code>from</code></td> <td>Yes</td> <td>Start date (ISO format or expression)</td> </tr> <tr> <td><code>to</code></td> <td>Yes</td> <td>End date (ISO format or expression)</td> </tr> </tbody> </table> <h3 id=profile-types>Profile Types<a class=headerlink href=#profile-types title="Anchor link to this section for reference">&para;</a></h3> <p><strong><code>holiday</code></strong> — Fixed dates. ISO dates apply to that specific year only. Date expressions re-evaluate each year.</p> <p><strong><code>recurring</code></strong> — Re-evaluates <code>from</code>/<code>to</code> expressions relative to the execution date (e.g., monthly patterns).</p> <h3 id=dynamic-dates>Dynamic Dates<a class=headerlink href=#dynamic-dates title="Anchor link to this section for reference">&para;</a></h3> <p>Use date expressions for recurring events:</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-35-1><a id=__codelineno-35-1 name=__codelineno-35-1 href=#__codelineno-35-1></a>profile &quot;Thanksgiving Week&quot; {
</span><span id=__span-35-2><a id=__codelineno-35-2 name=__codelineno-35-2 href=#__codelineno-35-2></a>    type holiday
</span><span id=__span-35-3><a id=__codelineno-35-3 name=__codelineno-35-3 href=#__codelineno-35-3></a>    from nth_weekday(november, thursday, 4)      # 4th Thursday
</span><span id=__span-35-4><a id=__codelineno-35-4 name=__codelineno-35-4 href=#__codelineno-35-4></a>    to   nth_weekday(november, thursday, 4) + 3  # Through Sunday
</span><span id=__span-35-5><a id=__codelineno-35-5 name=__codelineno-35-5 href=#__codelineno-35-5></a>}
</span><span id=__span-35-6><a id=__codelineno-35-6 name=__codelineno-35-6 href=#__codelineno-35-6></a>
</span><span id=__span-35-7><a id=__codelineno-35-7 name=__codelineno-35-7 href=#__codelineno-35-7></a>profile &quot;Christmas&quot; {
</span><span id=__span-35-8><a id=__codelineno-35-8 name=__codelineno-35-8 href=#__codelineno-35-8></a>    type holiday
</span><span id=__span-35-9><a id=__codelineno-35-9 name=__codelineno-35-9 href=#__codelineno-35-9></a>    from december(20)    # December 20 of execution year
</span><span id=__span-35-10><a id=__codelineno-35-10 name=__codelineno-35-10 href=#__codelineno-35-10></a>    to   january(5)      # January 5 of following year
</span><span id=__span-35-11><a id=__codelineno-35-11 name=__codelineno-35-11 href=#__codelineno-35-11></a>}
</span><span id=__span-35-12><a id=__codelineno-35-12 name=__codelineno-35-12 href=#__codelineno-35-12></a>
</span><span id=__span-35-13><a id=__codelineno-35-13 name=__codelineno-35-13 href=#__codelineno-35-13></a>profile &quot;Month End&quot; {
</span><span id=__span-35-14><a id=__codelineno-35-14 name=__codelineno-35-14 href=#__codelineno-35-14></a>    type recurring
</span><span id=__span-35-15><a id=__codelineno-35-15 name=__codelineno-35-15 href=#__codelineno-35-15></a>    from last_day_of_month() - 2
</span><span id=__span-35-16><a id=__codelineno-35-16 name=__codelineno-35-16 href=#__codelineno-35-16></a>    to   last_day_of_month()
</span><span id=__span-35-17><a id=__codelineno-35-17 name=__codelineno-35-17 href=#__codelineno-35-17></a>}
</span></code></pre></div> <p><strong>Year handling:</strong> When <code>to</code> references a month earlier than <code>from</code> (e.g., December → January), the interpreter infers year rollover. Explicit year can be specified: <code>january(5, year + 1)</code>.</p> <p>Date functions:</p> <table> <thead> <tr> <th>Function</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td><code>nth_weekday(month, day, n)</code></td> <td>Nth occurrence of weekday in month</td> </tr> <tr> <td><code>last_day_of_month()</code></td> <td>Last day of current month</td> </tr> <tr> <td><code>month(day)</code></td> <td>Specific day in month (e.g., <code>december(25)</code>)</td> </tr> <tr> <td><code>month(day, year)</code></td> <td>Explicit year: <code>year</code>, <code>year + 1</code>, <code>year - 1</code></td> </tr> <tr> <td>Date arithmetic</td> <td><code>+ N</code> or <code>- N</code> for day offsets</td> </tr> </tbody> </table> <h3 id=rules>Rules<a class=headerlink href=#rules title="Anchor link to this section for reference">&para;</a></h3> <p>Rules select assertions and apply modifications:</p> <p><strong>Disable</strong> skips matched assertions:</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-36-1><a id=__codelineno-36-1 name=__codelineno-36-1 href=#__codelineno-36-1></a>disable check &quot;Volume&quot;
</span><span id=__span-36-2><a id=__codelineno-36-2 name=__codelineno-36-2 href=#__codelineno-36-2></a>disable assertion &quot;Order count&quot; in &quot;Volume&quot;
</span></code></pre></div> <p><strong>Scale</strong> multiplies the computed metric value before comparison:</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-37-1><a id=__codelineno-37-1 name=__codelineno-37-1 href=#__codelineno-37-1></a>scale tag &quot;seasonal&quot; by 2.0x
</span><span id=__span-37-2><a id=__codelineno-37-2 name=__codelineno-37-2 href=#__codelineno-37-2></a>scale check &quot;Revenue&quot; by 1.5x
</span></code></pre></div> <p><strong>Scale semantics:</strong> The multiplier applies to the metric value, not the threshold. Use this when you expect the metric to be <em>lower</em> than normal due to reduced activity.</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-38-1><a id=__codelineno-38-1 name=__codelineno-38-1 href=#__codelineno-38-1></a># Normal: assert num_rows() &gt;= 1000
</span><span id=__span-38-2><a id=__codelineno-38-2 name=__codelineno-38-2 href=#__codelineno-38-2></a># Holiday traffic drops to 500 rows (50% of normal)
</span><span id=__span-38-3><a id=__codelineno-38-3 name=__codelineno-38-3 href=#__codelineno-38-3></a># Without profile: 500 &gt;= 1000 → FAIL (false positive!)
</span><span id=__span-38-4><a id=__codelineno-38-4 name=__codelineno-38-4 href=#__codelineno-38-4></a>#
</span><span id=__span-38-5><a id=__codelineno-38-5 name=__codelineno-38-5 href=#__codelineno-38-5></a># With scale 2.0x: 500 × 2.0 = 1000 &gt;= 1000 → PASS
</span><span id=__span-38-6><a id=__codelineno-38-6 name=__codelineno-38-6 href=#__codelineno-38-6></a># Interpretation: &quot;500 rows during a 0.5× traffic period is like 1000 rows normally&quot;
</span></code></pre></div> <p><strong>Mental model:</strong> Scale answers: "What would this metric be under normal conditions?" A scale of 2.0x compensates for a period with 50% expected traffic—multiply the actual value to normalize it for comparison against normal-period thresholds.</p> <p>For <code>between A and B</code>, the scaled metric compares against both bounds unchanged.</p> <p><strong>Set severity</strong> changes the severity level (can raise or lower):</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-39-1><a id=__codelineno-39-1 name=__codelineno-39-1 href=#__codelineno-39-1></a>set tag &quot;non-critical&quot; severity P3
</span><span id=__span-39-2><a id=__codelineno-39-2 name=__codelineno-39-2 href=#__codelineno-39-2></a>set check &quot;Volume&quot; severity P2
</span></code></pre></div> <h3 id=rule-ordering>Rule Ordering<a class=headerlink href=#rule-ordering title="Anchor link to this section for reference">&para;</a></h3> <p>Rules apply in definition order. Multipliers compound; severity uses last match.</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-40-1><a id=__codelineno-40-1 name=__codelineno-40-1 href=#__codelineno-40-1></a>profile &quot;Holiday&quot; {
</span><span id=__span-40-2><a id=__codelineno-40-2 name=__codelineno-40-2 href=#__codelineno-40-2></a>    type holiday
</span><span id=__span-40-3><a id=__codelineno-40-3 name=__codelineno-40-3 href=#__codelineno-40-3></a>    from 2024-12-20
</span><span id=__span-40-4><a id=__codelineno-40-4 name=__codelineno-40-4 href=#__codelineno-40-4></a>    to   2025-01-05
</span><span id=__span-40-5><a id=__codelineno-40-5 name=__codelineno-40-5 href=#__codelineno-40-5></a>
</span><span id=__span-40-6><a id=__codelineno-40-6 name=__codelineno-40-6 href=#__codelineno-40-6></a>    scale tag &quot;volume&quot; by 1.5x
</span><span id=__span-40-7><a id=__codelineno-40-7 name=__codelineno-40-7 href=#__codelineno-40-7></a>    scale check &quot;Orders&quot; by 2.0x
</span><span id=__span-40-8><a id=__codelineno-40-8 name=__codelineno-40-8 href=#__codelineno-40-8></a>    # Assertion with tag &quot;volume&quot; in &quot;Orders&quot;: multiplier = 3.0x
</span><span id=__span-40-9><a id=__codelineno-40-9 name=__codelineno-40-9 href=#__codelineno-40-9></a>}
</span></code></pre></div> <h3 id=profile-overlap>Profile Overlap<a class=headerlink href=#profile-overlap title="Anchor link to this section for reference">&para;</a></h3> <p>When multiple profiles match the same date, rules from all matching profiles apply in profile definition order. Multipliers compound across profiles.</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-41-1><a id=__codelineno-41-1 name=__codelineno-41-1 href=#__codelineno-41-1></a>profile &quot;Holiday Season&quot; { from 2024-11-15 to 2025-01-05 scale tag &quot;volume&quot; by 1.5x }
</span><span id=__span-41-2><a id=__codelineno-41-2 name=__codelineno-41-2 href=#__codelineno-41-2></a>profile &quot;Black Friday&quot; { from 2024-11-29 to 2024-12-02 scale tag &quot;volume&quot; by 2.0x }
</span><span id=__span-41-3><a id=__codelineno-41-3 name=__codelineno-41-3 href=#__codelineno-41-3></a>
</span><span id=__span-41-4><a id=__codelineno-41-4 name=__codelineno-41-4 href=#__codelineno-41-4></a># On 2024-11-30: Both profiles active
</span><span id=__span-41-5><a id=__codelineno-41-5 name=__codelineno-41-5 href=#__codelineno-41-5></a># Combined multiplier for &quot;volume&quot; tag: 1.5 × 2.0 = 3.0x
</span></code></pre></div> <p><strong>Warning:</strong> Overlapping profiles with compounding multipliers can produce unexpected results. The interpreter logs active profiles and combined multipliers for debugging.</p> <h2 id=complete-example>Complete Example<a class=headerlink href=#complete-example title="Anchor link to this section for reference">&para;</a></h2> <div class="language-text highlight"><pre><span></span><code><span id=__span-42-1><a id=__codelineno-42-1 name=__codelineno-42-1 href=#__codelineno-42-1></a>suite &quot;E-Commerce Data Quality&quot; {
</span><span id=__span-42-2><a id=__codelineno-42-2 name=__codelineno-42-2 href=#__codelineno-42-2></a>    availability_threshold 80%
</span><span id=__span-42-3><a id=__codelineno-42-3 name=__codelineno-42-3 href=#__codelineno-42-3></a>
</span><span id=__span-42-4><a id=__codelineno-42-4 name=__codelineno-42-4 href=#__codelineno-42-4></a>    tunable MAX_NULL_RATE = 5% bounds [0%, 20%]
</span><span id=__span-42-5><a id=__codelineno-42-5 name=__codelineno-42-5 href=#__codelineno-42-5></a>    tunable MIN_ORDERS = 1000 bounds [100, 10000]
</span><span id=__span-42-6><a id=__codelineno-42-6 name=__codelineno-42-6 href=#__codelineno-42-6></a>
</span><span id=__span-42-7><a id=__codelineno-42-7 name=__codelineno-42-7 href=#__codelineno-42-7></a>    check &quot;Completeness&quot; on orders {
</span><span id=__span-42-8><a id=__codelineno-42-8 name=__codelineno-42-8 href=#__codelineno-42-8></a>        assert null_count(customer_id) == 0
</span><span id=__span-42-9><a id=__codelineno-42-9 name=__codelineno-42-9 href=#__codelineno-42-9></a>            name &quot;No null customer IDs&quot;
</span><span id=__span-42-10><a id=__codelineno-42-10 name=__codelineno-42-10 href=#__codelineno-42-10></a>            severity P0
</span><span id=__span-42-11><a id=__codelineno-42-11 name=__codelineno-42-11 href=#__codelineno-42-11></a>
</span><span id=__span-42-12><a id=__codelineno-42-12 name=__codelineno-42-12 href=#__codelineno-42-12></a>        assert null_count(email) / num_rows() &lt; MAX_NULL_RATE
</span><span id=__span-42-13><a id=__codelineno-42-13 name=__codelineno-42-13 href=#__codelineno-42-13></a>            name &quot;Email null rate below threshold&quot;
</span><span id=__span-42-14><a id=__codelineno-42-14 name=__codelineno-42-14 href=#__codelineno-42-14></a>
</span><span id=__span-42-15><a id=__codelineno-42-15 name=__codelineno-42-15 href=#__codelineno-42-15></a>        assert null_count(phone) / num_rows() &lt; MAX_NULL_RATE
</span><span id=__span-42-16><a id=__codelineno-42-16 name=__codelineno-42-16 href=#__codelineno-42-16></a>            name &quot;Phone null rate below threshold&quot;
</span><span id=__span-42-17><a id=__codelineno-42-17 name=__codelineno-42-17 href=#__codelineno-42-17></a>    }
</span><span id=__span-42-18><a id=__codelineno-42-18 name=__codelineno-42-18 href=#__codelineno-42-18></a>
</span><span id=__span-42-19><a id=__codelineno-42-19 name=__codelineno-42-19 href=#__codelineno-42-19></a>    check &quot;Volume&quot; on orders {
</span><span id=__span-42-20><a id=__codelineno-42-20 name=__codelineno-42-20 href=#__codelineno-42-20></a>        assert num_rows() &gt;= MIN_ORDERS
</span><span id=__span-42-21><a id=__codelineno-42-21 name=__codelineno-42-21 href=#__codelineno-42-21></a>            name &quot;At least minimum orders&quot;
</span><span id=__span-42-22><a id=__codelineno-42-22 name=__codelineno-42-22 href=#__codelineno-42-22></a>            tags [volume]
</span><span id=__span-42-23><a id=__codelineno-42-23 name=__codelineno-42-23 href=#__codelineno-42-23></a>
</span><span id=__span-42-24><a id=__codelineno-42-24 name=__codelineno-42-24 href=#__codelineno-42-24></a>        assert day_over_day(num_rows()) between 0.5 and 2.0
</span><span id=__span-42-25><a id=__codelineno-42-25 name=__codelineno-42-25 href=#__codelineno-42-25></a>            name &quot;Day-over-day stable&quot;
</span><span id=__span-42-26><a id=__codelineno-42-26 name=__codelineno-42-26 href=#__codelineno-42-26></a>            tags [volume, trend]
</span><span id=__span-42-27><a id=__codelineno-42-27 name=__codelineno-42-27 href=#__codelineno-42-27></a>    }
</span><span id=__span-42-28><a id=__codelineno-42-28 name=__codelineno-42-28 href=#__codelineno-42-28></a>
</span><span id=__span-42-29><a id=__codelineno-42-29 name=__codelineno-42-29 href=#__codelineno-42-29></a>    check &quot;Revenue&quot; on orders {
</span><span id=__span-42-30><a id=__codelineno-42-30 name=__codelineno-42-30 href=#__codelineno-42-30></a>        assert sum(amount) + sum(tax) is positive
</span><span id=__span-42-31><a id=__codelineno-42-31 name=__codelineno-42-31 href=#__codelineno-42-31></a>            name &quot;Total revenue positive&quot;
</span><span id=__span-42-32><a id=__codelineno-42-32 name=__codelineno-42-32 href=#__codelineno-42-32></a>            severity P0
</span><span id=__span-42-33><a id=__codelineno-42-33 name=__codelineno-42-33 href=#__codelineno-42-33></a>
</span><span id=__span-42-34><a id=__codelineno-42-34 name=__codelineno-42-34 href=#__codelineno-42-34></a>        assert sum(amount) / num_rows() between 10 and 500
</span><span id=__span-42-35><a id=__codelineno-42-35 name=__codelineno-42-35 href=#__codelineno-42-35></a>            name &quot;Average order value in range&quot;
</span><span id=__span-42-36><a id=__codelineno-42-36 name=__codelineno-42-36 href=#__codelineno-42-36></a>    }
</span><span id=__span-42-37><a id=__codelineno-42-37 name=__codelineno-42-37 href=#__codelineno-42-37></a>
</span><span id=__span-42-38><a id=__codelineno-42-38 name=__codelineno-42-38 href=#__codelineno-42-38></a>    check &quot;Cross-Dataset&quot; on orders, returns {
</span><span id=__span-42-39><a id=__codelineno-42-39 name=__codelineno-42-39 href=#__codelineno-42-39></a>        assert num_rows(dataset=returns) / num_rows(dataset=orders) &lt; 15%
</span><span id=__span-42-40><a id=__codelineno-42-40 name=__codelineno-42-40 href=#__codelineno-42-40></a>            name &quot;Return rate below 15%&quot;
</span><span id=__span-42-41><a id=__codelineno-42-41 name=__codelineno-42-41 href=#__codelineno-42-41></a>    }
</span><span id=__span-42-42><a id=__codelineno-42-42 name=__codelineno-42-42 href=#__codelineno-42-42></a>
</span><span id=__span-42-43><a id=__codelineno-42-43 name=__codelineno-42-43 href=#__codelineno-42-43></a>    check &quot;Stability&quot; on orders {
</span><span id=__span-42-44><a id=__codelineno-42-44 name=__codelineno-42-44 href=#__codelineno-42-44></a>        assert abs(day_over_day(average(price))) &lt; 0.1
</span><span id=__span-42-45><a id=__codelineno-42-45 name=__codelineno-42-45 href=#__codelineno-42-45></a>            name &quot;Price change within 10%&quot;
</span><span id=__span-42-46><a id=__codelineno-42-46 name=__codelineno-42-46 href=#__codelineno-42-46></a>            tags [stability]
</span><span id=__span-42-47><a id=__codelineno-42-47 name=__codelineno-42-47 href=#__codelineno-42-47></a>
</span><span id=__span-42-48><a id=__codelineno-42-48 name=__codelineno-42-48 href=#__codelineno-42-48></a>        assert sqrt(variance(amount)) / average(amount) &lt; 0.5
</span><span id=__span-42-49><a id=__codelineno-42-49 name=__codelineno-42-49 href=#__codelineno-42-49></a>            name &quot;Coefficient of variation acceptable&quot;
</span><span id=__span-42-50><a id=__codelineno-42-50 name=__codelineno-42-50 href=#__codelineno-42-50></a>            tags [stability]
</span><span id=__span-42-51><a id=__codelineno-42-51 name=__codelineno-42-51 href=#__codelineno-42-51></a>    }
</span><span id=__span-42-52><a id=__codelineno-42-52 name=__codelineno-42-52 href=#__codelineno-42-52></a>
</span><span id=__span-42-53><a id=__codelineno-42-53 name=__codelineno-42-53 href=#__codelineno-42-53></a>    profile &quot;Black Friday&quot; {
</span><span id=__span-42-54><a id=__codelineno-42-54 name=__codelineno-42-54 href=#__codelineno-42-54></a>        type holiday
</span><span id=__span-42-55><a id=__codelineno-42-55 name=__codelineno-42-55 href=#__codelineno-42-55></a>        from 2024-11-29
</span><span id=__span-42-56><a id=__codelineno-42-56 name=__codelineno-42-56 href=#__codelineno-42-56></a>        to   2024-12-02
</span><span id=__span-42-57><a id=__codelineno-42-57 name=__codelineno-42-57 href=#__codelineno-42-57></a>
</span><span id=__span-42-58><a id=__codelineno-42-58 name=__codelineno-42-58 href=#__codelineno-42-58></a>        scale tag &quot;volume&quot; by 3.0x
</span><span id=__span-42-59><a id=__codelineno-42-59 name=__codelineno-42-59 href=#__codelineno-42-59></a>    }
</span><span id=__span-42-60><a id=__codelineno-42-60 name=__codelineno-42-60 href=#__codelineno-42-60></a>
</span><span id=__span-42-61><a id=__codelineno-42-61 name=__codelineno-42-61 href=#__codelineno-42-61></a>    profile &quot;Christmas&quot; {
</span><span id=__span-42-62><a id=__codelineno-42-62 name=__codelineno-42-62 href=#__codelineno-42-62></a>        type holiday
</span><span id=__span-42-63><a id=__codelineno-42-63 name=__codelineno-42-63 href=#__codelineno-42-63></a>        from 2024-12-20
</span><span id=__span-42-64><a id=__codelineno-42-64 name=__codelineno-42-64 href=#__codelineno-42-64></a>        to   2025-01-05
</span><span id=__span-42-65><a id=__codelineno-42-65 name=__codelineno-42-65 href=#__codelineno-42-65></a>
</span><span id=__span-42-66><a id=__codelineno-42-66 name=__codelineno-42-66 href=#__codelineno-42-66></a>        disable check &quot;Volume&quot;
</span><span id=__span-42-67><a id=__codelineno-42-67 name=__codelineno-42-67 href=#__codelineno-42-67></a>        set tag &quot;trend&quot; severity P3
</span><span id=__span-42-68><a id=__codelineno-42-68 name=__codelineno-42-68 href=#__codelineno-42-68></a>    }
</span><span id=__span-42-69><a id=__codelineno-42-69 name=__codelineno-42-69 href=#__codelineno-42-69></a>}
</span></code></pre></div> <h2 id=history-file>History File<a class=headerlink href=#history-file title="Anchor link to this section for reference">&para;</a></h2> <p>DQL tracks changes in a separate history file to support algorithmic optimization and auditing. The history file is a JSONL (JSON Lines) file alongside the DQL source.</p> <p><strong>File convention:</strong> - <code>suite.dql</code> — The specification (human + algorithm authored) - <code>suite.dql.history</code> — Change log (append-only)</p> <h3 id=history-format>History Format<a class=headerlink href=#history-format title="Anchor link to this section for reference">&para;</a></h3> <div class="language-text highlight"><pre><span></span><code><span id=__span-43-1><a id=__codelineno-43-1 name=__codelineno-43-1 href=#__codelineno-43-1></a>{&quot;ts&quot;: &quot;2024-12-01T10:00:00Z&quot;, &quot;action&quot;: &quot;set_param&quot;, &quot;param&quot;: &quot;NULL_THRESHOLD&quot;, &quot;old&quot;: 0.10, &quot;new&quot;: 0.05, &quot;agent&quot;: &quot;rl_optimizer&quot;, &quot;episode&quot;: 42}
</span><span id=__span-43-2><a id=__codelineno-43-2 name=__codelineno-43-2 href=#__codelineno-43-2></a>{&quot;ts&quot;: &quot;2024-12-15T14:30:00Z&quot;, &quot;action&quot;: &quot;set_param&quot;, &quot;param&quot;: &quot;MIN_ORDERS&quot;, &quot;old&quot;: 1000, &quot;new&quot;: 800, &quot;agent&quot;: &quot;autotuner&quot;, &quot;reason&quot;: &quot;seasonal adjustment&quot;}
</span><span id=__span-43-3><a id=__codelineno-43-3 name=__codelineno-43-3 href=#__codelineno-43-3></a>{&quot;ts&quot;: &quot;2024-12-20T09:00:00Z&quot;, &quot;action&quot;: &quot;set_param&quot;, &quot;param&quot;: &quot;TOLERANCE&quot;, &quot;old&quot;: 0.001, &quot;new&quot;: 0.002, &quot;agent&quot;: &quot;human&quot;, &quot;reason&quot;: &quot;reduce false positives&quot;}
</span></code></pre></div> <h3 id=history-actions>History Actions<a class=headerlink href=#history-actions title="Anchor link to this section for reference">&para;</a></h3> <table> <thead> <tr> <th>Action</th> <th>Description</th> <th>Fields</th> </tr> </thead> <tbody> <tr> <td><code>set_param</code></td> <td>Tunable parameter changed</td> <td><code>param</code>, <code>old</code>, <code>new</code>, <code>agent</code>, <code>reason</code></td> </tr> </tbody> </table> <h3 id=agent-field>Agent Field<a class=headerlink href=#agent-field title="Anchor link to this section for reference">&para;</a></h3> <p>The <code>agent</code> field identifies who made the change: - <code>human</code> — Manual edit by engineer - <code>rl_optimizer</code> — Reinforcement learning algorithm - <code>autotuner</code> — Threshold optimization algorithm - Custom agent names for other automation</p> <h3 id=usage>Usage<a class=headerlink href=#usage title="Anchor link to this section for reference">&para;</a></h3> <div class="language-bash highlight"><pre><span></span><code><span id=__span-44-1><a id=__codelineno-44-1 name=__codelineno-44-1 href=#__codelineno-44-1></a><span class=c1># View history</span>
</span><span id=__span-44-2><a id=__codelineno-44-2 name=__codelineno-44-2 href=#__codelineno-44-2></a>dql<span class=w> </span><span class=nb>history</span><span class=w> </span>suite.dql
</span><span id=__span-44-3><a id=__codelineno-44-3 name=__codelineno-44-3 href=#__codelineno-44-3></a>
</span><span id=__span-44-4><a id=__codelineno-44-4 name=__codelineno-44-4 href=#__codelineno-44-4></a><span class=c1># Rollback to previous state</span>
</span><span id=__span-44-5><a id=__codelineno-44-5 name=__codelineno-44-5 href=#__codelineno-44-5></a>dql<span class=w> </span>rollback<span class=w> </span>suite.dql<span class=w> </span>--to<span class=w> </span><span class=m>2024</span>-12-15
</span><span id=__span-44-6><a id=__codelineno-44-6 name=__codelineno-44-6 href=#__codelineno-44-6></a>
</span><span id=__span-44-7><a id=__codelineno-44-7 name=__codelineno-44-7 href=#__codelineno-44-7></a><span class=c1># Export history for analysis</span>
</span><span id=__span-44-8><a id=__codelineno-44-8 name=__codelineno-44-8 href=#__codelineno-44-8></a>dql<span class=w> </span><span class=nb>history</span><span class=w> </span>suite.dql<span class=w> </span>--format<span class=w> </span>csv<span class=w> </span>&gt;<span class=w> </span>changes.csv
</span></code></pre></div> <p>The history file can be git-tracked separately or added to <code>.gitignore</code> depending on team preference.</p> <h2 id=runtime>Runtime<a class=headerlink href=#runtime title="Anchor link to this section for reference">&para;</a></h2> <p>The interpreter executes DQL files directly against your database. Metric expressions pass to sympy for parsing, enabling full compatibility with DQX's Python runtime.</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-45-1><a id=__codelineno-45-1 name=__codelineno-45-1 href=#__codelineno-45-1></a>┌─────────────────────────────────────────────────────────────┐
</span><span id=__span-45-2><a id=__codelineno-45-2 name=__codelineno-45-2 href=#__codelineno-45-2></a>│                      DQL Source                             │
</span><span id=__span-45-3><a id=__codelineno-45-3 name=__codelineno-45-3 href=#__codelineno-45-3></a>│                     (suite.dql)                             │
</span><span id=__span-45-4><a id=__codelineno-45-4 name=__codelineno-45-4 href=#__codelineno-45-4></a>└──────────────────────────────┬──────────────────────────────┘
</span><span id=__span-45-5><a id=__codelineno-45-5 name=__codelineno-45-5 href=#__codelineno-45-5></a>                              │
</span><span id=__span-45-6><a id=__codelineno-45-6 name=__codelineno-45-6 href=#__codelineno-45-6></a>                              ▼
</span><span id=__span-45-7><a id=__codelineno-45-7 name=__codelineno-45-7 href=#__codelineno-45-7></a>                    ┌─────────────────┐
</span><span id=__span-45-8><a id=__codelineno-45-8 name=__codelineno-45-8 href=#__codelineno-45-8></a>                    │   Interpreter   │
</span><span id=__span-45-9><a id=__codelineno-45-9 name=__codelineno-45-9 href=#__codelineno-45-9></a>                    │   (via sympy)   │
</span><span id=__span-45-10><a id=__codelineno-45-10 name=__codelineno-45-10 href=#__codelineno-45-10></a>                    └────────┬────────┘
</span><span id=__span-45-11><a id=__codelineno-45-11 name=__codelineno-45-11 href=#__codelineno-45-11></a>                             │
</span><span id=__span-45-12><a id=__codelineno-45-12 name=__codelineno-45-12 href=#__codelineno-45-12></a>                             ▼
</span><span id=__span-45-13><a id=__codelineno-45-13 name=__codelineno-45-13 href=#__codelineno-45-13></a>                    ┌─────────────────┐
</span><span id=__span-45-14><a id=__codelineno-45-14 name=__codelineno-45-14 href=#__codelineno-45-14></a>                    │   DQX Runtime   │
</span><span id=__span-45-15><a id=__codelineno-45-15 name=__codelineno-45-15 href=#__codelineno-45-15></a>                    │   (database)    │
</span><span id=__span-45-16><a id=__codelineno-45-16 name=__codelineno-45-16 href=#__codelineno-45-16></a>                    └─────────────────┘
</span></code></pre></div> <h3 id=installation>Installation<a class=headerlink href=#installation title="Anchor link to this section for reference">&para;</a></h3> <div class="language-bash highlight"><pre><span></span><code><span id=__span-46-1><a id=__codelineno-46-1 name=__codelineno-46-1 href=#__codelineno-46-1></a>pip<span class=w> </span>install<span class=w> </span>dqx<span class=o>[</span>dql<span class=o>]</span>
</span></code></pre></div> <h3 id=commands>Commands<a class=headerlink href=#commands title="Anchor link to this section for reference">&para;</a></h3> <p><strong>Run a suite</strong>:</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-47-1><a id=__codelineno-47-1 name=__codelineno-47-1 href=#__codelineno-47-1></a>dql<span class=w> </span>run<span class=w> </span>suite.dql<span class=w> </span>--connection<span class=w> </span>databricks://host/warehouse<span class=w> </span>--date<span class=w> </span><span class=m>2024</span>-12-25
</span></code></pre></div> <p><strong>Validate without executing</strong>:</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-48-1><a id=__codelineno-48-1 name=__codelineno-48-1 href=#__codelineno-48-1></a>dql<span class=w> </span>check<span class=w> </span>suite.dql
</span></code></pre></div> <p><strong>Watch for changes</strong> (re-runs on file modification):</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-49-1><a id=__codelineno-49-1 name=__codelineno-49-1 href=#__codelineno-49-1></a>dql<span class=w> </span>run<span class=w> </span>suite.dql<span class=w> </span>--watch
</span></code></pre></div> <p><strong>Output formats</strong>:</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-50-1><a id=__codelineno-50-1 name=__codelineno-50-1 href=#__codelineno-50-1></a>dql<span class=w> </span>run<span class=w> </span>suite.dql<span class=w> </span>--output<span class=w> </span>json<span class=w>      </span><span class=c1># Machine-readable</span>
</span><span id=__span-50-2><a id=__codelineno-50-2 name=__codelineno-50-2 href=#__codelineno-50-2></a>dql<span class=w> </span>run<span class=w> </span>suite.dql<span class=w> </span>--output<span class=w> </span>table<span class=w>     </span><span class=c1># Human-readable (default)</span>
</span><span id=__span-50-3><a id=__codelineno-50-3 name=__codelineno-50-3 href=#__codelineno-50-3></a>dql<span class=w> </span>run<span class=w> </span>suite.dql<span class=w> </span>--output<span class=w> </span>summary<span class=w>   </span><span class=c1># Pass/fail counts only</span>
</span></code></pre></div> <h3 id=configuration-file>Configuration File<a class=headerlink href=#configuration-file title="Anchor link to this section for reference">&para;</a></h3> <p>Store connection settings in <code>dqx.toml</code> to avoid repeating arguments:</p> <div class="language-toml highlight"><pre><span></span><code><span id=__span-51-1><a id=__codelineno-51-1 name=__codelineno-51-1 href=#__codelineno-51-1></a><span class=k>[connection]</span>
</span><span id=__span-51-2><a id=__codelineno-51-2 name=__codelineno-51-2 href=#__codelineno-51-2></a><span class=n>type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;databricks&quot;</span>
</span><span id=__span-51-3><a id=__codelineno-51-3 name=__codelineno-51-3 href=#__codelineno-51-3></a><span class=n>host</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;workspace.cloud.databricks.com&quot;</span>
</span><span id=__span-51-4><a id=__codelineno-51-4 name=__codelineno-51-4 href=#__codelineno-51-4></a><span class=n>http_path</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;/sql/1.0/warehouses/abc123&quot;</span>
</span><span id=__span-51-5><a id=__codelineno-51-5 name=__codelineno-51-5 href=#__codelineno-51-5></a>
</span><span id=__span-51-6><a id=__codelineno-51-6 name=__codelineno-51-6 href=#__codelineno-51-6></a><span class=k>[defaults]</span>
</span><span id=__span-51-7><a id=__codelineno-51-7 name=__codelineno-51-7 href=#__codelineno-51-7></a><span class=n>date</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;today&quot;</span>
</span><span id=__span-51-8><a id=__codelineno-51-8 name=__codelineno-51-8 href=#__codelineno-51-8></a><span class=n>output</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;table&quot;</span>
</span></code></pre></div> <p>Then run:</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-52-1><a id=__codelineno-52-1 name=__codelineno-52-1 href=#__codelineno-52-1></a>dql<span class=w> </span>run<span class=w> </span>suite.dql
</span></code></pre></div> <h3 id=python-api>Python API<a class=headerlink href=#python-api title="Anchor link to this section for reference">&para;</a></h3> <p>Embed the interpreter in Python code:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-53-1><a id=__codelineno-53-1 name=__codelineno-53-1 href=#__codelineno-53-1></a><span class=kn>from</span><span class=w> </span><span class=nn>dqx.dql</span><span class=w> </span><span class=kn>import</span> <span class=n>Interpreter</span>
</span><span id=__span-53-2><a id=__codelineno-53-2 name=__codelineno-53-2 href=#__codelineno-53-2></a><span class=kn>from</span><span class=w> </span><span class=nn>datetime</span><span class=w> </span><span class=kn>import</span> <span class=n>date</span>
</span><span id=__span-53-3><a id=__codelineno-53-3 name=__codelineno-53-3 href=#__codelineno-53-3></a>
</span><span id=__span-53-4><a id=__codelineno-53-4 name=__codelineno-53-4 href=#__codelineno-53-4></a><span class=n>interp</span> <span class=o>=</span> <span class=n>Interpreter</span><span class=p>(</span><span class=n>db</span><span class=o>=</span><span class=n>my_db</span><span class=p>,</span> <span class=n>target_date</span><span class=o>=</span><span class=n>date</span><span class=o>.</span><span class=n>today</span><span class=p>())</span>
</span><span id=__span-53-5><a id=__codelineno-53-5 name=__codelineno-53-5 href=#__codelineno-53-5></a><span class=n>results</span> <span class=o>=</span> <span class=n>interp</span><span class=o>.</span><span class=n>run_file</span><span class=p>(</span><span class=s2>&quot;suite.dql&quot;</span><span class=p>)</span>
</span><span id=__span-53-6><a id=__codelineno-53-6 name=__codelineno-53-6 href=#__codelineno-53-6></a>
</span><span id=__span-53-7><a id=__codelineno-53-7 name=__codelineno-53-7 href=#__codelineno-53-7></a><span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=n>results</span><span class=p>:</span>
</span><span id=__span-53-8><a id=__codelineno-53-8 name=__codelineno-53-8 href=#__codelineno-53-8></a>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>r</span><span class=o>.</span><span class=n>check</span><span class=si>}</span><span class=s2>/</span><span class=si>{</span><span class=n>r</span><span class=o>.</span><span class=n>assertion</span><span class=si>}</span><span class=s2>: </span><span class=si>{</span><span class=n>r</span><span class=o>.</span><span class=n>status</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span></code></pre></div> <p>Or run from a string:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-54-1><a id=__codelineno-54-1 name=__codelineno-54-1 href=#__codelineno-54-1></a><span class=n>dql_source</span> <span class=o>=</span> <span class=s2>&quot;&quot;&quot;</span>
</span><span id=__span-54-2><a id=__codelineno-54-2 name=__codelineno-54-2 href=#__codelineno-54-2></a><span class=s2>suite &quot;Quick Check&quot; {</span>
</span><span id=__span-54-3><a id=__codelineno-54-3 name=__codelineno-54-3 href=#__codelineno-54-3></a><span class=s2>    check &quot;Basic&quot; on orders {</span>
</span><span id=__span-54-4><a id=__codelineno-54-4 name=__codelineno-54-4 href=#__codelineno-54-4></a><span class=s2>        assert num_rows() &gt; 0</span>
</span><span id=__span-54-5><a id=__codelineno-54-5 name=__codelineno-54-5 href=#__codelineno-54-5></a><span class=s2>    }</span>
</span><span id=__span-54-6><a id=__codelineno-54-6 name=__codelineno-54-6 href=#__codelineno-54-6></a><span class=s2>}</span>
</span><span id=__span-54-7><a id=__codelineno-54-7 name=__codelineno-54-7 href=#__codelineno-54-7></a><span class=s2>&quot;&quot;&quot;</span>
</span><span id=__span-54-8><a id=__codelineno-54-8 name=__codelineno-54-8 href=#__codelineno-54-8></a><span class=n>results</span> <span class=o>=</span> <span class=n>interp</span><span class=o>.</span><span class=n>run_string</span><span class=p>(</span><span class=n>dql_source</span><span class=p>)</span>
</span></code></pre></div> <h3 id=rl-agent-integration>RL Agent Integration<a class=headerlink href=#rl-agent-integration title="Anchor link to this section for reference">&para;</a></h3> <p>DQL provides a programmatic API for reinforcement learning agents to optimize data quality checks:</p> <ol> <li>Read tunable parameters and their bounds</li> <li>Modify thresholds within bounds</li> <li>Run checks and observe outcomes</li> <li>Compute rewards from results and costs</li> <li>Log changes to history</li> </ol> <p><strong>Action Space:</strong></p> <p>The RL agent operates on a continuous, bounded action space derived from tunable parameters:</p> <table> <thead> <tr> <th>Component</th> <th>Type</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td><strong>Threshold adjustments</strong></td> <td>Continuous, bounded</td> <td>One dimension per <code>tunable</code> parameter</td> </tr> </tbody> </table> <div class="language-python highlight"><pre><span></span><code><span id=__span-55-1><a id=__codelineno-55-1 name=__codelineno-55-1 href=#__codelineno-55-1></a><span class=c1># Continuous action space derived from tunable parameters</span>
</span><span id=__span-55-2><a id=__codelineno-55-2 name=__codelineno-55-2 href=#__codelineno-55-2></a><span class=n>action_space</span> <span class=o>=</span> <span class=p>{</span>
</span><span id=__span-55-3><a id=__codelineno-55-3 name=__codelineno-55-3 href=#__codelineno-55-3></a>    <span class=s2>&quot;NULL_THRESHOLD&quot;</span><span class=p>:</span> <span class=p>(</span><span class=mf>0.0</span><span class=p>,</span> <span class=mf>0.20</span><span class=p>),</span>  <span class=c1># from tunable [0%, 20%]</span>
</span><span id=__span-55-4><a id=__codelineno-55-4 name=__codelineno-55-4 href=#__codelineno-55-4></a>    <span class=s2>&quot;MIN_ORDERS&quot;</span><span class=p>:</span> <span class=p>(</span><span class=mi>100</span><span class=p>,</span> <span class=mi>10000</span><span class=p>),</span>  <span class=c1># from tunable [100, 10000]</span>
</span><span id=__span-55-5><a id=__codelineno-55-5 name=__codelineno-55-5 href=#__codelineno-55-5></a>    <span class=s2>&quot;DOD_LIMIT&quot;</span><span class=p>:</span> <span class=p>(</span><span class=mf>0.1</span><span class=p>,</span> <span class=mf>1.0</span><span class=p>),</span>  <span class=c1># from tunable [0.1, 1.0]</span>
</span><span id=__span-55-6><a id=__codelineno-55-6 name=__codelineno-55-6 href=#__codelineno-55-6></a><span class=p>}</span>
</span><span id=__span-55-7><a id=__codelineno-55-7 name=__codelineno-55-7 href=#__codelineno-55-7></a>
</span><span id=__span-55-8><a id=__codelineno-55-8 name=__codelineno-55-8 href=#__codelineno-55-8></a><span class=c1># Example action from policy</span>
</span><span id=__span-55-9><a id=__codelineno-55-9 name=__codelineno-55-9 href=#__codelineno-55-9></a><span class=n>action</span> <span class=o>=</span> <span class=p>{</span>
</span><span id=__span-55-10><a id=__codelineno-55-10 name=__codelineno-55-10 href=#__codelineno-55-10></a>    <span class=s2>&quot;NULL_THRESHOLD&quot;</span><span class=p>:</span> <span class=mf>0.03</span><span class=p>,</span>  <span class=c1># Lower threshold (stricter)</span>
</span><span id=__span-55-11><a id=__codelineno-55-11 name=__codelineno-55-11 href=#__codelineno-55-11></a>    <span class=s2>&quot;MIN_ORDERS&quot;</span><span class=p>:</span> <span class=mi>1500</span><span class=p>,</span>  <span class=c1># Raise minimum</span>
</span><span id=__span-55-12><a id=__codelineno-55-12 name=__codelineno-55-12 href=#__codelineno-55-12></a>    <span class=s2>&quot;DOD_LIMIT&quot;</span><span class=p>:</span> <span class=mf>0.4</span><span class=p>,</span>  <span class=c1># Slightly tighter</span>
</span><span id=__span-55-13><a id=__codelineno-55-13 name=__codelineno-55-13 href=#__codelineno-55-13></a><span class=p>}</span>
</span></code></pre></div> <p>For threshold optimization, use bounded continuous control algorithms (PPO, SAC).</p> <p><strong>Example DQL with tunable thresholds and costs:</strong></p> <div class="language-text highlight"><pre><span></span><code><span id=__span-56-1><a id=__codelineno-56-1 name=__codelineno-56-1 href=#__codelineno-56-1></a>suite &quot;Orders&quot; {
</span><span id=__span-56-2><a id=__codelineno-56-2 name=__codelineno-56-2 href=#__codelineno-56-2></a>    tunable NULL_THRESHOLD = 5% bounds [0%, 20%]
</span><span id=__span-56-3><a id=__codelineno-56-3 name=__codelineno-56-3 href=#__codelineno-56-3></a>    tunable MIN_ORDERS = 1000 bounds [100, 10000]
</span><span id=__span-56-4><a id=__codelineno-56-4 name=__codelineno-56-4 href=#__codelineno-56-4></a>    tunable DOD_LIMIT = 0.5 bounds [0.1, 1.0]
</span><span id=__span-56-5><a id=__codelineno-56-5 name=__codelineno-56-5 href=#__codelineno-56-5></a>
</span><span id=__span-56-6><a id=__codelineno-56-6 name=__codelineno-56-6 href=#__codelineno-56-6></a>    check &quot;Completeness&quot; on orders {
</span><span id=__span-56-7><a id=__codelineno-56-7 name=__codelineno-56-7 href=#__codelineno-56-7></a>        @cost(false_positive=1, false_negative=50)
</span><span id=__span-56-8><a id=__codelineno-56-8 name=__codelineno-56-8 href=#__codelineno-56-8></a>        assert null_count(email) / num_rows() &lt; NULL_THRESHOLD
</span><span id=__span-56-9><a id=__codelineno-56-9 name=__codelineno-56-9 href=#__codelineno-56-9></a>            name &quot;orders.completeness.email_null&quot;
</span><span id=__span-56-10><a id=__codelineno-56-10 name=__codelineno-56-10 href=#__codelineno-56-10></a>
</span><span id=__span-56-11><a id=__codelineno-56-11 name=__codelineno-56-11 href=#__codelineno-56-11></a>        @cost(false_positive=1, false_negative=100)
</span><span id=__span-56-12><a id=__codelineno-56-12 name=__codelineno-56-12 href=#__codelineno-56-12></a>        assert null_count(customer_id) == 0
</span><span id=__span-56-13><a id=__codelineno-56-13 name=__codelineno-56-13 href=#__codelineno-56-13></a>            name &quot;orders.completeness.customer_id_null&quot;
</span><span id=__span-56-14><a id=__codelineno-56-14 name=__codelineno-56-14 href=#__codelineno-56-14></a>            severity P0
</span><span id=__span-56-15><a id=__codelineno-56-15 name=__codelineno-56-15 href=#__codelineno-56-15></a>    }
</span><span id=__span-56-16><a id=__codelineno-56-16 name=__codelineno-56-16 href=#__codelineno-56-16></a>
</span><span id=__span-56-17><a id=__codelineno-56-17 name=__codelineno-56-17 href=#__codelineno-56-17></a>    check &quot;Volume&quot; on orders {
</span><span id=__span-56-18><a id=__codelineno-56-18 name=__codelineno-56-18 href=#__codelineno-56-18></a>        @cost(false_positive=5, false_negative=200)
</span><span id=__span-56-19><a id=__codelineno-56-19 name=__codelineno-56-19 href=#__codelineno-56-19></a>        assert num_rows() &gt;= MIN_ORDERS
</span><span id=__span-56-20><a id=__codelineno-56-20 name=__codelineno-56-20 href=#__codelineno-56-20></a>            name &quot;orders.volume.min_rows&quot;
</span><span id=__span-56-21><a id=__codelineno-56-21 name=__codelineno-56-21 href=#__codelineno-56-21></a>
</span><span id=__span-56-22><a id=__codelineno-56-22 name=__codelineno-56-22 href=#__codelineno-56-22></a>        @experimental
</span><span id=__span-56-23><a id=__codelineno-56-23 name=__codelineno-56-23 href=#__codelineno-56-23></a>        @cost(false_positive=2, false_negative=50)
</span><span id=__span-56-24><a id=__codelineno-56-24 name=__codelineno-56-24 href=#__codelineno-56-24></a>        assert day_over_day(num_rows()) &lt; DOD_LIMIT
</span><span id=__span-56-25><a id=__codelineno-56-25 name=__codelineno-56-25 href=#__codelineno-56-25></a>            name &quot;orders.volume.dod_stability&quot;
</span><span id=__span-56-26><a id=__codelineno-56-26 name=__codelineno-56-26 href=#__codelineno-56-26></a>    }
</span><span id=__span-56-27><a id=__codelineno-56-27 name=__codelineno-56-27 href=#__codelineno-56-27></a>}
</span></code></pre></div> <p><strong>RL Agent Implementation:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-57-1><a id=__codelineno-57-1 name=__codelineno-57-1 href=#__codelineno-57-1></a><span class=kn>from</span><span class=w> </span><span class=nn>dqx.dql</span><span class=w> </span><span class=kn>import</span> <span class=n>Suite</span><span class=p>,</span> <span class=n>History</span>
</span><span id=__span-57-2><a id=__codelineno-57-2 name=__codelineno-57-2 href=#__codelineno-57-2></a><span class=kn>from</span><span class=w> </span><span class=nn>datetime</span><span class=w> </span><span class=kn>import</span> <span class=n>date</span><span class=p>,</span> <span class=n>timedelta</span>
</span><span id=__span-57-3><a id=__codelineno-57-3 name=__codelineno-57-3 href=#__codelineno-57-3></a><span class=kn>import</span><span class=w> </span><span class=nn>numpy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>np</span>
</span><span id=__span-57-4><a id=__codelineno-57-4 name=__codelineno-57-4 href=#__codelineno-57-4></a>
</span><span id=__span-57-5><a id=__codelineno-57-5 name=__codelineno-57-5 href=#__codelineno-57-5></a>
</span><span id=__span-57-6><a id=__codelineno-57-6 name=__codelineno-57-6 href=#__codelineno-57-6></a><span class=k>class</span><span class=w> </span><span class=nc>DQThresholdAgent</span><span class=p>:</span>
</span><span id=__span-57-7><a id=__codelineno-57-7 name=__codelineno-57-7 href=#__codelineno-57-7></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;RL agent that optimizes DQL thresholds.&quot;&quot;&quot;</span>
</span><span id=__span-57-8><a id=__codelineno-57-8 name=__codelineno-57-8 href=#__codelineno-57-8></a>
</span><span id=__span-57-9><a id=__codelineno-57-9 name=__codelineno-57-9 href=#__codelineno-57-9></a>    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>suite_path</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>db</span><span class=p>):</span>
</span><span id=__span-57-10><a id=__codelineno-57-10 name=__codelineno-57-10 href=#__codelineno-57-10></a>        <span class=bp>self</span><span class=o>.</span><span class=n>suite</span> <span class=o>=</span> <span class=n>Suite</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>suite_path</span><span class=p>)</span>
</span><span id=__span-57-11><a id=__codelineno-57-11 name=__codelineno-57-11 href=#__codelineno-57-11></a>        <span class=bp>self</span><span class=o>.</span><span class=n>history</span> <span class=o>=</span> <span class=n>History</span><span class=p>(</span><span class=n>suite_path</span> <span class=o>+</span> <span class=s2>&quot;.history&quot;</span><span class=p>)</span>
</span><span id=__span-57-12><a id=__codelineno-57-12 name=__codelineno-57-12 href=#__codelineno-57-12></a>        <span class=bp>self</span><span class=o>.</span><span class=n>db</span> <span class=o>=</span> <span class=n>db</span>
</span><span id=__span-57-13><a id=__codelineno-57-13 name=__codelineno-57-13 href=#__codelineno-57-13></a>        <span class=bp>self</span><span class=o>.</span><span class=n>episode</span> <span class=o>=</span> <span class=mi>0</span>
</span><span id=__span-57-14><a id=__codelineno-57-14 name=__codelineno-57-14 href=#__codelineno-57-14></a>
</span><span id=__span-57-15><a id=__codelineno-57-15 name=__codelineno-57-15 href=#__codelineno-57-15></a>    <span class=k>def</span><span class=w> </span><span class=nf>get_state</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>:</span>
</span><span id=__span-57-16><a id=__codelineno-57-16 name=__codelineno-57-16 href=#__codelineno-57-16></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Extract current thresholds as state vector.&quot;&quot;&quot;</span>
</span><span id=__span-57-17><a id=__codelineno-57-17 name=__codelineno-57-17 href=#__codelineno-57-17></a>        <span class=n>params</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>suite</span><span class=o>.</span><span class=n>get_tunable_params</span><span class=p>()</span>
</span><span id=__span-57-18><a id=__codelineno-57-18 name=__codelineno-57-18 href=#__codelineno-57-18></a>        <span class=k>return</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=n>p</span><span class=o>.</span><span class=n>normalized_value</span> <span class=k>for</span> <span class=n>p</span> <span class=ow>in</span> <span class=n>params</span><span class=p>])</span>
</span><span id=__span-57-19><a id=__codelineno-57-19 name=__codelineno-57-19 href=#__codelineno-57-19></a>
</span><span id=__span-57-20><a id=__codelineno-57-20 name=__codelineno-57-20 href=#__codelineno-57-20></a>    <span class=k>def</span><span class=w> </span><span class=nf>get_action_space</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>list</span><span class=p>:</span>
</span><span id=__span-57-21><a id=__codelineno-57-21 name=__codelineno-57-21 href=#__codelineno-57-21></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Get tunable parameters with bounds.&quot;&quot;&quot;</span>
</span><span id=__span-57-22><a id=__codelineno-57-22 name=__codelineno-57-22 href=#__codelineno-57-22></a>        <span class=k>return</span> <span class=p>[</span>
</span><span id=__span-57-23><a id=__codelineno-57-23 name=__codelineno-57-23 href=#__codelineno-57-23></a>            <span class=p>{</span><span class=s2>&quot;name&quot;</span><span class=p>:</span> <span class=n>p</span><span class=o>.</span><span class=n>name</span><span class=p>,</span> <span class=s2>&quot;bounds&quot;</span><span class=p>:</span> <span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>min_bound</span><span class=p>,</span> <span class=n>p</span><span class=o>.</span><span class=n>max_bound</span><span class=p>)}</span>
</span><span id=__span-57-24><a id=__codelineno-57-24 name=__codelineno-57-24 href=#__codelineno-57-24></a>            <span class=k>for</span> <span class=n>p</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>suite</span><span class=o>.</span><span class=n>get_tunable_params</span><span class=p>()</span>
</span><span id=__span-57-25><a id=__codelineno-57-25 name=__codelineno-57-25 href=#__codelineno-57-25></a>        <span class=p>]</span>
</span><span id=__span-57-26><a id=__codelineno-57-26 name=__codelineno-57-26 href=#__codelineno-57-26></a>
</span><span id=__span-57-27><a id=__codelineno-57-27 name=__codelineno-57-27 href=#__codelineno-57-27></a>    <span class=k>def</span><span class=w> </span><span class=nf>apply_action</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>actions</span><span class=p>:</span> <span class=nb>dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=nb>float</span><span class=p>]):</span>
</span><span id=__span-57-28><a id=__codelineno-57-28 name=__codelineno-57-28 href=#__codelineno-57-28></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Apply threshold changes from RL policy.&quot;&quot;&quot;</span>
</span><span id=__span-57-29><a id=__codelineno-57-29 name=__codelineno-57-29 href=#__codelineno-57-29></a>        <span class=k>for</span> <span class=n>name</span><span class=p>,</span> <span class=n>new_value</span> <span class=ow>in</span> <span class=n>actions</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span><span id=__span-57-30><a id=__codelineno-57-30 name=__codelineno-57-30 href=#__codelineno-57-30></a>            <span class=n>old</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>suite</span><span class=o>.</span><span class=n>get_param</span><span class=p>(</span><span class=n>name</span><span class=p>)</span>
</span><span id=__span-57-31><a id=__codelineno-57-31 name=__codelineno-57-31 href=#__codelineno-57-31></a>            <span class=bp>self</span><span class=o>.</span><span class=n>suite</span><span class=o>.</span><span class=n>set_param</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>new_value</span><span class=p>)</span>
</span><span id=__span-57-32><a id=__codelineno-57-32 name=__codelineno-57-32 href=#__codelineno-57-32></a>            <span class=bp>self</span><span class=o>.</span><span class=n>history</span><span class=o>.</span><span class=n>log</span><span class=p>(</span>
</span><span id=__span-57-33><a id=__codelineno-57-33 name=__codelineno-57-33 href=#__codelineno-57-33></a>                <span class=p>{</span>
</span><span id=__span-57-34><a id=__codelineno-57-34 name=__codelineno-57-34 href=#__codelineno-57-34></a>                    <span class=s2>&quot;action&quot;</span><span class=p>:</span> <span class=s2>&quot;set_param&quot;</span><span class=p>,</span>
</span><span id=__span-57-35><a id=__codelineno-57-35 name=__codelineno-57-35 href=#__codelineno-57-35></a>                    <span class=s2>&quot;param&quot;</span><span class=p>:</span> <span class=n>name</span><span class=p>,</span>
</span><span id=__span-57-36><a id=__codelineno-57-36 name=__codelineno-57-36 href=#__codelineno-57-36></a>                    <span class=s2>&quot;old&quot;</span><span class=p>:</span> <span class=n>old</span><span class=p>,</span>
</span><span id=__span-57-37><a id=__codelineno-57-37 name=__codelineno-57-37 href=#__codelineno-57-37></a>                    <span class=s2>&quot;new&quot;</span><span class=p>:</span> <span class=n>new_value</span><span class=p>,</span>
</span><span id=__span-57-38><a id=__codelineno-57-38 name=__codelineno-57-38 href=#__codelineno-57-38></a>                    <span class=s2>&quot;agent&quot;</span><span class=p>:</span> <span class=s2>&quot;rl_optimizer&quot;</span><span class=p>,</span>
</span><span id=__span-57-39><a id=__codelineno-57-39 name=__codelineno-57-39 href=#__codelineno-57-39></a>                    <span class=s2>&quot;episode&quot;</span><span class=p>:</span> <span class=bp>self</span><span class=o>.</span><span class=n>episode</span><span class=p>,</span>
</span><span id=__span-57-40><a id=__codelineno-57-40 name=__codelineno-57-40 href=#__codelineno-57-40></a>                <span class=p>}</span>
</span><span id=__span-57-41><a id=__codelineno-57-41 name=__codelineno-57-41 href=#__codelineno-57-41></a>            <span class=p>)</span>
</span><span id=__span-57-42><a id=__codelineno-57-42 name=__codelineno-57-42 href=#__codelineno-57-42></a>
</span><span id=__span-57-43><a id=__codelineno-57-43 name=__codelineno-57-43 href=#__codelineno-57-43></a>    <span class=k>def</span><span class=w> </span><span class=nf>run_and_observe</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>target_date</span><span class=p>:</span> <span class=n>date</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
</span><span id=__span-57-44><a id=__codelineno-57-44 name=__codelineno-57-44 href=#__codelineno-57-44></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Execute checks and return structured results.&quot;&quot;&quot;</span>
</span><span id=__span-57-45><a id=__codelineno-57-45 name=__codelineno-57-45 href=#__codelineno-57-45></a>        <span class=n>results</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>suite</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>db</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>db</span><span class=p>,</span> <span class=n>date</span><span class=o>=</span><span class=n>target_date</span><span class=p>)</span>
</span><span id=__span-57-46><a id=__codelineno-57-46 name=__codelineno-57-46 href=#__codelineno-57-46></a>        <span class=k>return</span> <span class=p>{</span>
</span><span id=__span-57-47><a id=__codelineno-57-47 name=__codelineno-57-47 href=#__codelineno-57-47></a>            <span class=s2>&quot;assertions&quot;</span><span class=p>:</span> <span class=p>[</span>
</span><span id=__span-57-48><a id=__codelineno-57-48 name=__codelineno-57-48 href=#__codelineno-57-48></a>                <span class=p>{</span>
</span><span id=__span-57-49><a id=__codelineno-57-49 name=__codelineno-57-49 href=#__codelineno-57-49></a>                    <span class=s2>&quot;name&quot;</span><span class=p>:</span> <span class=n>r</span><span class=o>.</span><span class=n>name</span><span class=p>,</span>
</span><span id=__span-57-50><a id=__codelineno-57-50 name=__codelineno-57-50 href=#__codelineno-57-50></a>                    <span class=s2>&quot;passed&quot;</span><span class=p>:</span> <span class=n>r</span><span class=o>.</span><span class=n>passed</span><span class=p>,</span>
</span><span id=__span-57-51><a id=__codelineno-57-51 name=__codelineno-57-51 href=#__codelineno-57-51></a>                    <span class=s2>&quot;value&quot;</span><span class=p>:</span> <span class=n>r</span><span class=o>.</span><span class=n>metric_value</span><span class=p>,</span>
</span><span id=__span-57-52><a id=__codelineno-57-52 name=__codelineno-57-52 href=#__codelineno-57-52></a>                <span class=p>}</span>
</span><span id=__span-57-53><a id=__codelineno-57-53 name=__codelineno-57-53 href=#__codelineno-57-53></a>                <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=n>results</span><span class=o>.</span><span class=n>assertions</span>
</span><span id=__span-57-54><a id=__codelineno-57-54 name=__codelineno-57-54 href=#__codelineno-57-54></a>            <span class=p>]</span>
</span><span id=__span-57-55><a id=__codelineno-57-55 name=__codelineno-57-55 href=#__codelineno-57-55></a>        <span class=p>}</span>
</span><span id=__span-57-56><a id=__codelineno-57-56 name=__codelineno-57-56 href=#__codelineno-57-56></a>
</span><span id=__span-57-57><a id=__codelineno-57-57 name=__codelineno-57-57 href=#__codelineno-57-57></a>    <span class=k>def</span><span class=w> </span><span class=nf>compute_reward</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>results</span><span class=p>:</span> <span class=nb>dict</span><span class=p>,</span> <span class=n>ground_truth</span><span class=p>:</span> <span class=nb>dict</span> <span class=o>=</span> <span class=kc>None</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>float</span><span class=p>:</span>
</span><span id=__span-57-58><a id=__codelineno-57-58 name=__codelineno-57-58 href=#__codelineno-57-58></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Compute reward from results.</span>
</span><span id=__span-57-59><a id=__codelineno-57-59 name=__codelineno-57-59 href=#__codelineno-57-59></a>
</span><span id=__span-57-60><a id=__codelineno-57-60 name=__codelineno-57-60 href=#__codelineno-57-60></a><span class=sd>        Simple reward: +1 for correct predictions, -1 for incorrect.</span>
</span><span id=__span-57-61><a id=__codelineno-57-61 name=__codelineno-57-61 href=#__codelineno-57-61></a><span class=sd>        Can be extended to use @cost annotations when available.</span>
</span><span id=__span-57-62><a id=__codelineno-57-62 name=__codelineno-57-62 href=#__codelineno-57-62></a><span class=sd>        &quot;&quot;&quot;</span>
</span><span id=__span-57-63><a id=__codelineno-57-63 name=__codelineno-57-63 href=#__codelineno-57-63></a>        <span class=n>reward</span> <span class=o>=</span> <span class=mf>0.0</span>
</span><span id=__span-57-64><a id=__codelineno-57-64 name=__codelineno-57-64 href=#__codelineno-57-64></a>        <span class=k>for</span> <span class=n>a</span> <span class=ow>in</span> <span class=n>results</span><span class=p>[</span><span class=s2>&quot;assertions&quot;</span><span class=p>]:</span>
</span><span id=__span-57-65><a id=__codelineno-57-65 name=__codelineno-57-65 href=#__codelineno-57-65></a>            <span class=k>if</span> <span class=n>ground_truth</span> <span class=ow>and</span> <span class=n>a</span><span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>]</span> <span class=ow>in</span> <span class=n>ground_truth</span><span class=p>:</span>
</span><span id=__span-57-66><a id=__codelineno-57-66 name=__codelineno-57-66 href=#__codelineno-57-66></a>                <span class=n>actual_issue</span> <span class=o>=</span> <span class=n>ground_truth</span><span class=p>[</span><span class=n>a</span><span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>]]</span>
</span><span id=__span-57-67><a id=__codelineno-57-67 name=__codelineno-57-67 href=#__codelineno-57-67></a>                <span class=k>if</span> <span class=n>a</span><span class=p>[</span><span class=s2>&quot;passed&quot;</span><span class=p>]</span> <span class=o>==</span> <span class=p>(</span><span class=ow>not</span> <span class=n>actual_issue</span><span class=p>):</span>
</span><span id=__span-57-68><a id=__codelineno-57-68 name=__codelineno-57-68 href=#__codelineno-57-68></a>                    <span class=n>reward</span> <span class=o>+=</span> <span class=mf>1.0</span>  <span class=c1># Correct prediction</span>
</span><span id=__span-57-69><a id=__codelineno-57-69 name=__codelineno-57-69 href=#__codelineno-57-69></a>                <span class=k>else</span><span class=p>:</span>
</span><span id=__span-57-70><a id=__codelineno-57-70 name=__codelineno-57-70 href=#__codelineno-57-70></a>                    <span class=n>reward</span> <span class=o>-=</span> <span class=mf>1.0</span>  <span class=c1># Incorrect prediction</span>
</span><span id=__span-57-71><a id=__codelineno-57-71 name=__codelineno-57-71 href=#__codelineno-57-71></a>        <span class=k>return</span> <span class=n>reward</span>
</span><span id=__span-57-72><a id=__codelineno-57-72 name=__codelineno-57-72 href=#__codelineno-57-72></a>
</span><span id=__span-57-73><a id=__codelineno-57-73 name=__codelineno-57-73 href=#__codelineno-57-73></a>    <span class=k>def</span><span class=w> </span><span class=nf>save</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-57-74><a id=__codelineno-57-74 name=__codelineno-57-74 href=#__codelineno-57-74></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Persist changes to DQL file and history.&quot;&quot;&quot;</span>
</span><span id=__span-57-75><a id=__codelineno-57-75 name=__codelineno-57-75 href=#__codelineno-57-75></a>        <span class=bp>self</span><span class=o>.</span><span class=n>suite</span><span class=o>.</span><span class=n>save</span><span class=p>()</span>
</span><span id=__span-57-76><a id=__codelineno-57-76 name=__codelineno-57-76 href=#__codelineno-57-76></a>        <span class=bp>self</span><span class=o>.</span><span class=n>history</span><span class=o>.</span><span class=n>flush</span><span class=p>()</span>
</span></code></pre></div> <p><strong>Training Loop:</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-58-1><a id=__codelineno-58-1 name=__codelineno-58-1 href=#__codelineno-58-1></a><span class=n>agent</span> <span class=o>=</span> <span class=n>DQThresholdAgent</span><span class=p>(</span><span class=s2>&quot;suite.dql&quot;</span><span class=p>,</span> <span class=n>db_connection</span><span class=p>)</span>
</span><span id=__span-58-2><a id=__codelineno-58-2 name=__codelineno-58-2 href=#__codelineno-58-2></a>
</span><span id=__span-58-3><a id=__codelineno-58-3 name=__codelineno-58-3 href=#__codelineno-58-3></a><span class=k>for</span> <span class=n>episode</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1000</span><span class=p>):</span>
</span><span id=__span-58-4><a id=__codelineno-58-4 name=__codelineno-58-4 href=#__codelineno-58-4></a>    <span class=n>agent</span><span class=o>.</span><span class=n>episode</span> <span class=o>=</span> <span class=n>episode</span>
</span><span id=__span-58-5><a id=__codelineno-58-5 name=__codelineno-58-5 href=#__codelineno-58-5></a>    <span class=n>state</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>get_state</span><span class=p>()</span>
</span><span id=__span-58-6><a id=__codelineno-58-6 name=__codelineno-58-6 href=#__codelineno-58-6></a>
</span><span id=__span-58-7><a id=__codelineno-58-7 name=__codelineno-58-7 href=#__codelineno-58-7></a>    <span class=c1># RL policy selects threshold adjustments</span>
</span><span id=__span-58-8><a id=__codelineno-58-8 name=__codelineno-58-8 href=#__codelineno-58-8></a>    <span class=n>actions</span> <span class=o>=</span> <span class=n>policy</span><span class=o>.</span><span class=n>select_action</span><span class=p>(</span><span class=n>state</span><span class=p>)</span>
</span><span id=__span-58-9><a id=__codelineno-58-9 name=__codelineno-58-9 href=#__codelineno-58-9></a>    <span class=n>agent</span><span class=o>.</span><span class=n>apply_action</span><span class=p>(</span><span class=n>actions</span><span class=p>)</span>
</span><span id=__span-58-10><a id=__codelineno-58-10 name=__codelineno-58-10 href=#__codelineno-58-10></a>
</span><span id=__span-58-11><a id=__codelineno-58-11 name=__codelineno-58-11 href=#__codelineno-58-11></a>    <span class=c1># Run on historical date for training</span>
</span><span id=__span-58-12><a id=__codelineno-58-12 name=__codelineno-58-12 href=#__codelineno-58-12></a>    <span class=n>train_date</span> <span class=o>=</span> <span class=n>date</span><span class=o>.</span><span class=n>today</span><span class=p>()</span> <span class=o>-</span> <span class=n>timedelta</span><span class=p>(</span><span class=n>days</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>randint</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>90</span><span class=p>))</span>
</span><span id=__span-58-13><a id=__codelineno-58-13 name=__codelineno-58-13 href=#__codelineno-58-13></a>    <span class=n>results</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>run_and_observe</span><span class=p>(</span><span class=n>train_date</span><span class=p>)</span>
</span><span id=__span-58-14><a id=__codelineno-58-14 name=__codelineno-58-14 href=#__codelineno-58-14></a>
</span><span id=__span-58-15><a id=__codelineno-58-15 name=__codelineno-58-15 href=#__codelineno-58-15></a>    <span class=c1># Reward signal (with optional ground truth labels)</span>
</span><span id=__span-58-16><a id=__codelineno-58-16 name=__codelineno-58-16 href=#__codelineno-58-16></a>    <span class=n>reward</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>compute_reward</span><span class=p>(</span><span class=n>results</span><span class=p>,</span> <span class=n>labeled_data</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>train_date</span><span class=p>))</span>
</span><span id=__span-58-17><a id=__codelineno-58-17 name=__codelineno-58-17 href=#__codelineno-58-17></a>
</span><span id=__span-58-18><a id=__codelineno-58-18 name=__codelineno-58-18 href=#__codelineno-58-18></a>    <span class=c1># Policy gradient update</span>
</span><span id=__span-58-19><a id=__codelineno-58-19 name=__codelineno-58-19 href=#__codelineno-58-19></a>    <span class=n>next_state</span> <span class=o>=</span> <span class=n>agent</span><span class=o>.</span><span class=n>get_state</span><span class=p>()</span>
</span><span id=__span-58-20><a id=__codelineno-58-20 name=__codelineno-58-20 href=#__codelineno-58-20></a>    <span class=n>policy</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=n>state</span><span class=p>,</span> <span class=n>actions</span><span class=p>,</span> <span class=n>reward</span><span class=p>,</span> <span class=n>next_state</span><span class=p>)</span>
</span><span id=__span-58-21><a id=__codelineno-58-21 name=__codelineno-58-21 href=#__codelineno-58-21></a>
</span><span id=__span-58-22><a id=__codelineno-58-22 name=__codelineno-58-22 href=#__codelineno-58-22></a>    <span class=k>if</span> <span class=n>episode</span> <span class=o>%</span> <span class=mi>100</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-58-23><a id=__codelineno-58-23 name=__codelineno-58-23 href=#__codelineno-58-23></a>        <span class=n>agent</span><span class=o>.</span><span class=n>save</span><span class=p>()</span>
</span></code></pre></div> <p><strong>Key API Methods:</strong></p> <table> <thead> <tr> <th>Method</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td><code>Suite.load(path)</code></td> <td>Parse DQL file into manipulable object</td> </tr> <tr> <td><code>suite.get_tunable_params()</code></td> <td>List parameters with bounds for action space</td> </tr> <tr> <td><code>suite.set_param(name, value)</code></td> <td>Modify threshold (validates bounds)</td> </tr> <tr> <td><code>suite.get_param(name)</code></td> <td>Get current value of a parameter</td> </tr> <tr> <td><code>suite.get_param_history(name)</code></td> <td>Get change history for a parameter</td> </tr> <tr> <td><code>suite.run(db, date)</code></td> <td>Execute checks, return structured results</td> </tr> <tr> <td><code>suite.save()</code></td> <td>Persist changes back to <code>.dql</code> file</td> </tr> <tr> <td><code>History.log(entry)</code></td> <td>Append to <code>.dql.history</code> file</td> </tr> </tbody> </table> <p><strong>Profile-Aware Training:</strong></p> <p>Profiles apply multipliers to metrics during certain periods (holidays, promotions). The RL agent must account for this when training on historical data:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-59-1><a id=__codelineno-59-1 name=__codelineno-59-1 href=#__codelineno-59-1></a><span class=k>def</span><span class=w> </span><span class=nf>run_and_observe</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>target_date</span><span class=p>:</span> <span class=n>date</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
</span><span id=__span-59-2><a id=__codelineno-59-2 name=__codelineno-59-2 href=#__codelineno-59-2></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Execute checks with profile context.&quot;&quot;&quot;</span>
</span><span id=__span-59-3><a id=__codelineno-59-3 name=__codelineno-59-3 href=#__codelineno-59-3></a>    <span class=n>results</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>suite</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>db</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>db</span><span class=p>,</span> <span class=n>date</span><span class=o>=</span><span class=n>target_date</span><span class=p>)</span>
</span><span id=__span-59-4><a id=__codelineno-59-4 name=__codelineno-59-4 href=#__codelineno-59-4></a>
</span><span id=__span-59-5><a id=__codelineno-59-5 name=__codelineno-59-5 href=#__codelineno-59-5></a>    <span class=c1># Get active profiles for this date</span>
</span><span id=__span-59-6><a id=__codelineno-59-6 name=__codelineno-59-6 href=#__codelineno-59-6></a>    <span class=n>active_profiles</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>suite</span><span class=o>.</span><span class=n>get_active_profiles</span><span class=p>(</span><span class=n>target_date</span><span class=p>)</span>
</span><span id=__span-59-7><a id=__codelineno-59-7 name=__codelineno-59-7 href=#__codelineno-59-7></a>
</span><span id=__span-59-8><a id=__codelineno-59-8 name=__codelineno-59-8 href=#__codelineno-59-8></a>    <span class=k>return</span> <span class=p>{</span>
</span><span id=__span-59-9><a id=__codelineno-59-9 name=__codelineno-59-9 href=#__codelineno-59-9></a>        <span class=s2>&quot;assertions&quot;</span><span class=p>:</span> <span class=p>[</span><span class=o>...</span><span class=p>],</span>
</span><span id=__span-59-10><a id=__codelineno-59-10 name=__codelineno-59-10 href=#__codelineno-59-10></a>        <span class=s2>&quot;profiles&quot;</span><span class=p>:</span> <span class=p>[</span>
</span><span id=__span-59-11><a id=__codelineno-59-11 name=__codelineno-59-11 href=#__codelineno-59-11></a>            <span class=p>{</span><span class=s2>&quot;name&quot;</span><span class=p>:</span> <span class=n>p</span><span class=o>.</span><span class=n>name</span><span class=p>,</span> <span class=s2>&quot;multipliers&quot;</span><span class=p>:</span> <span class=n>p</span><span class=o>.</span><span class=n>get_multipliers</span><span class=p>()}</span>
</span><span id=__span-59-12><a id=__codelineno-59-12 name=__codelineno-59-12 href=#__codelineno-59-12></a>            <span class=k>for</span> <span class=n>p</span> <span class=ow>in</span> <span class=n>active_profiles</span>
</span><span id=__span-59-13><a id=__codelineno-59-13 name=__codelineno-59-13 href=#__codelineno-59-13></a>        <span class=p>],</span>
</span><span id=__span-59-14><a id=__codelineno-59-14 name=__codelineno-59-14 href=#__codelineno-59-14></a>        <span class=s2>&quot;is_special_period&quot;</span><span class=p>:</span> <span class=nb>len</span><span class=p>(</span><span class=n>active_profiles</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>,</span>
</span><span id=__span-59-15><a id=__codelineno-59-15 name=__codelineno-59-15 href=#__codelineno-59-15></a>    <span class=p>}</span>
</span></code></pre></div> <p><strong>Two training strategies:</strong></p> <table> <thead> <tr> <th>Strategy</th> <th>Description</th> <th>When to use</th> </tr> </thead> <tbody> <tr> <td><strong>Profile-aware</strong></td> <td>Include profile context in state, learn separate thresholds</td> <td>When profiles are stable and well-defined</td> </tr> <tr> <td><strong>Profile-excluded</strong></td> <td>Train only on non-profile dates</td> <td>When you want single robust threshold</td> </tr> </tbody> </table> <div class="language-python highlight"><pre><span></span><code><span id=__span-60-1><a id=__codelineno-60-1 name=__codelineno-60-1 href=#__codelineno-60-1></a><span class=c1># Strategy 1: Profile-aware state</span>
</span><span id=__span-60-2><a id=__codelineno-60-2 name=__codelineno-60-2 href=#__codelineno-60-2></a><span class=k>def</span><span class=w> </span><span class=nf>get_state</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>:</span>
</span><span id=__span-60-3><a id=__codelineno-60-3 name=__codelineno-60-3 href=#__codelineno-60-3></a>    <span class=n>params</span> <span class=o>=</span> <span class=p>[</span><span class=n>p</span><span class=o>.</span><span class=n>normalized_value</span> <span class=k>for</span> <span class=n>p</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>suite</span><span class=o>.</span><span class=n>get_tunable_params</span><span class=p>()]</span>
</span><span id=__span-60-4><a id=__codelineno-60-4 name=__codelineno-60-4 href=#__codelineno-60-4></a>
</span><span id=__span-60-5><a id=__codelineno-60-5 name=__codelineno-60-5 href=#__codelineno-60-5></a>    <span class=c1># Add profile indicators to state</span>
</span><span id=__span-60-6><a id=__codelineno-60-6 name=__codelineno-60-6 href=#__codelineno-60-6></a>    <span class=n>profile_active</span> <span class=o>=</span> <span class=p>[</span>
</span><span id=__span-60-7><a id=__codelineno-60-7 name=__codelineno-60-7 href=#__codelineno-60-7></a>        <span class=mf>1.0</span> <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>suite</span><span class=o>.</span><span class=n>is_profile_active</span><span class=p>(</span><span class=n>p</span><span class=o>.</span><span class=n>name</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>current_date</span><span class=p>)</span> <span class=k>else</span> <span class=mf>0.0</span>
</span><span id=__span-60-8><a id=__codelineno-60-8 name=__codelineno-60-8 href=#__codelineno-60-8></a>        <span class=k>for</span> <span class=n>p</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>suite</span><span class=o>.</span><span class=n>get_profiles</span><span class=p>()</span>
</span><span id=__span-60-9><a id=__codelineno-60-9 name=__codelineno-60-9 href=#__codelineno-60-9></a>    <span class=p>]</span>
</span><span id=__span-60-10><a id=__codelineno-60-10 name=__codelineno-60-10 href=#__codelineno-60-10></a>
</span><span id=__span-60-11><a id=__codelineno-60-11 name=__codelineno-60-11 href=#__codelineno-60-11></a>    <span class=k>return</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>params</span> <span class=o>+</span> <span class=n>profile_active</span><span class=p>)</span>
</span><span id=__span-60-12><a id=__codelineno-60-12 name=__codelineno-60-12 href=#__codelineno-60-12></a>
</span><span id=__span-60-13><a id=__codelineno-60-13 name=__codelineno-60-13 href=#__codelineno-60-13></a>
</span><span id=__span-60-14><a id=__codelineno-60-14 name=__codelineno-60-14 href=#__codelineno-60-14></a><span class=c1># Strategy 2: Exclude profile periods from training</span>
</span><span id=__span-60-15><a id=__codelineno-60-15 name=__codelineno-60-15 href=#__codelineno-60-15></a><span class=k>def</span><span class=w> </span><span class=nf>sample_training_date</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>date</span><span class=p>:</span>
</span><span id=__span-60-16><a id=__codelineno-60-16 name=__codelineno-60-16 href=#__codelineno-60-16></a>    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
</span><span id=__span-60-17><a id=__codelineno-60-17 name=__codelineno-60-17 href=#__codelineno-60-17></a>        <span class=n>d</span> <span class=o>=</span> <span class=n>date</span><span class=o>.</span><span class=n>today</span><span class=p>()</span> <span class=o>-</span> <span class=n>timedelta</span><span class=p>(</span><span class=n>days</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>random</span><span class=o>.</span><span class=n>randint</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>90</span><span class=p>))</span>
</span><span id=__span-60-18><a id=__codelineno-60-18 name=__codelineno-60-18 href=#__codelineno-60-18></a>        <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>suite</span><span class=o>.</span><span class=n>get_active_profiles</span><span class=p>(</span><span class=n>d</span><span class=p>):</span>
</span><span id=__span-60-19><a id=__codelineno-60-19 name=__codelineno-60-19 href=#__codelineno-60-19></a>            <span class=k>return</span> <span class=n>d</span>  <span class=c1># Only train on &quot;normal&quot; periods</span>
</span></code></pre></div> <p><strong>Profile multipliers in reward computation:</strong></p> <p>The interpreter applies multipliers before comparison, so the RL agent sees <em>post-multiplier</em> results. This is important:</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-61-1><a id=__codelineno-61-1 name=__codelineno-61-1 href=#__codelineno-61-1></a>check &quot;Volume&quot; on orders {
</span><span id=__span-61-2><a id=__codelineno-61-2 name=__codelineno-61-2 href=#__codelineno-61-2></a>    assert num_rows() &gt;= 1000
</span><span id=__span-61-3><a id=__codelineno-61-3 name=__codelineno-61-3 href=#__codelineno-61-3></a>        tags [volume]
</span><span id=__span-61-4><a id=__codelineno-61-4 name=__codelineno-61-4 href=#__codelineno-61-4></a>}
</span><span id=__span-61-5><a id=__codelineno-61-5 name=__codelineno-61-5 href=#__codelineno-61-5></a>
</span><span id=__span-61-6><a id=__codelineno-61-6 name=__codelineno-61-6 href=#__codelineno-61-6></a>profile &quot;Holiday&quot; {
</span><span id=__span-61-7><a id=__codelineno-61-7 name=__codelineno-61-7 href=#__codelineno-61-7></a>    type holiday
</span><span id=__span-61-8><a id=__codelineno-61-8 name=__codelineno-61-8 href=#__codelineno-61-8></a>    from 2024-12-20
</span><span id=__span-61-9><a id=__codelineno-61-9 name=__codelineno-61-9 href=#__codelineno-61-9></a>    to   2024-12-31
</span><span id=__span-61-10><a id=__codelineno-61-10 name=__codelineno-61-10 href=#__codelineno-61-10></a>    scale tag &quot;volume&quot; by 2.0x
</span><span id=__span-61-11><a id=__codelineno-61-11 name=__codelineno-61-11 href=#__codelineno-61-11></a>}
</span></code></pre></div> <div class="language-python highlight"><pre><span></span><code><span id=__span-62-1><a id=__codelineno-62-1 name=__codelineno-62-1 href=#__codelineno-62-1></a><span class=c1># On holiday: actual rows = 600</span>
</span><span id=__span-62-2><a id=__codelineno-62-2 name=__codelineno-62-2 href=#__codelineno-62-2></a><span class=c1># Multiplier 2.0x applied: 600 * 2.0 = 1200</span>
</span><span id=__span-62-3><a id=__codelineno-62-3 name=__codelineno-62-3 href=#__codelineno-62-3></a><span class=c1># Comparison: 1200 &gt;= 1000 → PASS</span>
</span><span id=__span-62-4><a id=__codelineno-62-4 name=__codelineno-62-4 href=#__codelineno-62-4></a>
</span><span id=__span-62-5><a id=__codelineno-62-5 name=__codelineno-62-5 href=#__codelineno-62-5></a><span class=c1># The agent sees:</span>
</span><span id=__span-62-6><a id=__codelineno-62-6 name=__codelineno-62-6 href=#__codelineno-62-6></a><span class=p>{</span>
</span><span id=__span-62-7><a id=__codelineno-62-7 name=__codelineno-62-7 href=#__codelineno-62-7></a>    <span class=s2>&quot;name&quot;</span><span class=p>:</span> <span class=s2>&quot;orders.volume.min_rows&quot;</span><span class=p>,</span>
</span><span id=__span-62-8><a id=__codelineno-62-8 name=__codelineno-62-8 href=#__codelineno-62-8></a>    <span class=s2>&quot;passed&quot;</span><span class=p>:</span> <span class=kc>True</span><span class=p>,</span>
</span><span id=__span-62-9><a id=__codelineno-62-9 name=__codelineno-62-9 href=#__codelineno-62-9></a>    <span class=s2>&quot;raw_value&quot;</span><span class=p>:</span> <span class=mi>600</span><span class=p>,</span>  <span class=c1># Before multiplier</span>
</span><span id=__span-62-10><a id=__codelineno-62-10 name=__codelineno-62-10 href=#__codelineno-62-10></a>    <span class=s2>&quot;scaled_value&quot;</span><span class=p>:</span> <span class=mi>1200</span><span class=p>,</span>  <span class=c1># After multiplier (used for comparison)</span>
</span><span id=__span-62-11><a id=__codelineno-62-11 name=__codelineno-62-11 href=#__codelineno-62-11></a>    <span class=s2>&quot;multiplier&quot;</span><span class=p>:</span> <span class=mf>2.0</span><span class=p>,</span>
</span><span id=__span-62-12><a id=__codelineno-62-12 name=__codelineno-62-12 href=#__codelineno-62-12></a>    <span class=s2>&quot;threshold&quot;</span><span class=p>:</span> <span class=mi>1000</span><span class=p>,</span>
</span><span id=__span-62-13><a id=__codelineno-62-13 name=__codelineno-62-13 href=#__codelineno-62-13></a><span class=p>}</span>
</span></code></pre></div> <p><strong>Implication:</strong> Thresholds are defined for "normal" periods. Profiles handle anomalous periods. The RL agent should optimize thresholds for normal conditions—profiles automatically adjust for special periods.</p> <p><strong>Human-in-the-Loop Integration:</strong></p> <p>The system supports multiple touchpoints for human oversight:</p> <table> <thead> <tr> <th>Touchpoint</th> <th>Purpose</th> <th>Frequency</th> </tr> </thead> <tbody> <tr> <td><strong>Review queue</strong></td> <td>Approve/reject algorithm proposals</td> <td>Before deployment</td> </tr> <tr> <td><strong>Ground truth labeling</strong></td> <td>Improve reward signal accuracy</td> <td>Periodic batch</td> </tr> <tr> <td><strong>Shadow mode</strong></td> <td>Test changes without affecting production</td> <td>Before promotion</td> </tr> <tr> <td><strong>Rollback</strong></td> <td>Revert bad changes</td> <td>On-demand</td> </tr> </tbody> </table> <p><strong>1. Ground Truth Labeling (False Positive Annotation):</strong></p> <p>When an assertion fails, humans label whether it was a real issue or false alarm:</p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-63-1><a id=__codelineno-63-1 name=__codelineno-63-1 href=#__codelineno-63-1></a><span class=c1># View recent failures needing review</span>
</span><span id=__span-63-2><a id=__codelineno-63-2 name=__codelineno-63-2 href=#__codelineno-63-2></a>dql<span class=w> </span>alerts<span class=w> </span>suite.dql<span class=w> </span>--unlabeled<span class=w> </span>--days<span class=w> </span><span class=m>7</span>
</span><span id=__span-63-3><a id=__codelineno-63-3 name=__codelineno-63-3 href=#__codelineno-63-3></a>
</span><span id=__span-63-4><a id=__codelineno-63-4 name=__codelineno-63-4 href=#__codelineno-63-4></a><span class=c1># DATE        ASSERTION                        VALUE    THRESHOLD  STATUS</span>
</span><span id=__span-63-5><a id=__codelineno-63-5 name=__codelineno-63-5 href=#__codelineno-63-5></a><span class=c1># 2024-12-20  orders.volume.min_rows           950      &gt;= 1000    FAIL</span>
</span><span id=__span-63-6><a id=__codelineno-63-6 name=__codelineno-63-6 href=#__codelineno-63-6></a><span class=c1># 2024-12-21  orders.completeness.email_null   6.2%     &lt; 5%       FAIL</span>
</span><span id=__span-63-7><a id=__codelineno-63-7 name=__codelineno-63-7 href=#__codelineno-63-7></a>
</span><span id=__span-63-8><a id=__codelineno-63-8 name=__codelineno-63-8 href=#__codelineno-63-8></a><span class=c1># Human investigates and labels</span>
</span><span id=__span-63-9><a id=__codelineno-63-9 name=__codelineno-63-9 href=#__codelineno-63-9></a>dql<span class=w> </span>label<span class=w> </span>suite.dql<span class=w> </span><span class=se>\</span>
</span><span id=__span-63-10><a id=__codelineno-63-10 name=__codelineno-63-10 href=#__codelineno-63-10></a><span class=w>    </span>--date<span class=w> </span><span class=m>2024</span>-12-20<span class=w> </span><span class=se>\</span>
</span><span id=__span-63-11><a id=__codelineno-63-11 name=__codelineno-63-11 href=#__codelineno-63-11></a><span class=w>    </span>--assertion<span class=w> </span><span class=s2>&quot;orders.volume.min_rows&quot;</span><span class=w> </span><span class=se>\</span>
</span><span id=__span-63-12><a id=__codelineno-63-12 name=__codelineno-63-12 href=#__codelineno-63-12></a><span class=w>    </span>--false-positive<span class=w> </span><span class=se>\</span>
</span><span id=__span-63-13><a id=__codelineno-63-13 name=__codelineno-63-13 href=#__codelineno-63-13></a><span class=w>    </span>--reason<span class=w> </span><span class=s2>&quot;Planned vendor maintenance&quot;</span>
</span></code></pre></div> <table> <thead> <tr> <th>Alert Status</th> <th><code>ground_truth</code></th> <th>Meaning</th> <th>RL Impact</th> </tr> </thead> <tbody> <tr> <td>FAIL</td> <td><code>true</code></td> <td>True positive (real issue)</td> <td>No penalty</td> </tr> <tr> <td>FAIL</td> <td><code>false</code></td> <td><strong>False positive</strong> (false alarm)</td> <td><code>-cost_fp</code> penalty</td> </tr> <tr> <td>PASS</td> <td><code>true</code></td> <td>False negative (missed issue)</td> <td><code>-cost_fn</code> penalty</td> </tr> <tr> <td>PASS</td> <td><code>false</code></td> <td>True negative (correct)</td> <td>No penalty</td> </tr> </tbody> </table> <p><strong>2. Review Queue for Proposed Changes:</strong></p> <div class="language-bash highlight"><pre><span></span><code><span id=__span-64-1><a id=__codelineno-64-1 name=__codelineno-64-1 href=#__codelineno-64-1></a><span class=c1># CLI for review workflow</span>
</span><span id=__span-64-2><a id=__codelineno-64-2 name=__codelineno-64-2 href=#__codelineno-64-2></a>dql<span class=w> </span>review<span class=w> </span>suite.dql<span class=w> </span>--pending<span class=w>              </span><span class=c1># List pending changes</span>
</span><span id=__span-64-3><a id=__codelineno-64-3 name=__codelineno-64-3 href=#__codelineno-64-3></a>dql<span class=w> </span>review<span class=w> </span>suite.dql<span class=w> </span>--approve<span class=w> </span>&lt;entry_id&gt;<span class=w>   </span><span class=c1># Approve change</span>
</span><span id=__span-64-4><a id=__codelineno-64-4 name=__codelineno-64-4 href=#__codelineno-64-4></a>dql<span class=w> </span>review<span class=w> </span>suite.dql<span class=w> </span>--reject<span class=w> </span>&lt;entry_id&gt;<span class=w> </span>--reason<span class=w> </span><span class=s2>&quot;too aggressive&quot;</span>
</span></code></pre></div> <p><strong>3. Staged Deployment:</strong></p> <div class="language-text highlight"><pre><span></span><code><span id=__span-65-1><a id=__codelineno-65-1 name=__codelineno-65-1 href=#__codelineno-65-1></a>┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
</span><span id=__span-65-2><a id=__codelineno-65-2 name=__codelineno-65-2 href=#__codelineno-65-2></a>│ RL Proposes │ ──▶ │   Pending   │ ──▶ │   Shadow    │ ──▶ │ Production  │
</span><span id=__span-65-3><a id=__codelineno-65-3 name=__codelineno-65-3 href=#__codelineno-65-3></a>│   Change    │     │   Review    │     │    Mode     │     │    Live     │
</span><span id=__span-65-4><a id=__codelineno-65-4 name=__codelineno-65-4 href=#__codelineno-65-4></a>└─────────────┘     └─────────────┘     └─────────────┘     └─────────────┘
</span><span id=__span-65-5><a id=__codelineno-65-5 name=__codelineno-65-5 href=#__codelineno-65-5></a>                          │                    │
</span><span id=__span-65-6><a id=__codelineno-65-6 name=__codelineno-65-6 href=#__codelineno-65-6></a>                     Human reviews        Runs in parallel,
</span><span id=__span-65-7><a id=__codelineno-65-7 name=__codelineno-65-7 href=#__codelineno-65-7></a>                     and approves         alerts logged but
</span><span id=__span-65-8><a id=__codelineno-65-8 name=__codelineno-65-8 href=#__codelineno-65-8></a>                                          not actioned
</span></code></pre></div> <div class="language-bash highlight"><pre><span></span><code><span id=__span-66-1><a id=__codelineno-66-1 name=__codelineno-66-1 href=#__codelineno-66-1></a><span class=c1># Shadow mode: run proposed thresholds alongside production</span>
</span><span id=__span-66-2><a id=__codelineno-66-2 name=__codelineno-66-2 href=#__codelineno-66-2></a>dql<span class=w> </span>run<span class=w> </span>suite.dql<span class=w> </span>--shadow<span class=w> </span>suite_proposed.dql<span class=w> </span>--date<span class=w> </span><span class=m>2024</span>-12-25
</span><span id=__span-66-3><a id=__codelineno-66-3 name=__codelineno-66-3 href=#__codelineno-66-3></a>
</span><span id=__span-66-4><a id=__codelineno-66-4 name=__codelineno-66-4 href=#__codelineno-66-4></a><span class=c1># Promote after validation</span>
</span><span id=__span-66-5><a id=__codelineno-66-5 name=__codelineno-66-5 href=#__codelineno-66-5></a>dql<span class=w> </span>promote<span class=w> </span>suite.dql<span class=w> </span>--assertion<span class=w> </span><span class=s2>&quot;orders.volume.dod_stability&quot;</span>
</span><span id=__span-66-6><a id=__codelineno-66-6 name=__codelineno-66-6 href=#__codelineno-66-6></a>
</span><span id=__span-66-7><a id=__codelineno-66-7 name=__codelineno-66-7 href=#__codelineno-66-7></a><span class=c1># Rollback if needed</span>
</span><span id=__span-66-8><a id=__codelineno-66-8 name=__codelineno-66-8 href=#__codelineno-66-8></a>dql<span class=w> </span>rollback<span class=w> </span>suite.dql<span class=w> </span>--to<span class=w> </span><span class=m>2024</span>-12-15
</span></code></pre></div> <p><strong>4. Annotation for Human Review:</strong></p> <div class="language-text highlight"><pre><span></span><code><span id=__span-67-1><a id=__codelineno-67-1 name=__codelineno-67-1 href=#__codelineno-67-1></a>check &quot;Critical&quot; on orders {
</span><span id=__span-67-2><a id=__codelineno-67-2 name=__codelineno-67-2 href=#__codelineno-67-2></a>    @required
</span><span id=__span-67-3><a id=__codelineno-67-3 name=__codelineno-67-3 href=#__codelineno-67-3></a>    @human_review                    # Any change requires approval
</span><span id=__span-67-4><a id=__codelineno-67-4 name=__codelineno-67-4 href=#__codelineno-67-4></a>    assert null_count(customer_id) == 0
</span><span id=__span-67-5><a id=__codelineno-67-5 name=__codelineno-67-5 href=#__codelineno-67-5></a>        name &quot;orders.critical.customer_id&quot;
</span><span id=__span-67-6><a id=__codelineno-67-6 name=__codelineno-67-6 href=#__codelineno-67-6></a>        severity P0
</span><span id=__span-67-7><a id=__codelineno-67-7 name=__codelineno-67-7 href=#__codelineno-67-7></a>}
</span></code></pre></div> <table> <thead> <tr> <th>Annotation</th> <th>Behavior</th> </tr> </thead> <tbody> <tr> <td><code>@human_review</code></td> <td>Threshold changes go to review queue</td> </tr> <tr> <td><code>@auto_approve</code></td> <td>Algorithm changes apply immediately (low-risk)</td> </tr> </tbody> </table> <p><strong>Multi-Checkpoint Joint Training:</strong></p> <p>DQX checks data at multiple points in the system. Joint RL training optimizes across all checkpoints by learning correlations from historical data — no explicit DAG required:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-68-1><a id=__codelineno-68-1 name=__codelineno-68-1 href=#__codelineno-68-1></a><span class=k>class</span><span class=w> </span><span class=nc>JointTrainingAgent</span><span class=p>:</span>
</span><span id=__span-68-2><a id=__codelineno-68-2 name=__codelineno-68-2 href=#__codelineno-68-2></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;RL agent that learns correlations across checkpoints.&quot;&quot;&quot;</span>
</span><span id=__span-68-3><a id=__codelineno-68-3 name=__codelineno-68-3 href=#__codelineno-68-3></a>
</span><span id=__span-68-4><a id=__codelineno-68-4 name=__codelineno-68-4 href=#__codelineno-68-4></a>    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>suites</span><span class=p>:</span> <span class=nb>list</span><span class=p>[</span><span class=nb>str</span><span class=p>],</span> <span class=n>db</span><span class=p>):</span>
</span><span id=__span-68-5><a id=__codelineno-68-5 name=__codelineno-68-5 href=#__codelineno-68-5></a>        <span class=bp>self</span><span class=o>.</span><span class=n>suites</span> <span class=o>=</span> <span class=p>{</span><span class=n>s</span><span class=p>:</span> <span class=n>Suite</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=n>s</span><span class=p>)</span> <span class=k>for</span> <span class=n>s</span> <span class=ow>in</span> <span class=n>suites</span><span class=p>}</span>
</span><span id=__span-68-6><a id=__codelineno-68-6 name=__codelineno-68-6 href=#__codelineno-68-6></a>
</span><span id=__span-68-7><a id=__codelineno-68-7 name=__codelineno-68-7 href=#__codelineno-68-7></a>    <span class=k>def</span><span class=w> </span><span class=nf>learn_correlations</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>days</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>90</span><span class=p>):</span>
</span><span id=__span-68-8><a id=__codelineno-68-8 name=__codelineno-68-8 href=#__codelineno-68-8></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Discover correlations from historical co-failures.&quot;&quot;&quot;</span>
</span><span id=__span-68-9><a id=__codelineno-68-9 name=__codelineno-68-9 href=#__codelineno-68-9></a>        <span class=n>history</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>db</span><span class=o>.</span><span class=n>query</span><span class=p>(</span>
</span><span id=__span-68-10><a id=__codelineno-68-10 name=__codelineno-68-10 href=#__codelineno-68-10></a><span class=w>            </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-68-11><a id=__codelineno-68-11 name=__codelineno-68-11 href=#__codelineno-68-11></a><span class=sd>            SELECT date, assertion_name, passed FROM dql_results</span>
</span><span id=__span-68-12><a id=__codelineno-68-12 name=__codelineno-68-12 href=#__codelineno-68-12></a><span class=sd>            WHERE date &gt; current_date - interval &#39;{days} days&#39;</span>
</span><span id=__span-68-13><a id=__codelineno-68-13 name=__codelineno-68-13 href=#__codelineno-68-13></a><span class=sd>        &quot;&quot;&quot;</span>
</span><span id=__span-68-14><a id=__codelineno-68-14 name=__codelineno-68-14 href=#__codelineno-68-14></a>        <span class=p>)</span>
</span><span id=__span-68-15><a id=__codelineno-68-15 name=__codelineno-68-15 href=#__codelineno-68-15></a>        <span class=n>failure_matrix</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>pivot_failures</span><span class=p>(</span><span class=n>history</span><span class=p>)</span>
</span><span id=__span-68-16><a id=__codelineno-68-16 name=__codelineno-68-16 href=#__codelineno-68-16></a>        <span class=bp>self</span><span class=o>.</span><span class=n>correlation_matrix</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>corrcoef</span><span class=p>(</span><span class=n>failure_matrix</span><span class=o>.</span><span class=n>T</span><span class=p>)</span>
</span><span id=__span-68-17><a id=__codelineno-68-17 name=__codelineno-68-17 href=#__codelineno-68-17></a>
</span><span id=__span-68-18><a id=__codelineno-68-18 name=__codelineno-68-18 href=#__codelineno-68-18></a>    <span class=k>def</span><span class=w> </span><span class=nf>get_state</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>:</span>
</span><span id=__span-68-19><a id=__codelineno-68-19 name=__codelineno-68-19 href=#__codelineno-68-19></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Combined state from all checkpoints.&quot;&quot;&quot;</span>
</span><span id=__span-68-20><a id=__codelineno-68-20 name=__codelineno-68-20 href=#__codelineno-68-20></a>        <span class=n>params</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-68-21><a id=__codelineno-68-21 name=__codelineno-68-21 href=#__codelineno-68-21></a>        <span class=k>for</span> <span class=n>suite</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>suites</span><span class=o>.</span><span class=n>values</span><span class=p>():</span>
</span><span id=__span-68-22><a id=__codelineno-68-22 name=__codelineno-68-22 href=#__codelineno-68-22></a>            <span class=n>params</span><span class=o>.</span><span class=n>extend</span><span class=p>([</span><span class=n>p</span><span class=o>.</span><span class=n>normalized_value</span> <span class=k>for</span> <span class=n>p</span> <span class=ow>in</span> <span class=n>suite</span><span class=o>.</span><span class=n>get_tunable_params</span><span class=p>()])</span>
</span><span id=__span-68-23><a id=__codelineno-68-23 name=__codelineno-68-23 href=#__codelineno-68-23></a>        <span class=k>return</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>params</span><span class=p>)</span>
</span><span id=__span-68-24><a id=__codelineno-68-24 name=__codelineno-68-24 href=#__codelineno-68-24></a>
</span><span id=__span-68-25><a id=__codelineno-68-25 name=__codelineno-68-25 href=#__codelineno-68-25></a>    <span class=k>def</span><span class=w> </span><span class=nf>compute_reward</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>results</span><span class=p>:</span> <span class=nb>dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>float</span><span class=p>:</span>
</span><span id=__span-68-26><a id=__codelineno-68-26 name=__codelineno-68-26 href=#__codelineno-68-26></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Reward considers learned correlations.&quot;&quot;&quot;</span>
</span><span id=__span-68-27><a id=__codelineno-68-27 name=__codelineno-68-27 href=#__codelineno-68-27></a>        <span class=n>reward</span> <span class=o>=</span> <span class=mf>0.0</span>
</span><span id=__span-68-28><a id=__codelineno-68-28 name=__codelineno-68-28 href=#__codelineno-68-28></a>        <span class=k>for</span> <span class=n>a</span> <span class=ow>in</span> <span class=n>results</span><span class=p>[</span><span class=s2>&quot;assertions&quot;</span><span class=p>]:</span>
</span><span id=__span-68-29><a id=__codelineno-68-29 name=__codelineno-68-29 href=#__codelineno-68-29></a>            <span class=k>if</span> <span class=ow>not</span> <span class=n>a</span><span class=p>[</span><span class=s2>&quot;passed&quot;</span><span class=p>]</span> <span class=ow>and</span> <span class=n>a</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;is_fp&quot;</span><span class=p>):</span>
</span><span id=__span-68-30><a id=__codelineno-68-30 name=__codelineno-68-30 href=#__codelineno-68-30></a>                <span class=n>reward</span> <span class=o>-=</span> <span class=n>a</span><span class=p>[</span><span class=s2>&quot;cost&quot;</span><span class=p>][</span><span class=s2>&quot;false_positive&quot;</span><span class=p>]</span>
</span><span id=__span-68-31><a id=__codelineno-68-31 name=__codelineno-68-31 href=#__codelineno-68-31></a>            <span class=c1># Bonus for catching correlated failures early</span>
</span><span id=__span-68-32><a id=__codelineno-68-32 name=__codelineno-68-32 href=#__codelineno-68-32></a>            <span class=k>for</span> <span class=n>corr_name</span><span class=p>,</span> <span class=n>strength</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_correlated</span><span class=p>(</span><span class=n>a</span><span class=p>[</span><span class=s2>&quot;name&quot;</span><span class=p>]):</span>
</span><span id=__span-68-33><a id=__codelineno-68-33 name=__codelineno-68-33 href=#__codelineno-68-33></a>                <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>also_failed</span><span class=p>(</span><span class=n>results</span><span class=p>,</span> <span class=n>corr_name</span><span class=p>):</span>
</span><span id=__span-68-34><a id=__codelineno-68-34 name=__codelineno-68-34 href=#__codelineno-68-34></a>                    <span class=n>reward</span> <span class=o>+=</span> <span class=mi>5</span> <span class=o>*</span> <span class=n>strength</span>
</span><span id=__span-68-35><a id=__codelineno-68-35 name=__codelineno-68-35 href=#__codelineno-68-35></a>        <span class=k>return</span> <span class=n>reward</span>
</span></code></pre></div> <p><strong>Key insight:</strong> Correlations are learned from failure patterns, not declared. The system discovers relationships automatically.</p> <p><strong>Handling Partial Observations:</strong></p> <p>In real systems, when one component fails, downstream checks often don't run:</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-69-1><a id=__codelineno-69-1 name=__codelineno-69-1 href=#__codelineno-69-1></a>Day 1: [ingestion ✓] → [transform ✓] → [serving ✓]    # Full run
</span><span id=__span-69-2><a id=__codelineno-69-2 name=__codelineno-69-2 href=#__codelineno-69-2></a>Day 2: [ingestion ✗] → [transform ?] → [serving ?]    # Stopped early
</span><span id=__span-69-3><a id=__codelineno-69-3 name=__codelineno-69-3 href=#__codelineno-69-3></a>Day 3: [ingestion ✓] → [transform ✗] → [serving ?]    # Partial run
</span></code></pre></div> <p><strong>Solution 1: Run Status as Signal</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-70-1><a id=__codelineno-70-1 name=__codelineno-70-1 href=#__codelineno-70-1></a><span class=k>def</span><span class=w> </span><span class=nf>run_and_observe</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>target_date</span><span class=p>:</span> <span class=n>date</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>dict</span><span class=p>:</span>
</span><span id=__span-70-2><a id=__codelineno-70-2 name=__codelineno-70-2 href=#__codelineno-70-2></a>    <span class=n>results</span> <span class=o>=</span> <span class=p>{</span><span class=s2>&quot;assertions&quot;</span><span class=p>:</span> <span class=p>[],</span> <span class=s2>&quot;run_status&quot;</span><span class=p>:</span> <span class=p>{}}</span>
</span><span id=__span-70-3><a id=__codelineno-70-3 name=__codelineno-70-3 href=#__codelineno-70-3></a>    <span class=k>for</span> <span class=n>name</span><span class=p>,</span> <span class=n>suite</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>suites</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span><span id=__span-70-4><a id=__codelineno-70-4 name=__codelineno-70-4 href=#__codelineno-70-4></a>        <span class=k>try</span><span class=p>:</span>
</span><span id=__span-70-5><a id=__codelineno-70-5 name=__codelineno-70-5 href=#__codelineno-70-5></a>            <span class=n>result</span> <span class=o>=</span> <span class=n>suite</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>db</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>db</span><span class=p>,</span> <span class=n>date</span><span class=o>=</span><span class=n>target_date</span><span class=p>)</span>
</span><span id=__span-70-6><a id=__codelineno-70-6 name=__codelineno-70-6 href=#__codelineno-70-6></a>            <span class=n>results</span><span class=p>[</span><span class=s2>&quot;assertions&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>extend</span><span class=p>(</span><span class=n>result</span><span class=o>.</span><span class=n>assertions</span><span class=p>)</span>
</span><span id=__span-70-7><a id=__codelineno-70-7 name=__codelineno-70-7 href=#__codelineno-70-7></a>            <span class=n>results</span><span class=p>[</span><span class=s2>&quot;run_status&quot;</span><span class=p>][</span><span class=n>name</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;completed&quot;</span>
</span><span id=__span-70-8><a id=__codelineno-70-8 name=__codelineno-70-8 href=#__codelineno-70-8></a>        <span class=k>except</span> <span class=n>UpstreamFailure</span><span class=p>:</span>
</span><span id=__span-70-9><a id=__codelineno-70-9 name=__codelineno-70-9 href=#__codelineno-70-9></a>            <span class=n>results</span><span class=p>[</span><span class=s2>&quot;run_status&quot;</span><span class=p>][</span><span class=n>name</span><span class=p>]</span> <span class=o>=</span> <span class=s2>&quot;skipped&quot;</span>
</span><span id=__span-70-10><a id=__codelineno-70-10 name=__codelineno-70-10 href=#__codelineno-70-10></a>    <span class=k>return</span> <span class=n>results</span>
</span><span id=__span-70-11><a id=__codelineno-70-11 name=__codelineno-70-11 href=#__codelineno-70-11></a>
</span><span id=__span-70-12><a id=__codelineno-70-12 name=__codelineno-70-12 href=#__codelineno-70-12></a>
</span><span id=__span-70-13><a id=__codelineno-70-13 name=__codelineno-70-13 href=#__codelineno-70-13></a><span class=k>def</span><span class=w> </span><span class=nf>get_state</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>np</span><span class=o>.</span><span class=n>ndarray</span><span class=p>:</span>
</span><span id=__span-70-14><a id=__codelineno-70-14 name=__codelineno-70-14 href=#__codelineno-70-14></a>    <span class=n>params</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>get_threshold_params</span><span class=p>()</span>
</span><span id=__span-70-15><a id=__codelineno-70-15 name=__codelineno-70-15 href=#__codelineno-70-15></a>    <span class=n>run_mask</span> <span class=o>=</span> <span class=p>[</span><span class=mf>1.0</span> <span class=k>if</span> <span class=n>s</span> <span class=o>==</span> <span class=s2>&quot;completed&quot;</span> <span class=k>else</span> <span class=mf>0.0</span> <span class=k>for</span> <span class=n>s</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>run_status</span><span class=o>.</span><span class=n>values</span><span class=p>()]</span>
</span><span id=__span-70-16><a id=__codelineno-70-16 name=__codelineno-70-16 href=#__codelineno-70-16></a>    <span class=k>return</span> <span class=n>np</span><span class=o>.</span><span class=n>concatenate</span><span class=p>([</span><span class=n>params</span><span class=p>,</span> <span class=n>run_mask</span><span class=p>])</span>
</span></code></pre></div> <p><strong>Solution 2: Per-Checkpoint Training</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-71-1><a id=__codelineno-71-1 name=__codelineno-71-1 href=#__codelineno-71-1></a><span class=k>class</span><span class=w> </span><span class=nc>PerCheckpointAgents</span><span class=p>:</span>
</span><span id=__span-71-2><a id=__codelineno-71-2 name=__codelineno-71-2 href=#__codelineno-71-2></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Each checkpoint trains independently on days it ran.&quot;&quot;&quot;</span>
</span><span id=__span-71-3><a id=__codelineno-71-3 name=__codelineno-71-3 href=#__codelineno-71-3></a>
</span><span id=__span-71-4><a id=__codelineno-71-4 name=__codelineno-71-4 href=#__codelineno-71-4></a>    <span class=k>def</span><span class=w> </span><span class=nf>train_episode</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>target_date</span><span class=p>:</span> <span class=n>date</span><span class=p>):</span>
</span><span id=__span-71-5><a id=__codelineno-71-5 name=__codelineno-71-5 href=#__codelineno-71-5></a>        <span class=k>for</span> <span class=n>name</span><span class=p>,</span> <span class=n>agent</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>agents</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span><span id=__span-71-6><a id=__codelineno-71-6 name=__codelineno-71-6 href=#__codelineno-71-6></a>            <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>did_run</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>target_date</span><span class=p>):</span>
</span><span id=__span-71-7><a id=__codelineno-71-7 name=__codelineno-71-7 href=#__codelineno-71-7></a>                <span class=n>agent</span><span class=o>.</span><span class=n>train_step</span><span class=p>(</span><span class=n>target_date</span><span class=p>)</span>
</span></code></pre></div> <p><strong>Solution 3: Reward Shaping for Early Stops</strong></p> <div class="language-python highlight"><pre><span></span><code><span id=__span-72-1><a id=__codelineno-72-1 name=__codelineno-72-1 href=#__codelineno-72-1></a><span class=k>def</span><span class=w> </span><span class=nf>compute_reward</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>results</span><span class=p>:</span> <span class=nb>dict</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>float</span><span class=p>:</span>
</span><span id=__span-72-2><a id=__codelineno-72-2 name=__codelineno-72-2 href=#__codelineno-72-2></a>    <span class=n>reward</span> <span class=o>=</span> <span class=mf>0.0</span>
</span><span id=__span-72-3><a id=__codelineno-72-3 name=__codelineno-72-3 href=#__codelineno-72-3></a>    <span class=k>for</span> <span class=n>name</span><span class=p>,</span> <span class=n>status</span> <span class=ow>in</span> <span class=n>results</span><span class=p>[</span><span class=s2>&quot;run_status&quot;</span><span class=p>]</span><span class=o>.</span><span class=n>items</span><span class=p>():</span>
</span><span id=__span-72-4><a id=__codelineno-72-4 name=__codelineno-72-4 href=#__codelineno-72-4></a>        <span class=k>if</span> <span class=n>status</span> <span class=o>==</span> <span class=s2>&quot;completed&quot;</span><span class=p>:</span>
</span><span id=__span-72-5><a id=__codelineno-72-5 name=__codelineno-72-5 href=#__codelineno-72-5></a>            <span class=n>reward</span> <span class=o>+=</span> <span class=bp>self</span><span class=o>.</span><span class=n>assertion_rewards</span><span class=p>(</span><span class=n>results</span><span class=p>,</span> <span class=n>name</span><span class=p>)</span>
</span><span id=__span-72-6><a id=__codelineno-72-6 name=__codelineno-72-6 href=#__codelineno-72-6></a>        <span class=k>elif</span> <span class=n>status</span> <span class=o>==</span> <span class=s2>&quot;skipped&quot;</span><span class=p>:</span>
</span><span id=__span-72-7><a id=__codelineno-72-7 name=__codelineno-72-7 href=#__codelineno-72-7></a>            <span class=n>reward</span> <span class=o>+=</span> <span class=mi>5</span>  <span class=c1># Bonus: upstream caught issue early</span>
</span><span id=__span-72-8><a id=__codelineno-72-8 name=__codelineno-72-8 href=#__codelineno-72-8></a>    <span class=k>return</span> <span class=n>reward</span>
</span></code></pre></div> <table> <thead> <tr> <th>Approach</th> <th>When to use</th> </tr> </thead> <tbody> <tr> <td><strong>Run status as signal</strong></td> <td>Simple, works with existing data</td> </tr> <tr> <td><strong>Per-checkpoint agents</strong></td> <td>Loosely coupled checkpoints</td> </tr> <tr> <td><strong>Reward shaping</strong></td> <td>Always — "skipped" = early detection</td> </tr> </tbody> </table> <p><strong>Key insight:</strong> "Skipped because upstream failed" is valuable signal — catching issues early is the desired behavior.</p> <h3 id=architecture>Architecture<a class=headerlink href=#architecture title="Anchor link to this section for reference">&para;</a></h3> <p>The interpreter walks the AST and calls DQX APIs directly:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-73-1><a id=__codelineno-73-1 name=__codelineno-73-1 href=#__codelineno-73-1></a><span class=kn>import</span><span class=w> </span><span class=nn>sympy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>sp</span>
</span><span id=__span-73-2><a id=__codelineno-73-2 name=__codelineno-73-2 href=#__codelineno-73-2></a>
</span><span id=__span-73-3><a id=__codelineno-73-3 name=__codelineno-73-3 href=#__codelineno-73-3></a>
</span><span id=__span-73-4><a id=__codelineno-73-4 name=__codelineno-73-4 href=#__codelineno-73-4></a><span class=k>class</span><span class=w> </span><span class=nc>Interpreter</span><span class=p>:</span>
</span><span id=__span-73-5><a id=__codelineno-73-5 name=__codelineno-73-5 href=#__codelineno-73-5></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Executes DQL AST against DQX runtime.&quot;&quot;&quot;</span>
</span><span id=__span-73-6><a id=__codelineno-73-6 name=__codelineno-73-6 href=#__codelineno-73-6></a>
</span><span id=__span-73-7><a id=__codelineno-73-7 name=__codelineno-73-7 href=#__codelineno-73-7></a>    <span class=c1># Whitelisted sympy functions</span>
</span><span id=__span-73-8><a id=__codelineno-73-8 name=__codelineno-73-8 href=#__codelineno-73-8></a>    <span class=n>MATH_FUNCTIONS</span> <span class=o>=</span> <span class=p>{</span>
</span><span id=__span-73-9><a id=__codelineno-73-9 name=__codelineno-73-9 href=#__codelineno-73-9></a>        <span class=s2>&quot;abs&quot;</span><span class=p>:</span> <span class=n>sp</span><span class=o>.</span><span class=n>Abs</span><span class=p>,</span>
</span><span id=__span-73-10><a id=__codelineno-73-10 name=__codelineno-73-10 href=#__codelineno-73-10></a>        <span class=s2>&quot;sqrt&quot;</span><span class=p>:</span> <span class=n>sp</span><span class=o>.</span><span class=n>sqrt</span><span class=p>,</span>
</span><span id=__span-73-11><a id=__codelineno-73-11 name=__codelineno-73-11 href=#__codelineno-73-11></a>        <span class=s2>&quot;log&quot;</span><span class=p>:</span> <span class=n>sp</span><span class=o>.</span><span class=n>log</span><span class=p>,</span>
</span><span id=__span-73-12><a id=__codelineno-73-12 name=__codelineno-73-12 href=#__codelineno-73-12></a>        <span class=s2>&quot;exp&quot;</span><span class=p>:</span> <span class=n>sp</span><span class=o>.</span><span class=n>exp</span><span class=p>,</span>
</span><span id=__span-73-13><a id=__codelineno-73-13 name=__codelineno-73-13 href=#__codelineno-73-13></a>        <span class=s2>&quot;min&quot;</span><span class=p>:</span> <span class=n>sp</span><span class=o>.</span><span class=n>Min</span><span class=p>,</span>
</span><span id=__span-73-14><a id=__codelineno-73-14 name=__codelineno-73-14 href=#__codelineno-73-14></a>        <span class=s2>&quot;max&quot;</span><span class=p>:</span> <span class=n>sp</span><span class=o>.</span><span class=n>Max</span><span class=p>,</span>
</span><span id=__span-73-15><a id=__codelineno-73-15 name=__codelineno-73-15 href=#__codelineno-73-15></a>    <span class=p>}</span>
</span><span id=__span-73-16><a id=__codelineno-73-16 name=__codelineno-73-16 href=#__codelineno-73-16></a>
</span><span id=__span-73-17><a id=__codelineno-73-17 name=__codelineno-73-17 href=#__codelineno-73-17></a>    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>db</span><span class=p>:</span> <span class=n>Database</span><span class=p>,</span> <span class=n>target_date</span><span class=p>:</span> <span class=n>date</span><span class=p>):</span>
</span><span id=__span-73-18><a id=__codelineno-73-18 name=__codelineno-73-18 href=#__codelineno-73-18></a>        <span class=bp>self</span><span class=o>.</span><span class=n>db</span> <span class=o>=</span> <span class=n>db</span>
</span><span id=__span-73-19><a id=__codelineno-73-19 name=__codelineno-73-19 href=#__codelineno-73-19></a>        <span class=bp>self</span><span class=o>.</span><span class=n>target_date</span> <span class=o>=</span> <span class=n>target_date</span>
</span><span id=__span-73-20><a id=__codelineno-73-20 name=__codelineno-73-20 href=#__codelineno-73-20></a>        <span class=bp>self</span><span class=o>.</span><span class=n>provider</span> <span class=o>=</span> <span class=n>MetricProvider</span><span class=p>(</span><span class=n>db</span><span class=p>)</span>
</span><span id=__span-73-21><a id=__codelineno-73-21 name=__codelineno-73-21 href=#__codelineno-73-21></a>        <span class=bp>self</span><span class=o>.</span><span class=n>tunables</span><span class=p>:</span> <span class=nb>dict</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>Any</span><span class=p>]</span> <span class=o>=</span> <span class=p>{}</span>
</span><span id=__span-73-22><a id=__codelineno-73-22 name=__codelineno-73-22 href=#__codelineno-73-22></a>
</span><span id=__span-73-23><a id=__codelineno-73-23 name=__codelineno-73-23 href=#__codelineno-73-23></a>    <span class=k>def</span><span class=w> </span><span class=nf>eval_metric_expr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>expr_str</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>sp</span><span class=o>.</span><span class=n>Expr</span><span class=p>:</span>
</span><span id=__span-73-24><a id=__codelineno-73-24 name=__codelineno-73-24 href=#__codelineno-73-24></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;Parse metric expression using sympy.&quot;&quot;&quot;</span>
</span><span id=__span-73-25><a id=__codelineno-73-25 name=__codelineno-73-25 href=#__codelineno-73-25></a>        <span class=n>namespace</span> <span class=o>=</span> <span class=p>{</span><span class=o>**</span><span class=bp>self</span><span class=o>.</span><span class=n>MATH_FUNCTIONS</span><span class=p>}</span>
</span><span id=__span-73-26><a id=__codelineno-73-26 name=__codelineno-73-26 href=#__codelineno-73-26></a>
</span><span id=__span-73-27><a id=__codelineno-73-27 name=__codelineno-73-27 href=#__codelineno-73-27></a>        <span class=c1># Add metric functions that call provider methods</span>
</span><span id=__span-73-28><a id=__codelineno-73-28 name=__codelineno-73-28 href=#__codelineno-73-28></a>        <span class=k>for</span> <span class=n>name</span> <span class=ow>in</span> <span class=p>[</span><span class=s2>&quot;num_rows&quot;</span><span class=p>,</span> <span class=s2>&quot;average&quot;</span><span class=p>,</span> <span class=s2>&quot;sum&quot;</span><span class=p>,</span> <span class=s2>&quot;null_count&quot;</span><span class=p>,</span> <span class=o>...</span><span class=p>]:</span>
</span><span id=__span-73-29><a id=__codelineno-73-29 name=__codelineno-73-29 href=#__codelineno-73-29></a>            <span class=n>namespace</span><span class=p>[</span><span class=n>name</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_metric_wrapper</span><span class=p>(</span><span class=n>name</span><span class=p>)</span>
</span><span id=__span-73-30><a id=__codelineno-73-30 name=__codelineno-73-30 href=#__codelineno-73-30></a>
</span><span id=__span-73-31><a id=__codelineno-73-31 name=__codelineno-73-31 href=#__codelineno-73-31></a>        <span class=k>return</span> <span class=n>sp</span><span class=o>.</span><span class=n>sympify</span><span class=p>(</span><span class=n>expr_str</span><span class=p>,</span> <span class=nb>locals</span><span class=o>=</span><span class=n>namespace</span><span class=p>,</span> <span class=n>evaluate</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
</span><span id=__span-73-32><a id=__codelineno-73-32 name=__codelineno-73-32 href=#__codelineno-73-32></a>
</span><span id=__span-73-33><a id=__codelineno-73-33 name=__codelineno-73-33 href=#__codelineno-73-33></a>    <span class=k>def</span><span class=w> </span><span class=nf>run</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>ast</span><span class=p>:</span> <span class=n>SuiteNode</span><span class=p>,</span> <span class=n>datasources</span><span class=p>:</span> <span class=nb>list</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>list</span><span class=p>[</span><span class=n>Result</span><span class=p>]:</span>
</span><span id=__span-73-34><a id=__codelineno-73-34 name=__codelineno-73-34 href=#__codelineno-73-34></a>        <span class=n>suite</span> <span class=o>=</span> <span class=n>VerificationSuite</span><span class=p>(</span><span class=n>ast</span><span class=o>.</span><span class=n>name</span><span class=p>,</span> <span class=n>db</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>db</span><span class=p>)</span>
</span><span id=__span-73-35><a id=__codelineno-73-35 name=__codelineno-73-35 href=#__codelineno-73-35></a>        <span class=n>suite</span><span class=o>.</span><span class=n>data_av_threshold</span> <span class=o>=</span> <span class=n>ast</span><span class=o>.</span><span class=n>threshold</span>
</span><span id=__span-73-36><a id=__codelineno-73-36 name=__codelineno-73-36 href=#__codelineno-73-36></a>
</span><span id=__span-73-37><a id=__codelineno-73-37 name=__codelineno-73-37 href=#__codelineno-73-37></a>        <span class=c1># Register tunables</span>
</span><span id=__span-73-38><a id=__codelineno-73-38 name=__codelineno-73-38 href=#__codelineno-73-38></a>        <span class=k>for</span> <span class=n>tunable</span> <span class=ow>in</span> <span class=n>ast</span><span class=o>.</span><span class=n>tunables</span><span class=p>:</span>
</span><span id=__span-73-39><a id=__codelineno-73-39 name=__codelineno-73-39 href=#__codelineno-73-39></a>            <span class=bp>self</span><span class=o>.</span><span class=n>tunables</span><span class=p>[</span><span class=n>tunable</span><span class=o>.</span><span class=n>name</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>eval_expr</span><span class=p>(</span><span class=n>tunable</span><span class=o>.</span><span class=n>value</span><span class=p>)</span>
</span><span id=__span-73-40><a id=__codelineno-73-40 name=__codelineno-73-40 href=#__codelineno-73-40></a>
</span><span id=__span-73-41><a id=__codelineno-73-41 name=__codelineno-73-41 href=#__codelineno-73-41></a>        <span class=c1># Build checks</span>
</span><span id=__span-73-42><a id=__codelineno-73-42 name=__codelineno-73-42 href=#__codelineno-73-42></a>        <span class=k>for</span> <span class=n>check_node</span> <span class=ow>in</span> <span class=n>ast</span><span class=o>.</span><span class=n>checks</span><span class=p>:</span>
</span><span id=__span-73-43><a id=__codelineno-73-43 name=__codelineno-73-43 href=#__codelineno-73-43></a>            <span class=n>check</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>build_check</span><span class=p>(</span><span class=n>check_node</span><span class=p>)</span>
</span><span id=__span-73-44><a id=__codelineno-73-44 name=__codelineno-73-44 href=#__codelineno-73-44></a>            <span class=n>suite</span><span class=o>.</span><span class=n>add_check</span><span class=p>(</span><span class=n>check</span><span class=p>,</span> <span class=n>datasets</span><span class=o>=</span><span class=n>check_node</span><span class=o>.</span><span class=n>datasets</span><span class=p>)</span>
</span><span id=__span-73-45><a id=__codelineno-73-45 name=__codelineno-73-45 href=#__codelineno-73-45></a>
</span><span id=__span-73-46><a id=__codelineno-73-46 name=__codelineno-73-46 href=#__codelineno-73-46></a>        <span class=c1># Add profiles</span>
</span><span id=__span-73-47><a id=__codelineno-73-47 name=__codelineno-73-47 href=#__codelineno-73-47></a>        <span class=k>for</span> <span class=n>profile_node</span> <span class=ow>in</span> <span class=n>ast</span><span class=o>.</span><span class=n>profiles</span><span class=p>:</span>
</span><span id=__span-73-48><a id=__codelineno-73-48 name=__codelineno-73-48 href=#__codelineno-73-48></a>            <span class=n>suite</span><span class=o>.</span><span class=n>add_profile</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>build_profile</span><span class=p>(</span><span class=n>profile_node</span><span class=p>))</span>
</span><span id=__span-73-49><a id=__codelineno-73-49 name=__codelineno-73-49 href=#__codelineno-73-49></a>
</span><span id=__span-73-50><a id=__codelineno-73-50 name=__codelineno-73-50 href=#__codelineno-73-50></a>        <span class=c1># Execute</span>
</span><span id=__span-73-51><a id=__codelineno-73-51 name=__codelineno-73-51 href=#__codelineno-73-51></a>        <span class=n>key</span> <span class=o>=</span> <span class=n>ResultKey</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>target_date</span><span class=p>,</span> <span class=n>tags</span><span class=o>=</span><span class=p>{})</span>
</span><span id=__span-73-52><a id=__codelineno-73-52 name=__codelineno-73-52 href=#__codelineno-73-52></a>        <span class=n>suite</span><span class=o>.</span><span class=n>run</span><span class=p>(</span><span class=n>datasources</span><span class=p>,</span> <span class=n>key</span><span class=p>)</span>
</span><span id=__span-73-53><a id=__codelineno-73-53 name=__codelineno-73-53 href=#__codelineno-73-53></a>        <span class=k>return</span> <span class=n>suite</span><span class=o>.</span><span class=n>collect_results</span><span class=p>()</span>
</span></code></pre></div> <p>The interpreter owns the sympy namespace. When it parses <code>abs(day_over_day(average(price)))</code>: 1. <code>abs</code> resolves to <code>sp.Abs</code> from <code>MATH_FUNCTIONS</code> 2. <code>day_over_day</code>, <code>average</code> resolve to provider method wrappers 3. <code>sympify()</code> builds the expression tree</p> <h3 id=runtime-errors>Runtime Errors<a class=headerlink href=#runtime-errors title="Anchor link to this section for reference">&para;</a></h3> <p>The interpreter reports errors with source location:</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-74-1><a id=__codelineno-74-1 name=__codelineno-74-1 href=#__codelineno-74-1></a>error: assertion failed
</span><span id=__span-74-2><a id=__codelineno-74-2 name=__codelineno-74-2 href=#__codelineno-74-2></a>  --&gt; suite.dql:15:9
</span><span id=__span-74-3><a id=__codelineno-74-3 name=__codelineno-74-3 href=#__codelineno-74-3></a>   |
</span><span id=__span-74-4><a id=__codelineno-74-4 name=__codelineno-74-4 href=#__codelineno-74-4></a>15 |     assert null_count(customer_id) == 0  severity P0
</span><span id=__span-74-5><a id=__codelineno-74-5 name=__codelineno-74-5 href=#__codelineno-74-5></a>   |            ^^^^^^^^^^^^^^^^^^^^^^^^^
</span><span id=__span-74-6><a id=__codelineno-74-6 name=__codelineno-74-6 href=#__codelineno-74-6></a>   |
</span><span id=__span-74-7><a id=__codelineno-74-7 name=__codelineno-74-7 href=#__codelineno-74-7></a>   = metric value: 42
</span><span id=__span-74-8><a id=__codelineno-74-8 name=__codelineno-74-8 href=#__codelineno-74-8></a>   = expected: == 0
</span><span id=__span-74-9><a id=__codelineno-74-9 name=__codelineno-74-9 href=#__codelineno-74-9></a>   = dataset: orders
</span><span id=__span-74-10><a id=__codelineno-74-10 name=__codelineno-74-10 href=#__codelineno-74-10></a>   = date: 2024-12-25
</span></code></pre></div> <h2 id=error-messages>Error Messages<a class=headerlink href=#error-messages title="Anchor link to this section for reference">&para;</a></h2> <p>The interpreter reports errors with file location and context:</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-75-1><a id=__codelineno-75-1 name=__codelineno-75-1 href=#__codelineno-75-1></a>error[E001]: unknown metric &#39;avg&#39;
</span><span id=__span-75-2><a id=__codelineno-75-2 name=__codelineno-75-2 href=#__codelineno-75-2></a>  --&gt; suite.dql:12:16
</span><span id=__span-75-3><a id=__codelineno-75-3 name=__codelineno-75-3 href=#__codelineno-75-3></a>   |
</span><span id=__span-75-4><a id=__codelineno-75-4 name=__codelineno-75-4 href=#__codelineno-75-4></a>12 |     assert avg(price) &gt; 0
</span><span id=__span-75-5><a id=__codelineno-75-5 name=__codelineno-75-5 href=#__codelineno-75-5></a>   |            ^^^ did you mean &#39;average&#39;?
</span><span id=__span-75-6><a id=__codelineno-75-6 name=__codelineno-75-6 href=#__codelineno-75-6></a>
</span><span id=__span-75-7><a id=__codelineno-75-7 name=__codelineno-75-7 href=#__codelineno-75-7></a>error[E002]: duplicate assertion name
</span><span id=__span-75-8><a id=__codelineno-75-8 name=__codelineno-75-8 href=#__codelineno-75-8></a>  --&gt; suite.dql:18:9
</span><span id=__span-75-9><a id=__codelineno-75-9 name=__codelineno-75-9 href=#__codelineno-75-9></a>   |
</span><span id=__span-75-10><a id=__codelineno-75-10 name=__codelineno-75-10 href=#__codelineno-75-10></a>14 |         name &quot;Order count&quot;
</span><span id=__span-75-11><a id=__codelineno-75-11 name=__codelineno-75-11 href=#__codelineno-75-11></a>   |              -------------- first defined here
</span><span id=__span-75-12><a id=__codelineno-75-12 name=__codelineno-75-12 href=#__codelineno-75-12></a>18 |         name &quot;Order count&quot;
</span><span id=__span-75-13><a id=__codelineno-75-13 name=__codelineno-75-13 href=#__codelineno-75-13></a>   |              ^^^^^^^^^^^^^^ duplicate
</span></code></pre></div> <p>Warning for unnamed assertions:</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-76-1><a id=__codelineno-76-1 name=__codelineno-76-1 href=#__codelineno-76-1></a>warning[W001]: assertion has no name
</span><span id=__span-76-2><a id=__codelineno-76-2 name=__codelineno-76-2 href=#__codelineno-76-2></a>  --&gt; suite.dql:22:5
</span><span id=__span-76-3><a id=__codelineno-76-3 name=__codelineno-76-3 href=#__codelineno-76-3></a>   |
</span><span id=__span-76-4><a id=__codelineno-76-4 name=__codelineno-76-4 href=#__codelineno-76-4></a>22 |     assert num_rows() &gt; 0
</span><span id=__span-76-5><a id=__codelineno-76-5 name=__codelineno-76-5 href=#__codelineno-76-5></a>   |     ^^^^^^^^^^^^^^^^^^^^^ consider adding a descriptive name
</span></code></pre></div> <h2 id=grammar-reference>Grammar Reference<a class=headerlink href=#grammar-reference title="Anchor link to this section for reference">&para;</a></h2> <div class="language-ebnf highlight"><pre><span></span><code><span id=__span-77-1><a id=__codelineno-77-1 name=__codelineno-77-1 href=#__codelineno-77-1></a><span class=cm>(* === Top-level === *)</span>
</span><span id=__span-77-2><a id=__codelineno-77-2 name=__codelineno-77-2 href=#__codelineno-77-2></a><span class=k>suite       </span><span class=o>=</span> <span class=s2>&quot;suite&quot;</span> <span class=k>STRING </span><span class=s2>&quot;{&quot;</span> <span class=k>suite_body </span><span class=s2>&quot;}&quot;</span>
</span><span id=__span-77-3><a id=__codelineno-77-3 name=__codelineno-77-3 href=#__codelineno-77-3></a><span class=k>suite_body  </span><span class=err>=</span> <span class=p>(</span><span class=k>metadata </span><span class=p>|</span> <span class=k>tunable </span><span class=p>|</span> <span class=k>check </span><span class=p>|</span> <span class=k>profile</span><span class=p>)</span><span class=err>*</span>
</span><span id=__span-77-4><a id=__codelineno-77-4 name=__codelineno-77-4 href=#__codelineno-77-4></a>
</span><span id=__span-77-5><a id=__codelineno-77-5 name=__codelineno-77-5 href=#__codelineno-77-5></a><span class=k>metadata    </span><span class=err>=</span> <span class=s2>&quot;availability_threshold&quot;</span> <span class=k>PERCENT</span>
</span><span id=__span-77-6><a id=__codelineno-77-6 name=__codelineno-77-6 href=#__codelineno-77-6></a>
</span><span id=__span-77-7><a id=__codelineno-77-7 name=__codelineno-77-7 href=#__codelineno-77-7></a><span class=cm>(* === Tunables === *)</span>
</span><span id=__span-77-8><a id=__codelineno-77-8 name=__codelineno-77-8 href=#__codelineno-77-8></a><span class=k>tunable     </span><span class=err>=</span> <span class=s2>&quot;tunable&quot;</span> <span class=k>IDENT </span><span class=s2>&quot;=&quot;</span> <span class=k>expr </span><span class=s2>&quot;bounds&quot;</span> <span class=s2>&quot;[&quot;</span> <span class=k>expr </span><span class=s2>&quot;,&quot;</span> <span class=k>expr </span><span class=s2>&quot;]&quot;</span>
</span><span id=__span-77-9><a id=__codelineno-77-9 name=__codelineno-77-9 href=#__codelineno-77-9></a>
</span><span id=__span-77-10><a id=__codelineno-77-10 name=__codelineno-77-10 href=#__codelineno-77-10></a><span class=cm>(* === Checks and Assertions === *)</span>
</span><span id=__span-77-11><a id=__codelineno-77-11 name=__codelineno-77-11 href=#__codelineno-77-11></a><span class=k>check       </span><span class=err>=</span> <span class=s2>&quot;check&quot;</span> <span class=k>STRING </span><span class=s2>&quot;on&quot;</span> <span class=k>datasets </span><span class=s2>&quot;{&quot;</span> <span class=k>assertion</span><span class=err>+</span> <span class=s2>&quot;}&quot;</span>
</span><span id=__span-77-12><a id=__codelineno-77-12 name=__codelineno-77-12 href=#__codelineno-77-12></a><span class=k>datasets    </span><span class=err>=</span> <span class=k>ident </span><span class=p>(</span><span class=s2>&quot;,&quot;</span> <span class=k>ident</span><span class=p>)</span><span class=err>*</span>
</span><span id=__span-77-13><a id=__codelineno-77-13 name=__codelineno-77-13 href=#__codelineno-77-13></a>
</span><span id=__span-77-14><a id=__codelineno-77-14 name=__codelineno-77-14 href=#__codelineno-77-14></a><span class=k>annotation  </span><span class=err>=</span> <span class=s2>&quot;@&quot;</span> <span class=k>IDENT </span><span class=p>[</span><span class=s2>&quot;(&quot;</span> <span class=k>ann_args </span><span class=s2>&quot;)&quot;</span><span class=p>]</span>
</span><span id=__span-77-15><a id=__codelineno-77-15 name=__codelineno-77-15 href=#__codelineno-77-15></a><span class=k>ann_args    </span><span class=err>=</span> <span class=k>IDENT </span><span class=s2>&quot;=&quot;</span> <span class=p>(</span><span class=k>NUMBER </span><span class=p>|</span> <span class=k>STRING</span><span class=p>)</span> <span class=p>(</span><span class=s2>&quot;,&quot;</span> <span class=k>IDENT </span><span class=s2>&quot;=&quot;</span> <span class=p>(</span><span class=k>NUMBER </span><span class=p>|</span> <span class=k>STRING</span><span class=p>))</span><span class=err>*</span>
</span><span id=__span-77-16><a id=__codelineno-77-16 name=__codelineno-77-16 href=#__codelineno-77-16></a>
</span><span id=__span-77-17><a id=__codelineno-77-17 name=__codelineno-77-17 href=#__codelineno-77-17></a><span class=k>assertion   </span><span class=err>=</span> <span class=k>annotation</span><span class=err>*</span> <span class=s2>&quot;assert&quot;</span> <span class=k>expr condition modifiers</span><span class=err>*</span>
</span><span id=__span-77-18><a id=__codelineno-77-18 name=__codelineno-77-18 href=#__codelineno-77-18></a><span class=k>condition   </span><span class=err>=</span> <span class=k>comparison </span><span class=p>|</span> <span class=s2>&quot;between&quot;</span> <span class=k>bound </span><span class=s2>&quot;and&quot;</span> <span class=k>bound </span><span class=p>|</span> <span class=s2>&quot;is&quot;</span> <span class=k>keyword</span>
</span><span id=__span-77-19><a id=__codelineno-77-19 name=__codelineno-77-19 href=#__codelineno-77-19></a><span class=k>comparison  </span><span class=err>=</span> <span class=p>(</span><span class=s2>&quot;&lt;&quot;</span> <span class=p>|</span> <span class=s2>&quot;&lt;=&quot;</span> <span class=p>|</span> <span class=s2>&quot;&gt;&quot;</span> <span class=p>|</span> <span class=s2>&quot;&gt;=&quot;</span> <span class=p>|</span> <span class=s2>&quot;==&quot;</span> <span class=p>|</span> <span class=s2>&quot;!=&quot;</span><span class=p>)</span> <span class=k>expr</span>
</span><span id=__span-77-20><a id=__codelineno-77-20 name=__codelineno-77-20 href=#__codelineno-77-20></a><span class=k>bound       </span><span class=err>=</span> <span class=k>bound_term </span><span class=p>((</span><span class=s2>&quot;*&quot;</span><span class=p>|</span><span class=s2>&quot;/&quot;</span><span class=p>)</span> <span class=k>bound_term</span><span class=p>)</span><span class=err>*</span>   <span class=cm>(* restricted to avoid &#39;and&#39; ambiguity *)</span>
</span><span id=__span-77-21><a id=__codelineno-77-21 name=__codelineno-77-21 href=#__codelineno-77-21></a><span class=k>bound_term  </span><span class=err>=</span> <span class=k>NUMBER </span><span class=p>|</span> <span class=k>PERCENT </span><span class=p>|</span> <span class=k>ident </span><span class=p>|</span> <span class=k>call</span>
</span><span id=__span-77-22><a id=__codelineno-77-22 name=__codelineno-77-22 href=#__codelineno-77-22></a><span class=k>keyword     </span><span class=err>=</span> <span class=s2>&quot;positive&quot;</span> <span class=p>|</span> <span class=s2>&quot;negative&quot;</span> <span class=p>|</span> <span class=s2>&quot;None&quot;</span> <span class=p>|</span> <span class=s2>&quot;not&quot;</span> <span class=s2>&quot;None&quot;</span>
</span><span id=__span-77-23><a id=__codelineno-77-23 name=__codelineno-77-23 href=#__codelineno-77-23></a><span class=k>modifiers   </span><span class=err>=</span> <span class=k>name </span><span class=p>|</span> <span class=k>tolerance </span><span class=p>|</span> <span class=k>severity </span><span class=p>|</span> <span class=k>tags </span><span class=p>|</span> <span class=k>sample</span>
</span><span id=__span-77-24><a id=__codelineno-77-24 name=__codelineno-77-24 href=#__codelineno-77-24></a><span class=k>name        </span><span class=err>=</span> <span class=s2>&quot;name&quot;</span> <span class=k>STRING</span>
</span><span id=__span-77-25><a id=__codelineno-77-25 name=__codelineno-77-25 href=#__codelineno-77-25></a><span class=k>tolerance   </span><span class=err>=</span> <span class=p>(</span><span class=s2>&quot;tolerance&quot;</span> <span class=p>|</span> <span class=s2>&quot;+/-&quot;</span> <span class=p>|</span> <span class=s2>&quot;±&quot;</span><span class=p>)</span> <span class=k>NUMBER</span>
</span><span id=__span-77-26><a id=__codelineno-77-26 name=__codelineno-77-26 href=#__codelineno-77-26></a><span class=k>severity    </span><span class=err>=</span> <span class=s2>&quot;severity&quot;</span> <span class=k>SEVERITY</span>
</span><span id=__span-77-27><a id=__codelineno-77-27 name=__codelineno-77-27 href=#__codelineno-77-27></a><span class=k>tags        </span><span class=err>=</span> <span class=s2>&quot;tags&quot;</span> <span class=s2>&quot;[&quot;</span> <span class=k>IDENT </span><span class=p>(</span><span class=s2>&quot;,&quot;</span> <span class=k>IDENT</span><span class=p>)</span><span class=err>*</span> <span class=s2>&quot;]&quot;</span>
</span><span id=__span-77-28><a id=__codelineno-77-28 name=__codelineno-77-28 href=#__codelineno-77-28></a><span class=k>sample      </span><span class=err>=</span> <span class=s2>&quot;sample&quot;</span> <span class=p>(</span><span class=k>PERCENT </span><span class=p>|</span> <span class=k>NUMBER </span><span class=s2>&quot;rows&quot;</span><span class=p>)</span> <span class=p>[</span><span class=s2>&quot;seed&quot;</span> <span class=k>NUMBER</span><span class=p>]</span>
</span><span id=__span-77-29><a id=__codelineno-77-29 name=__codelineno-77-29 href=#__codelineno-77-29></a>
</span><span id=__span-77-30><a id=__codelineno-77-30 name=__codelineno-77-30 href=#__codelineno-77-30></a><span class=cm>(* === Expressions === *)</span>
</span><span id=__span-77-31><a id=__codelineno-77-31 name=__codelineno-77-31 href=#__codelineno-77-31></a><span class=k>expr        </span><span class=err>=</span> <span class=k>term </span><span class=p>((</span><span class=s2>&quot;+&quot;</span><span class=p>|</span><span class=s2>&quot;-&quot;</span><span class=p>)</span> <span class=k>term</span><span class=p>)</span><span class=err>*</span>
</span><span id=__span-77-32><a id=__codelineno-77-32 name=__codelineno-77-32 href=#__codelineno-77-32></a><span class=k>term        </span><span class=err>=</span> <span class=k>factor </span><span class=p>((</span><span class=s2>&quot;*&quot;</span><span class=p>|</span><span class=s2>&quot;/&quot;</span><span class=p>)</span> <span class=k>factor</span><span class=p>)</span><span class=err>*</span>
</span><span id=__span-77-33><a id=__codelineno-77-33 name=__codelineno-77-33 href=#__codelineno-77-33></a><span class=k>factor      </span><span class=err>=</span> <span class=s2>&quot;-&quot;</span> <span class=k>factor </span><span class=p>|</span> <span class=k>NUMBER </span><span class=p>|</span> <span class=k>PERCENT </span><span class=p>|</span> <span class=k>call </span><span class=p>|</span> <span class=s2>&quot;(&quot;</span> <span class=k>expr </span><span class=s2>&quot;)&quot;</span> <span class=p>|</span> <span class=k>ident </span><span class=p>|</span> <span class=s2>&quot;None&quot;</span> <span class=p>|</span> <span class=k>STRING</span>
</span><span id=__span-77-34><a id=__codelineno-77-34 name=__codelineno-77-34 href=#__codelineno-77-34></a><span class=k>call        </span><span class=err>=</span> <span class=k>qualified_ident </span><span class=s2>&quot;(&quot;</span> <span class=p>[</span><span class=k>args</span><span class=p>]</span> <span class=s2>&quot;)&quot;</span>
</span><span id=__span-77-35><a id=__codelineno-77-35 name=__codelineno-77-35 href=#__codelineno-77-35></a><span class=k>args        </span><span class=err>=</span> <span class=k>arg </span><span class=p>(</span><span class=s2>&quot;,&quot;</span> <span class=k>arg</span><span class=p>)</span><span class=err>*</span>
</span><span id=__span-77-36><a id=__codelineno-77-36 name=__codelineno-77-36 href=#__codelineno-77-36></a><span class=k>arg         </span><span class=err>=</span> <span class=k>named_arg </span><span class=p>|</span> <span class=k>list_arg </span><span class=p>|</span> <span class=k>expr</span>
</span><span id=__span-77-37><a id=__codelineno-77-37 name=__codelineno-77-37 href=#__codelineno-77-37></a><span class=k>named_arg   </span><span class=err>=</span> <span class=s2>&quot;lag&quot;</span> <span class=s2>&quot;=&quot;</span> <span class=k>NUMBER </span><span class=p>|</span> <span class=s2>&quot;dataset&quot;</span> <span class=s2>&quot;=&quot;</span> <span class=k>ident </span><span class=p>|</span> <span class=s2>&quot;order_by&quot;</span> <span class=s2>&quot;=&quot;</span> <span class=k>ident </span><span class=p>|</span> <span class=s2>&quot;n&quot;</span> <span class=s2>&quot;=&quot;</span> <span class=k>NUMBER</span>
</span><span id=__span-77-38><a id=__codelineno-77-38 name=__codelineno-77-38 href=#__codelineno-77-38></a><span class=k>list_arg    </span><span class=err>=</span> <span class=s2>&quot;[&quot;</span> <span class=k>ident </span><span class=p>(</span><span class=s2>&quot;,&quot;</span> <span class=k>ident</span><span class=p>)</span><span class=err>*</span> <span class=s2>&quot;]&quot;</span>
</span><span id=__span-77-39><a id=__codelineno-77-39 name=__codelineno-77-39 href=#__codelineno-77-39></a><span class=k>qualified_ident </span><span class=err>=</span> <span class=k>IDENT </span><span class=p>(</span><span class=s2>&quot;.&quot;</span> <span class=k>IDENT</span><span class=p>)</span><span class=err>*</span>
</span><span id=__span-77-40><a id=__codelineno-77-40 name=__codelineno-77-40 href=#__codelineno-77-40></a>
</span><span id=__span-77-41><a id=__codelineno-77-41 name=__codelineno-77-41 href=#__codelineno-77-41></a><span class=cm>(* === Profiles === *)</span>
</span><span id=__span-77-42><a id=__codelineno-77-42 name=__codelineno-77-42 href=#__codelineno-77-42></a><span class=k>profile     </span><span class=err>=</span> <span class=s2>&quot;profile&quot;</span> <span class=k>STRING </span><span class=s2>&quot;{&quot;</span> <span class=k>profile_body </span><span class=s2>&quot;}&quot;</span>
</span><span id=__span-77-43><a id=__codelineno-77-43 name=__codelineno-77-43 href=#__codelineno-77-43></a><span class=k>profile_body</span><span class=err>=</span> <span class=s2>&quot;type&quot;</span> <span class=k>IDENT </span><span class=s2>&quot;from&quot;</span> <span class=k>date_expr </span><span class=s2>&quot;to&quot;</span> <span class=k>date_expr rule</span><span class=err>*</span>
</span><span id=__span-77-44><a id=__codelineno-77-44 name=__codelineno-77-44 href=#__codelineno-77-44></a><span class=k>date_expr   </span><span class=err>=</span> <span class=k>DATE </span><span class=p>|</span> <span class=k>date_func </span><span class=p>|</span> <span class=k>date_expr </span><span class=p>(</span><span class=s2>&quot;+&quot;</span> <span class=p>|</span> <span class=s2>&quot;-&quot;</span><span class=p>)</span> <span class=k>NUMBER</span>
</span><span id=__span-77-45><a id=__codelineno-77-45 name=__codelineno-77-45 href=#__codelineno-77-45></a><span class=k>date_func   </span><span class=err>=</span> <span class=k>IDENT </span><span class=s2>&quot;(&quot;</span> <span class=p>[</span><span class=k>date_args</span><span class=p>]</span> <span class=s2>&quot;)&quot;</span>
</span><span id=__span-77-46><a id=__codelineno-77-46 name=__codelineno-77-46 href=#__codelineno-77-46></a><span class=k>date_args   </span><span class=err>=</span> <span class=p>(</span><span class=k>IDENT </span><span class=p>|</span> <span class=k>NUMBER</span><span class=p>)</span> <span class=p>(</span><span class=s2>&quot;,&quot;</span> <span class=p>(</span><span class=k>IDENT </span><span class=p>|</span> <span class=k>NUMBER</span><span class=p>))</span><span class=err>*</span>
</span><span id=__span-77-47><a id=__codelineno-77-47 name=__codelineno-77-47 href=#__codelineno-77-47></a><span class=k>rule        </span><span class=err>=</span> <span class=k>disable </span><span class=p>|</span> <span class=k>scale </span><span class=p>|</span> <span class=k>set_severity</span>
</span><span id=__span-77-48><a id=__codelineno-77-48 name=__codelineno-77-48 href=#__codelineno-77-48></a><span class=k>disable     </span><span class=err>=</span> <span class=s2>&quot;disable&quot;</span> <span class=p>(</span><span class=s2>&quot;check&quot;</span> <span class=k>STRING </span><span class=p>|</span> <span class=s2>&quot;assertion&quot;</span> <span class=k>STRING </span><span class=s2>&quot;in&quot;</span> <span class=k>STRING</span><span class=p>)</span>
</span><span id=__span-77-49><a id=__codelineno-77-49 name=__codelineno-77-49 href=#__codelineno-77-49></a><span class=k>scale       </span><span class=err>=</span> <span class=s2>&quot;scale&quot;</span> <span class=k>selector </span><span class=s2>&quot;by&quot;</span> <span class=k>NUMBER </span><span class=s2>&quot;x&quot;</span>
</span><span id=__span-77-50><a id=__codelineno-77-50 name=__codelineno-77-50 href=#__codelineno-77-50></a><span class=k>set_severity</span><span class=err>=</span> <span class=s2>&quot;set&quot;</span> <span class=k>selector </span><span class=s2>&quot;severity&quot;</span> <span class=k>SEVERITY</span>
</span><span id=__span-77-51><a id=__codelineno-77-51 name=__codelineno-77-51 href=#__codelineno-77-51></a><span class=k>selector    </span><span class=err>=</span> <span class=s2>&quot;check&quot;</span> <span class=k>STRING </span><span class=p>|</span> <span class=s2>&quot;tag&quot;</span> <span class=k>STRING</span>
</span><span id=__span-77-52><a id=__codelineno-77-52 name=__codelineno-77-52 href=#__codelineno-77-52></a>
</span><span id=__span-77-53><a id=__codelineno-77-53 name=__codelineno-77-53 href=#__codelineno-77-53></a><span class=cm>(* === Tokens === *)</span>
</span><span id=__span-77-54><a id=__codelineno-77-54 name=__codelineno-77-54 href=#__codelineno-77-54></a><span class=k>STRING      </span><span class=err>=</span> <span class=s1>&#39;&quot;&#39;</span> <span class=p>(</span><span class=k>ESC </span><span class=p>|</span> <span class=p>[</span><span class=err>^</span><span class=s2>&quot;\\])* &#39;&quot;</span><span class=s1>&#39;</span>
</span><span id=__span-77-55><a id=__codelineno-77-55 name=__codelineno-77-55 href=#__codelineno-77-55></a><span class=s1>ESC         = &#39;</span><span class=err>\\</span><span class=s1>&#39; [&quot;\\nrt]           (* \&quot; \\ \n \r \t *)</span>
</span><span id=__span-77-56><a id=__codelineno-77-56 name=__codelineno-77-56 href=#__codelineno-77-56></a><span class=s1>NUMBER      = [0-9]+ (&#39;</span><span class=p>.</span><span class=err>&#39;</span> <span class=err>[0-9]+)?</span>
</span><span id=__span-77-57><a id=__codelineno-77-57 name=__codelineno-77-57 href=#__codelineno-77-57></a><span class=k>PERCENT     </span><span class=o>=</span> <span class=k>NUMBER </span><span class=s1>&#39;%&#39;</span>
</span><span id=__span-77-58><a id=__codelineno-77-58 name=__codelineno-77-58 href=#__codelineno-77-58></a><span class=k>DATE        </span><span class=err>=</span> <span class=p>[</span><span class=err>0</span><span class=o>-</span><span class=err>9</span><span class=p>]{</span><span class=err>4</span><span class=p>}</span> <span class=s1>&#39;-&#39;</span> <span class=p>[</span><span class=err>0</span><span class=o>-</span><span class=err>9</span><span class=p>]{</span><span class=err>2</span><span class=p>}</span> <span class=s1>&#39;-&#39;</span> <span class=p>[</span><span class=err>0</span><span class=o>-</span><span class=err>9</span><span class=p>]{</span><span class=err>2</span><span class=p>}</span>
</span><span id=__span-77-59><a id=__codelineno-77-59 name=__codelineno-77-59 href=#__codelineno-77-59></a><span class=k>SEVERITY    </span><span class=err>=</span> <span class=s1>&#39;P0&#39;</span> <span class=p>|</span> <span class=s1>&#39;P1&#39;</span> <span class=p>|</span> <span class=s1>&#39;P2&#39;</span> <span class=p>|</span> <span class=s1>&#39;P3&#39;</span>
</span><span id=__span-77-60><a id=__codelineno-77-60 name=__codelineno-77-60 href=#__codelineno-77-60></a><span class=k>IDENT       </span><span class=err>=</span> <span class=p>[</span><span class=k>a-zA-Z_</span><span class=p>]</span> <span class=p>[</span><span class=k>a-zA-Z0-9_</span><span class=p>]</span><span class=err>*</span>
</span><span id=__span-77-61><a id=__codelineno-77-61 name=__codelineno-77-61 href=#__codelineno-77-61></a><span class=k>ident       </span><span class=err>=</span> <span class=k>IDENT </span><span class=p>|</span> <span class=s1>&#39;`&#39;</span> <span class=p>[</span><span class=err>^`</span><span class=p>]</span><span class=err>+</span> <span class=s1>&#39;`&#39;</span>           <span class=cm>(* backticks escape reserved words *)</span>
</span><span id=__span-77-62><a id=__codelineno-77-62 name=__codelineno-77-62 href=#__codelineno-77-62></a><span class=k>COMMENT     </span><span class=err>=</span> <span class=s1>&#39;#&#39;</span> <span class=p>[</span><span class=err>^\</span><span class=k>n</span><span class=p>]</span><span class=err>*</span>                  <span class=cm>(* Python-style comments *)</span>
</span></code></pre></div> <h3 id=grammar-notes>Grammar Notes<a class=headerlink href=#grammar-notes title="Anchor link to this section for reference">&para;</a></h3> <p><strong>Named arguments:</strong> Function arguments use specific keywords (<code>lag</code>, <code>dataset</code>, <code>order_by</code>, <code>n</code>) rather than arbitrary identifiers to avoid parser ambiguity.</p> <p><strong>Between bounds:</strong> The <code>between A and B</code> condition restricts bounds to simple expressions (numbers, percentages, identifiers, function calls, and <code>*</code>/<code>/</code> operators). Full arithmetic with <code>+</code>/<code>-</code> would conflict with the <code>and</code> keyword. Use parenthesized comparisons for complex bounds: <code>&gt;= (A + B)</code>.</p> <p><strong>Annotation values:</strong> Annotation arguments accept only NUMBER or STRING values, not full expressions.</p> <h3 id=reserved-words>Reserved Words<a class=headerlink href=#reserved-words title="Anchor link to this section for reference">&para;</a></h3> <p>The following are reserved: <code>suite</code>, <code>check</code>, <code>assert</code>, <code>on</code>, <code>from</code>, <code>to</code>, <code>by</code>, <code>in</code>, <code>and</code>, <code>is</code>, <code>between</code>, <code>profile</code>, <code>type</code>, <code>tunable</code>, <code>bounds</code>, <code>name</code>, <code>severity</code>, <code>tags</code>, <code>tolerance</code>, <code>scale</code>, <code>disable</code>, <code>set</code>, <code>sample</code>, <code>seed</code>, <code>rows</code>, <code>lag</code>, <code>dataset</code>, <code>order_by</code>, <code>n</code>.</p> <p>Use backticks to escape column or dataset names that conflict:</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-78-1><a id=__codelineno-78-1 name=__codelineno-78-1 href=#__codelineno-78-1></a>check &quot;Test&quot; on `from` {              # &#39;from&#39; as dataset name
</span><span id=__span-78-2><a id=__codelineno-78-2 name=__codelineno-78-2 href=#__codelineno-78-2></a>    assert count(`to`) &gt; 0            # &#39;to&#39; as column name
</span><span id=__span-78-3><a id=__codelineno-78-3 name=__codelineno-78-3 href=#__codelineno-78-3></a>}
</span></code></pre></div> <h2 id=design-decisions>Design Decisions<a class=headerlink href=#design-decisions title="Anchor link to this section for reference">&para;</a></h2> <h3 id=interpreter-only-architecture>Interpreter-Only Architecture<a class=headerlink href=#interpreter-only-architecture title="Anchor link to this section for reference">&para;</a></h3> <p>DQL runs directly via the interpreter. No compilation step. Metric expressions pass to sympy for parsing, enabling full compatibility with DQX's Python runtime.</p> <p>Benefits: - <strong>Faster iteration</strong> — No build step between edit and run - <strong>Better errors</strong> — Messages point to DQL source, not generated code - <strong>Full sympy support</strong> — All math functions (<code>abs</code>, <code>sqrt</code>, <code>log</code>, <code>exp</code>, <code>min</code>, <code>max</code>) work</p> <h3 id=string-based-expressions>String-Based Expressions<a class=headerlink href=#string-based-expressions title="Anchor link to this section for reference">&para;</a></h3> <p>DQL metric expressions are strings that pass directly to <code>sympy.sympify()</code>. This design: - Matches DQX's existing <code>MetricExpressionParser</code> - Enables arbitrary arithmetic without grammar changes - Supports all whitelisted sympy functions</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-79-1><a id=__codelineno-79-1 name=__codelineno-79-1 href=#__codelineno-79-1></a>assert abs(day_over_day(average(price))) &lt; 0.1   # sympy handles this
</span><span id=__span-79-2><a id=__codelineno-79-2 name=__codelineno-79-2 href=#__codelineno-79-2></a>assert sqrt(variance(score)) &lt; 10                 # no special grammar needed
</span></code></pre></div> <h3 id=validation-before-execution>Validation Before Execution<a class=headerlink href=#validation-before-execution title="Anchor link to this section for reference">&para;</a></h3> <p>The interpreter validates before running:</p> <ul> <li>Unknown metric functions</li> <li>Invalid severity levels</li> <li>Duplicate names</li> <li>Type mismatches</li> </ul> <p>Errors surface immediately with source location.</p> <h2 id=implementation-status>Implementation Status<a class=headerlink href=#implementation-status title="Anchor link to this section for reference">&para;</a></h2> <h3 id=implemented>Implemented ✅<a class=headerlink href=#implemented title="Anchor link to this section for reference">&para;</a></h3> <p>The following features from this design are <strong>already implemented</strong> in the DQX codebase:</p> <h4 id=conditions_1>Conditions<a class=headerlink href=#conditions_1 title="Anchor link to this section for reference">&para;</a></h4> <table> <thead> <tr> <th>Condition</th> <th>Description</th> <th>Location</th> </tr> </thead> <tbody> <tr> <td><code>!= N</code></td> <td>Not equal to N</td> <td>✅ <code>is_neq()</code> in <code>api.py</code> AssertionReady</td> </tr> <tr> <td><code>is None</code></td> <td>Value is None</td> <td>✅ <code>is_none()</code> in <code>api.py</code> AssertionReady</td> </tr> <tr> <td><code>is not None</code></td> <td>Value is not None</td> <td>✅ <code>is_not_none()</code> in <code>api.py</code> AssertionReady</td> </tr> </tbody> </table> <h4 id=utility-functions>Utility Functions<a class=headerlink href=#utility-functions title="Anchor link to this section for reference">&para;</a></h4> <table> <thead> <tr> <th>Function</th> <th>Description</th> <th>Location</th> </tr> </thead> <tbody> <tr> <td><code>coalesce(expr, ...)</code></td> <td>Return first non-None value</td> <td>✅ <code>Coalesce</code> class in <code>functions.py</code></td> </tr> </tbody> </table> <h4 id=metric-parameters>Metric Parameters<a class=headerlink href=#metric-parameters title="Anchor link to this section for reference">&para;</a></h4> <table> <thead> <tr> <th>Parameter</th> <th>Description</th> <th>Location</th> </tr> </thead> <tbody> <tr> <td><code>order_by</code> for <code>first()</code></td> <td>Sort before taking first value</td> <td>✅ <code>first()</code> in <code>provider.py</code></td> </tr> </tbody> </table> <h4 id=annotations>Annotations<a class=headerlink href=#annotations title="Anchor link to this section for reference">&para;</a></h4> <table> <thead> <tr> <th>Annotation</th> <th>Description</th> <th>Location</th> </tr> </thead> <tbody> <tr> <td><code>@experimental</code></td> <td>Mark algorithm-proposed assertions</td> <td>✅ <code>experimental</code> param in <code>api.py</code> AssertionDraft.where()</td> </tr> <tr> <td><code>@required</code></td> <td>Prevent removal by algorithms</td> <td>✅ <code>required</code> param in <code>api.py</code> AssertionDraft.where()</td> </tr> <tr> <td><code>@cost(fp, fn)</code></td> <td>False positive/negative costs for RL reward</td> <td>✅ <code>cost={"fp": N, "fn": M}</code> param in <code>api.py</code> AssertionDraft.where()</td> </tr> </tbody> </table> <h4 id=tunable-constants>Tunable Constants<a class=headerlink href=#tunable-constants title="Anchor link to this section for reference">&para;</a></h4> <table> <thead> <tr> <th>Feature</th> <th>Description</th> <th>Location</th> </tr> </thead> <tbody> <tr> <td><code>tunable</code> constants</td> <td>Bounded parameters for RL optimization</td> <td>✅ <code>TunableFloat</code>, <code>TunablePercent</code>, <code>TunableInt</code>, <code>TunableChoice</code> in <code>tunables.py</code></td> </tr> <tr> <td><code>suite.get_tunable_params()</code></td> <td>List tunable params with bounds</td> <td>✅ <code>VerificationSuite.get_tunable_params()</code> in <code>api.py</code></td> </tr> <tr> <td><code>suite.set_param(name, value)</code></td> <td>Modify threshold within bounds</td> <td>✅ <code>VerificationSuite.set_param()</code> in <code>api.py</code></td> </tr> <tr> <td><code>suite.get_param_history(name)</code></td> <td>Get change history for tunable</td> <td>✅ <code>VerificationSuite.get_param_history()</code> in <code>api.py</code></td> </tr> </tbody> </table> <h3 id=not-yet-implemented>Not Yet Implemented ❌<a class=headerlink href=#not-yet-implemented title="Anchor link to this section for reference">&para;</a></h3> <p>The following features are specified in this design but <strong>require implementation</strong>:</p> <h4 id=dql-core-parser-interpreter>DQL Core (Parser &amp; Interpreter)<a class=headerlink href=#dql-core-parser-interpreter title="Anchor link to this section for reference">&para;</a></h4> <table> <thead> <tr> <th>Feature</th> <th>Description</th> <th>Priority</th> </tr> </thead> <tbody> <tr> <td>Lexer/Tokenizer</td> <td>Tokenize DQL source into tokens</td> <td>High</td> </tr> <tr> <td>Parser</td> <td>Parse tokens into AST nodes</td> <td>High</td> </tr> <tr> <td>AST Nodes</td> <td>Suite, Check, Assertion, Profile, etc.</td> <td>High</td> </tr> <tr> <td>Interpreter</td> <td>Execute AST against DQX runtime</td> <td>High</td> </tr> <tr> <td>Sampling</td> <td><code>sample N%</code> / <code>sample N rows</code> with optional <code>seed</code></td> <td>Medium</td> </tr> <tr> <td>CLI (<code>dql run</code>, <code>dql check</code>)</td> <td>Command-line interface</td> <td>Medium</td> </tr> </tbody> </table> <h4 id=rl-agent-integration_1>RL Agent Integration<a class=headerlink href=#rl-agent-integration_1 title="Anchor link to this section for reference">&para;</a></h4> <table> <thead> <tr> <th>Feature</th> <th>Description</th> <th>Priority</th> </tr> </thead> <tbody> <tr> <td><code>Suite.load(path)</code></td> <td>Parse DQL into manipulable Suite object</td> <td>High</td> </tr> <tr> <td><code>suite.save()</code></td> <td>Persist changes back to <code>.dql</code> file</td> <td>Medium</td> </tr> </tbody> </table> <h4 id=history-auditing>History &amp; Auditing<a class=headerlink href=#history-auditing title="Anchor link to this section for reference">&para;</a></h4> <table> <thead> <tr> <th>Feature</th> <th>Description</th> <th>Priority</th> </tr> </thead> <tbody> <tr> <td><code>.dql.history</code> file</td> <td>JSONL change log alongside DQL source</td> <td>Medium</td> </tr> <tr> <td><code>History.log(entry)</code></td> <td>Append action records</td> <td>Medium</td> </tr> <tr> <td><code>dql history</code> command</td> <td>View change history</td> <td>Low</td> </tr> <tr> <td><code>dql rollback --to DATE</code></td> <td>Revert to previous state</td> <td>Low</td> </tr> <tr> <td><code>dql review</code> command</td> <td>Approve/reject pending changes</td> <td>Low</td> </tr> </tbody> </table> <h4 id=human-in-the-loop>Human-in-the-Loop<a class=headerlink href=#human-in-the-loop title="Anchor link to this section for reference">&para;</a></h4> <table> <thead> <tr> <th>Feature</th> <th>Description</th> <th>Priority</th> </tr> </thead> <tbody> <tr> <td><code>@human_review</code> annotation</td> <td>Changes require approval</td> <td>Low</td> </tr> <tr> <td><code>@auto_approve</code> annotation</td> <td>Low-risk changes apply immediately</td> <td>Low</td> </tr> <tr> <td><code>dql label</code> command</td> <td>Label false positives for reward tuning</td> <td>Low</td> </tr> <tr> <td>Shadow mode</td> <td>Test proposed changes without production impact</td> <td>Low</td> </tr> <tr> <td><code>dql promote</code> command</td> <td>Promote experimental to production</td> <td>Low</td> </tr> </tbody> </table> <h2 id=future-extensions>Future Extensions<a class=headerlink href=#future-extensions title="Anchor link to this section for reference">&para;</a></h2> <h3 id=planned>Planned<a class=headerlink href=#planned title="Anchor link to this section for reference">&para;</a></h3> <table> <thead> <tr> <th>Feature</th> <th>Description</th> <th>Example</th> </tr> </thead> <tbody> <tr> <td><strong>Row-level checks</strong></td> <td>Assert condition on every row</td> <td><code>assert each row: price &gt; 0</code></td> </tr> <tr> <td><strong>Named shortcuts</strong></td> <td>Concise syntax for common patterns</td> <td><code>assert unique(customer_id)</code></td> </tr> <tr> <td><strong>Freshness checks</strong></td> <td>Data recency validation</td> <td><code>assert freshness(updated_at) &lt; 1 hour</code></td> </tr> <tr> <td><strong>Timeliness checks</strong></td> <td>SLA compliance validation</td> <td><code>assert timeliness(partition_date) by 06:00 UTC</code></td> </tr> <tr> <td><strong>Schema validation</strong></td> <td>Assert table structure</td> <td><code>assert column email exists</code></td> </tr> </tbody> </table> <h3 id=considered>Considered<a class=headerlink href=#considered title="Anchor link to this section for reference">&para;</a></h3> <table> <thead> <tr> <th>Feature</th> <th>Description</th> <th>Example</th> </tr> </thead> <tbody> <tr> <td><strong>Statistical bounds</strong></td> <td>Anomaly detection via z-score</td> <td><code>assert average(price) within 3 stddev</code></td> </tr> <tr> <td><strong>Referential integrity</strong></td> <td>Foreign key validation</td> <td><code>assert values(order_id) in values(id, dataset=orders)</code></td> </tr> <tr> <td><strong>Distribution checks</strong></td> <td>Categorical distribution matching</td> <td><code>assert distribution(status) matches {...}</code></td> </tr> <tr> <td><strong>Percentile metrics</strong></td> <td>P50, P95, P99 calculations</td> <td><code>assert percentile(latency, 0.99) &lt; 500</code></td> </tr> <tr> <td><strong>LSP server</strong></td> <td>IDE autocomplete and diagnostics</td> <td>—</td> </tr> </tbody> </table> <h3 id=named-shortcuts-planned>Named Shortcuts (Planned)<a class=headerlink href=#named-shortcuts-planned title="Anchor link to this section for reference">&para;</a></h3> <p>Syntactic sugar for common data quality patterns:</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-80-1><a id=__codelineno-80-1 name=__codelineno-80-1 href=#__codelineno-80-1></a>assert unique(customer_id)              # duplicate_count([customer_id]) == 0
</span><span id=__span-80-2><a id=__codelineno-80-2 name=__codelineno-80-2 href=#__codelineno-80-2></a>assert not_null(email)                  # null_count(email) == 0
</span><span id=__span-80-3><a id=__codelineno-80-3 name=__codelineno-80-3 href=#__codelineno-80-3></a>assert not_null(email, phone, address)  # Multiple columns
</span><span id=__span-80-4><a id=__codelineno-80-4 name=__codelineno-80-4 href=#__codelineno-80-4></a>assert positive(price)                  # minimum(price) &gt; 0
</span><span id=__span-80-5><a id=__codelineno-80-5 name=__codelineno-80-5 href=#__codelineno-80-5></a>assert non_negative(quantity)           # minimum(quantity) &gt;= 0
</span><span id=__span-80-6><a id=__codelineno-80-6 name=__codelineno-80-6 href=#__codelineno-80-6></a>assert in_set(status, [&quot;A&quot;, &quot;B&quot;, &quot;C&quot;])  # All values in allowed set
</span><span id=__span-80-7><a id=__codelineno-80-7 name=__codelineno-80-7 href=#__codelineno-80-7></a>assert not_empty()                      # num_rows() &gt; 0
</span></code></pre></div> <h3 id=freshness-timeliness-planned>Freshness &amp; Timeliness (Planned)<a class=headerlink href=#freshness-timeliness-planned title="Anchor link to this section for reference">&para;</a></h3> <div class="language-text highlight"><pre><span></span><code><span id=__span-81-1><a id=__codelineno-81-1 name=__codelineno-81-1 href=#__codelineno-81-1></a># Freshness: How old is the newest data?
</span><span id=__span-81-2><a id=__codelineno-81-2 name=__codelineno-81-2 href=#__codelineno-81-2></a>assert freshness(updated_at) &lt; 2 hours
</span><span id=__span-81-3><a id=__codelineno-81-3 name=__codelineno-81-3 href=#__codelineno-81-3></a>    name &quot;Data refreshed recently&quot;
</span><span id=__span-81-4><a id=__codelineno-81-4 name=__codelineno-81-4 href=#__codelineno-81-4></a>
</span><span id=__span-81-5><a id=__codelineno-81-5 name=__codelineno-81-5 href=#__codelineno-81-5></a># Timeliness: Did data arrive on schedule?
</span><span id=__span-81-6><a id=__codelineno-81-6 name=__codelineno-81-6 href=#__codelineno-81-6></a>assert timeliness(partition_date) by 06:00 UTC
</span><span id=__span-81-7><a id=__codelineno-81-7 name=__codelineno-81-7 href=#__codelineno-81-7></a>    name &quot;Daily load completed by SLA&quot;
</span><span id=__span-81-8><a id=__codelineno-81-8 name=__codelineno-81-8 href=#__codelineno-81-8></a>
</span><span id=__span-81-9><a id=__codelineno-81-9 name=__codelineno-81-9 href=#__codelineno-81-9></a># Data lag: Time since partition date
</span><span id=__span-81-10><a id=__codelineno-81-10 name=__codelineno-81-10 href=#__codelineno-81-10></a>assert data_lag(partition_date) &lt; 18 hours
</span><span id=__span-81-11><a id=__codelineno-81-11 name=__codelineno-81-11 href=#__codelineno-81-11></a>    name &quot;Data available within 18 hours&quot;
</span></code></pre></div> <h3 id=row-level-checks-planned>Row-Level Checks (Planned)<a class=headerlink href=#row-level-checks-planned title="Anchor link to this section for reference">&para;</a></h3> <div class="language-text highlight"><pre><span></span><code><span id=__span-82-1><a id=__codelineno-82-1 name=__codelineno-82-1 href=#__codelineno-82-1></a># All rows must satisfy condition
</span><span id=__span-82-2><a id=__codelineno-82-2 name=__codelineno-82-2 href=#__codelineno-82-2></a>assert each row: price &gt; 0
</span><span id=__span-82-3><a id=__codelineno-82-3 name=__codelineno-82-3 href=#__codelineno-82-3></a>    name &quot;All prices positive&quot;
</span><span id=__span-82-4><a id=__codelineno-82-4 name=__codelineno-82-4 href=#__codelineno-82-4></a>
</span><span id=__span-82-5><a id=__codelineno-82-5 name=__codelineno-82-5 href=#__codelineno-82-5></a>assert each row: status in [&quot;pending&quot;, &quot;shipped&quot;, &quot;delivered&quot;]
</span><span id=__span-82-6><a id=__codelineno-82-6 name=__codelineno-82-6 href=#__codelineno-82-6></a>    name &quot;Valid status values&quot;
</span><span id=__span-82-7><a id=__codelineno-82-7 name=__codelineno-82-7 href=#__codelineno-82-7></a>
</span><span id=__span-82-8><a id=__codelineno-82-8 name=__codelineno-82-8 href=#__codelineno-82-8></a># With percentage tolerance (inspired by Great Expectations &quot;mostly&quot; parameter)
</span><span id=__span-82-9><a id=__codelineno-82-9 name=__codelineno-82-9 href=#__codelineno-82-9></a>assert 95% of rows: email matches &quot;^[^@]+@[^@]+$&quot;
</span><span id=__span-82-10><a id=__codelineno-82-10 name=__codelineno-82-10 href=#__codelineno-82-10></a>    name &quot;Most emails valid format&quot;
</span></code></pre></div> <aside class=md-source-file> <span class=md-source-file__fact> <span class=md-icon title="Last update"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago" title="January 14, 2026 17:56:40 UTC"><span class=timeago datetime=2026-01-14T17:56:40+00:00 locale=en></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date" title="January 14, 2026 17:56:40 UTC">2026-01-14</span> </span> <span class=md-source-file__fact> <span class=md-icon title=Created> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago" title="January 14, 2026 17:56:40 UTC"><span class=timeago datetime=2026-01-14T17:56:40+00:00 locale=en></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date" title="January 14, 2026 17:56:40 UTC">2026-01-14</span> </span> </aside> </article> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2024 Nam Pham </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/nampham2/dqx target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> <a href=https://pypi.org/project/dqx/ target=_blank rel=noopener title=pypi.org class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.8 200.5c-7.7-30.9-22.3-54.2-53.4-54.2h-40.1v47.4c0 36.8-31.2 67.8-66.8 67.8H172.7c-29.2 0-53.4 25-53.4 54.3v101.8c0 29 25.2 46 53.4 54.3 33.8 9.9 66.3 11.7 106.8 0 26.9-7.8 53.4-23.5 53.4-54.3v-40.7H226.2v-13.6h160.2c31.1 0 42.6-21.7 53.4-54.2 11.2-33.5 10.7-65.7 0-108.6M286.2 444.7a20.4 20.4 0 1 1 0-40.7 20.4 20.4 0 1 1 0 40.7M167.8 248.1h106.8c29.7 0 53.4-24.5 53.4-54.3V91.9c0-29-24.4-50.7-53.4-55.6-35.8-5.9-74.7-5.6-106.8.1-45.2 8-53.4 24.7-53.4 55.6v40.7h106.9v13.6h-147c-31.1 0-58.3 18.7-66.8 54.2-9.8 40.7-10.2 66.1 0 108.6 7.6 31.6 25.7 54.2 56.8 54.2H101v-48.8c0-35.3 30.5-66.4 66.8-66.4m-6.6-183.4a20.4 20.4 0 1 1 0 40.8 20.4 20.4 0 1 1 0-40.8"/></svg> </a> <a href=https://dqx.readthedocs.io target=_blank rel=noopener title=dqx.readthedocs.io class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M384 512H96c-53 0-96-43-96-96V96C0 43 43 0 96 0h304c26.5 0 48 21.5 48 48v288c0 20.9-13.4 38.7-32 45.3V448c17.7 0 32 14.3 32 32s-14.3 32-32 32zM96 384c-17.7 0-32 14.3-32 32s14.3 32 32 32h256v-64zm32-232c0 13.3 10.7 24 24 24h176c13.3 0 24-10.7 24-24s-10.7-24-24-24H152c-13.3 0-24 10.7-24 24m24 72c-13.3 0-24 10.7-24 24s10.7 24 24 24h176c13.3 0 24-10.7 24-24s-10.7-24-24-24z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <div class=md-consent data-md-component=consent id=__consent hidden> <div class=md-consent__overlay></div> <aside class=md-consent__inner> <form class="md-consent__form md-grid md-typeset" name=consent> <h4>Cookie consent</h4> <p>We use cookies to recognize your repeated visits and preferences, as well as to measure the effectiveness of our documentation and whether users find what they're searching for. With your consent, you're helping us to make our documentation better.</p> <input class=md-toggle type=checkbox id=__settings> <div class=md-consent__settings> <ul class=task-list> <li class=task-list-item> <label class=task-list-control> <input type=checkbox name=github checked> <span class=task-list-indicator></span> GitHub </label> </li> </ul> </div> <div class=md-consent__controls> <button class="md-button md-button--primary">Accept</button> <label class=md-button for=__settings>Manage settings</label> </div> </form> </aside> </div> <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout((function(){document.querySelector("[data-md-component=consent]").hidden=!1}),250);var form=document.forms.consent;for(var action of["submit","reset"])form.addEventListener(action,(function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map((function(e){return[e,!0]})))),location.hash="",location.reload()}))</script> <script id=__config type=application/json>{"annotate": null, "base": "../..", "features": ["navigation.instant", "navigation.instant.prefetch", "navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.expand", "navigation.path", "navigation.prune", "navigation.indexes", "navigation.top", "navigation.footer", "toc.follow", "toc.integrate", "search.suggest", "search.highlight", "search.share", "content.code.copy", "content.code.annotate", "content.code.select", "content.tabs.link", "content.tooltips", "content.footnote.tooltips", "content.action.edit", "content.action.view", "announce.dismiss"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script> <script src=../../assets/javascripts/bundle.79ae519e.min.js></script> <script src=../../js/timeago.min.js></script> <script src=../../js/timeago_mkdocs_material.js></script> <script src=../../javascripts/mathjax.js></script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script> </body> </html>